<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: knn/BallTree.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: knn/BallTree.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { euclidean } from "../metrics/index";
import { Heap } from "../datastructure/index";
/**
 * @memberof module:knn
 */
export class BallTree {
    /**
     * Generates a BallTree with given {@link elements}.
     * @param {Array} elements - Elements which should be added to the BallTree
     * @param {function} metric metric to use: (a, b) => distance
     * @see {@link https://en.wikipedia.org/wiki/Ball_tree}
     * @see {@link https://github.com/invisal/noobjs/blob/master/src/tree/BallTree.js}
     */
    constructor(elements = null, metric = euclidean) {
        this._Node = class {
            constructor(pivot, child1=null, child2=null, radius=null) {
                this.pivot = pivot;
                this.child1 = child1;
                this.child2 = child2;
                this.radius = radius;
            }
        }
        this._Leaf = class {
            constructor(points) {
                this.points = points;
            }
        }
        this._metric = metric;
        if (elements) {
            this.add(elements);
        }
        return this;
    }

    add(elements) {
        elements = elements.map((element, index) => {
            return {index: index, element: element}
        })
        this._root = this._construct(elements)
        return this;
    }

    _construct(elements) {
        if (elements.length === 1) {
            return new this._Leaf(elements);
        } else {
            let c = this._greatest_spread(elements);
            let sorted_elements = elements.sort((a, b) => a.element[c] - b.element[c])
            let n = sorted_elements.length;
            let p_index = Math.floor(n / 2);
            let p = elements[p_index];
            let L = sorted_elements.slice(0, p_index);
            let R = sorted_elements.slice(p_index, n);
            let radius = Math.max(...elements.map(d => this._metric(p.element, d.element)));
            let B
            if (L.length > 0 &amp;&amp; R.length > 0) {         
                B = new this._Node(p, this._construct(L), this._construct(R), radius);
            } else {
                B = new this._Leaf(elements)
            }
            //if (this._root === null) this._root = B;
            return B;
        } /*else {
            return null;
        }*/
    }

    _greatest_spread(B) {
        let d = B[0].element.length;
        let start = new Array(d);

        for (let i = 0; i &lt; d; ++i) {
            start[i] = [Infinity, -Infinity];
        }

        let spread = B.reduce((acc, current) => {
            for (let i = 0; i &lt; d; ++i) {
                acc[i][0] = Math.min(acc[i][0], current.element[i]);
                acc[i][1] = Math.max(acc[i][1], current.element[i]);
            }
            return acc;
        }, start)
        spread = spread.map(d => d[1] - d[0]);
        
        let c = 0;
        for (let i = 0; i &lt; d; ++i) {
            c = spread[i] > spread[c] ? i : c;
        }
        return c
    }

    search(t, k=5) {
        return this._search(t, k, new Heap(null, d => this._metric(d.element, t), "max"), this._root);
    }

    _search(t, k, Q, B) {
        // B is Node
        if (Q.length >= k &amp;&amp; B.pivot &amp;&amp; B.radius &amp;&amp; this._metric(t, B.pivot.element) - B.radius >= Q.first.value) {
            return Q;
        } 
        if (B.child1) this._search(t, k, Q, B.child1);
        if (B.child2) this._search(t, k, Q, B.child2);
        
        // B is leaf
        if (B.points) {
            for (let i = 0, n = B.points.length; i &lt; n; ++i) {
                let p = B.points[i];
                if (k > Q.length) {
                    Q.push(p);
                } else {
                    Q.push(p);
                    Q.pop();
                }
            }
        }
        return Q;
    }


}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-knn.html">knn</a></li><li><a href="module-linear_algebra.html">linear_algebra</a></li><li><a href="module-matrix.html">matrix</a></li><li><a href="module-metrics.html">metrics</a></li><li><a href="module-numerical.html">numerical</a></li></ul><h3>Classes</h3><ul><li><a href="Matrix.html">Matrix</a></li><li><a href="module-knn.exports.BallTree.html">BallTree</a></li><li><a href="module-knn.exports.HNSW.html">HNSW</a></li><li><a href="module-knn.exports.NNDescent.html">NNDescent</a></li><li><a href="OAP.html">OAP</a></li><li><a href="Randomizer_Randomizer.html">Randomizer</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Aug 29 2019 19:43:46 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
