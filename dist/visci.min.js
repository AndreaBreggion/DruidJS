// https://null.org v0.0.1 Copyright 2019 abc
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).visci=t.visci||{})}(this,function(t){"use strict";function e(t=0,e=0){if(!(t<0||e<0)){if(0===t&&0===e)return 0;if(0===t||0===e){let r=new Array(Math.max(t,e));for(let t=0;t<e;++t)r[t]=0;return r}{let r=new Array(t);for(let s=0;s<t;++s){r[s]=new Array(e);for(let t=0;t<e;++t)r[s][t]=0}return r}}}function r(t,e){if(t.length!=e.length)return;let r=t.length,s=0;for(let i=0;i<r;++i)s+=(t[i]-e[i])**2;return Math.sqrt(s)}const s=r;function i(t,r=s){let i=r;if(void 0===i)return;let n=t.length,l=e(n,n);for(let e=0;e<n;++e)for(let r=e+1;r<n;++r)l[e][r]=l[r][e]=i(t[e],t[r]);return l}const l=r;class o{constructor(t=null,e=(t=>t),r="min"){if(this.root=null,this.accessor=e,this._comparator="min"==r?(t,e)=>t<=e:"max"==r?(t,e)=>t>=e:r,t&&t.length>0){let e=this;t.forEach(t=>e.push(t))}}push(t){const e=this.accessor(t),r=new h(t,e);if(!this.root||this._comparator(e,this.root.value))r.next=this.root,this.root=r;else{let t=this.root;for(;t.next&&!this._comparator(e,t.next.value);)t=t.next;r.next=t.next,t.next=r}return this}pop(){if(!this.root)return null;const t=this.root;return this.root=this.root.next,t}get first(){return this.root}*iterate(){let t=this.root;for(;t;)yield t.element,t=t.next}toArray(){let t=[],e=this.root;for(;e;)t.push(e.element),e=e.next;return t}get length(){let t=0,e=this.root;for(;e;)t+=1,e=e.next;return t}get empty(){return null===this.root}}class h{constructor(t,e){this.element=t,this.value=e,this.next=null}}const f=r;t.k_nearest_neighbors=function(t,e,r=null,s=l){let n=t.length,o=r||i(t,s);for(let t=0;t<n;++t)o[t]=o[t].map((e,r)=>({i:t,j:r,distance:o[t][r]})).sort((t,e)=>t.distance-e.distance).slice(1,e+1);return o},t.distance_matrix=i,t.zeros=e,t.linspace=function(t,e,r){if(void 0===r&&(r=Math.max(Math.round(e-t)+1,1)),r<2)return 1===n?[a]:[];let s=new Array(r);for(let i=r-=1;i>=0;--i)s[i]=(i*e+(r-i)*t)/r;return s},t.HNSW=class{constructor(t=f,e=!0,r=5,s=200,i=null){this._metric=t,this._select=e?this._select_heuristic:this._select_simple,this._m=r,this._ef=s,this._m0=i||2*r,this._graph=[],this._ep=null,this._L=null,this._mL=1/Math.log2(r),this.search=this.search}addOne(t){this.add([t])}add(...t){const e=this._m,r=this._ef,s=this._m0,i=this._mL;let n=this._graph;for(const l of t){let t=this._ep,o=[],h=this._L,a=Math.floor(-Math.log(Math.random()*i))+1,f=Math.min(h,a);if(h){for(let e=n.length-1;e>f;--e)t=o=this._search_layer(l,t,1,e);for(let i=f;i>=0;--i){let h=n[i];h.points.push(l),o=this._search_layer(l,t,r,i);let a=this._select(l,o,e,i);a.forEach(t=>{t!==l&&(h.edges.push({idx1:t,idx2:l}),h.edges.push({idx1:l,idx2:t}))});let f=0===i?s:e;for(let t of a){let e=h.edges.filter(e=>e.idx1===t).map(t=>t.idx2);if(e.length>f){let r=this._select(t,e,f,i);h.edges=h.edges.filter(e=>e.idx1!==t),r.forEach(e=>{t!==e&&h.edges.push({idx1:t,idx2:e})})}}t=o}}if(n.length<a||a>h){for(let t=a,e=n.length;t>=e;--t){let e={l_c:t,points:[l],edges:[]};n.push(e),t===a&&(this._ep=e.points,this._L=a)}n=n.sort((t,e)=>t.l_c-e.l_c)}}return this}_select_heuristic(t,e,r,s,i=!0,n=!0){if(s>this._graph.length-1)return e;const l=this._metric,h=this._graph[s];let a=[],f=new Set;if(e.forEach(t=>f.add(t)),i)for(let t of e)for(let{idx2:e}of h.edges.filter(e=>e.idx1===t))f.add(e);let c=new o(Array.from(f),e=>l(e,t),"min"),u=new o(null,e=>l(e,t),"min");for(;c.first&&a.length<r;){let e=c.pop(),r=Math.floor(Math.random()*a.length);0===a.length||e.value<l(a[r],t)?a.push(e.element):u.push(e.element)}if(n)for(;u.first&&a.length<r;)a.push(u.pop().element);return a}_select_simple(t,e,r){const s=this._metric;return e.sort((e,r)=>s(e,t)-s(r,t)).slice(0,r)}_search_layer(t,e,r,s){const i=this._metric,n=this._graph[s];let l=new Set;e.forEach(t=>l.add(t));let h=new o(e,e=>i(e,t),"min"),a=new o(e,e=>i(e,t),"max");for(;h.length>0;){let e=h.pop().element,s=a.first;if(e.value>s.value)break;for(let{idx2:o}of n.edges.filter(t=>t.idx1===e))l.has(o)||(l.add(o),s=a.first.element,(i(o,t)<i(s,t)||a.length<r)&&(h.push(o),a.push(o),a.length>r&&a.pop()))}return a.toArray().reverse()}search(t,e,r=null){r=r||this._ef;let s=this._ep;for(let e=this._L;e>0;--e)s=this._search_layer(t,s,1,e);return(s=this._search_layer(t,s,r,0)).slice(0,e)}},t.Heap=o,t.euclidean=r,t.cosine=function(t,e){if(t.length!=e.length)return;let r=t.length,s=0,i=0,n=0;for(let l=0;l<r;++l)s+=t[l]*e[l],i+=t[l]*t[l],n+=e[l]*e[l];return s/(Math.sqrt(i)*Math.sqrt(n))},Object.defineProperty(t,"__esModule",{value:!0})});
