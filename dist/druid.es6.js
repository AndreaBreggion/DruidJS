// https://renecutura.eu v0.3.11 Copyright 2021 Rene Cutura
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@babel/runtime/helpers/slicedToArray"),require("@babel/runtime/helpers/classCallCheck"),require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/toConsumableArray"),require("@babel/runtime/regenerator"),require("@babel/runtime/helpers/assertThisInitialized"),require("@babel/runtime/helpers/inherits"),require("@babel/runtime/helpers/possibleConstructorReturn"),require("@babel/runtime/helpers/getPrototypeOf"),require("@babel/runtime/helpers/construct"),require("@babel/runtime/helpers/asyncToGenerator"),require("@babel/runtime/helpers/set"),require("@babel/runtime/helpers/awaitAsyncGenerator"),require("@babel/runtime/helpers/wrapAsyncGenerator")):"function"==typeof define&&define.amd?define(["exports","@babel/runtime/helpers/slicedToArray","@babel/runtime/helpers/classCallCheck","@babel/runtime/helpers/createClass","@babel/runtime/helpers/toConsumableArray","@babel/runtime/regenerator","@babel/runtime/helpers/assertThisInitialized","@babel/runtime/helpers/inherits","@babel/runtime/helpers/possibleConstructorReturn","@babel/runtime/helpers/getPrototypeOf","@babel/runtime/helpers/construct","@babel/runtime/helpers/asyncToGenerator","@babel/runtime/helpers/set","@babel/runtime/helpers/awaitAsyncGenerator","@babel/runtime/helpers/wrapAsyncGenerator"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).druid=t.druid||{},t._slicedToArray,t._classCallCheck,t._createClass,t._toConsumableArray,t._regeneratorRuntime,t._assertThisInitialized,t._inherits,t._possibleConstructorReturn,t._getPrototypeOf,t._construct,t._asyncToGenerator,t._set,null,t._wrapAsyncGenerator)}(this,(function(t,e,r,n,i,a,o,s,u,l,f,h,c,_,v){"use strict";function d(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var y=d(e),p=d(r),m=d(n),g=d(i),w=d(a),b=d(o),k=d(s),x=d(u),A=d(l),M=d(f),R=d(h),j=d(c),z=d(v);function S(t,e){return Math.sqrt(B(t,e))}function N(t){for(var e=t.length,r=0,n=0,i=0;i<e;++i){var a=t[i],o=r+a;Math.abs(r)>=Math.abs(a)?n+=r-o+a:n+=a-o+r,r=o}return r+n}function B(t,e){if(t.length==e.length){for(var r=t.length,n=new Array(r),i=0;i<r;++i){var a=t[i],o=e[i];n[i]=(a-o)*(a-o)}return N(n)}}function O(t,e){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,i=t.shape[0],a=null!=r?r:C(t,n),o=new Array(i),s=function(t){o[t]=Array.from(a.row(t)).map((function(e,r){return{i:t,j:r,distance:e}})).sort((function(t,e){return t.distance-e.distance})).slice(1,e+1)},u=0;u<i;++u)s(u);return o}function T(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return I(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return I(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function I(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var E=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(p.default(this,t),this._rows=e,this._cols=r,this._data=null,e&&r){if(!n)return this._data=new Float64Array(e*r),this;if("function"==typeof n){this._data=new Float64Array(e*r);for(var i=0;i<e;++i)for(var a=0;a<r;++a)this._data[i*r+a]=n(i,a);return this}if("string"==typeof n){if("zeros"===n)return new t(e,r,0);if("identity"===n||"I"===n){this._data=new Float64Array(e*r);for(var o=0;o<e;++o)this._data[o*r+o]=1;return this}if("center"===n&&e==r){this._data=new Float64Array(e*r),n=function(t,r){return(t===r?1:0)-1/e};for(var s=0;s<e;++s)for(var u=0;u<r;++u)this._data[s*r+u]=n(s,u);return this}}if("number"==typeof n){this._data=new Float64Array(e*r);for(var l=0;l<e;++l)for(var f=0;f<r;++f)this._data[l*r+f]=n;return this}}return this}return m.default(t,[{key:"row",value:function(t){var e=this._data,r=this._cols;return e.subarray(t*r,(t+1)*r)}},{key:"iterate_rows",value:w.default.mark((function t(){var e,r,n,i;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=this._cols,r=this._rows,n=this._data,i=0;case 4:if(!(i<r)){t.next=10;break}return t.next=7,n.subarray(i*e,(i+1)*e);case 7:++i,t.next=4;break;case 10:case"end":return t.stop()}}),t,this)}))},{key:Symbol.iterator,value:w.default.mark((function t(){var e,r,n;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=T(this.iterate_rows()),t.prev=1,e.s();case 3:if((r=e.n()).done){t.next=9;break}return n=r.value,t.next=7,n;case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t0=t.catch(1),e.e(t.t0);case 14:return t.prev=14,e.f(),t.finish(14);case 17:case"end":return t.stop()}}),t,this,[[1,11,14,17]])}))},{key:"set_row",value:function(e,r){var n=this._cols;if(Array.isArray(r)&&r.length===n)for(var i=e*n,a=0;a<n;++a)this._data[i+a]=r[a];else if(r instanceof t&&r.shape[1]===n&&1===r.shape[0])for(var o=e*n,s=0;s<n;++s)this._data[o+s]=r._data[s];return this}},{key:"col",value:function(t){for(var e=new Float64Array(this._rows),r=0;r<this._rows;++r)e[r]=this._data[r*this._cols+t];return e}},{key:"entry",value:function(t,e){return this._data[t*this._cols+e]}},{key:"set_entry",value:function(t,e,r){return this._data[t*this._cols+e]=r,this}},{key:"transpose",value:function(){var e=this;return new t(this._cols,this._rows,(function(t,r){return e.entry(r,t)}))}},{key:"T",get:function(){return this.transpose()}},{key:"inverse",value:function(){for(var e=this,r=this._rows,n=this._cols,i=new t(r,2*n,(function(t,r){return r>=n?t===r-n?1:0:e.entry(t,r)})),a=0,o=0;a<r&&o<n;){for(var s=0,u=-1/0,l=a;l<r;++l){var f=Math.abs(i.entry(l,o));u<f&&(s=l,u=f)}if(0==i.entry(s,o))o++;else{for(var h=0;h<2*n;++h){var c=i.entry(a,h),_=i.entry(s,h);i.set_entry(a,h,c),i.set_entry(s,h,_)}for(var v=a+1;v<r;++v){var d=i.entry(v,o)/i.entry(a,o);i.set_entry(v,o,0);for(var y=o+1;y<2*n;++y)i.set_entry(v,y,i.entry(v,y)-i.entry(a,y)*d)}a++,o++}}for(var p=0;p<r;++p)for(var m=i.entry(p,p),g=p;g<2*n;++g)i.set_entry(p,g,i.entry(p,g)/m);for(var w=r-1;w>=0;--w)for(var b=i.entry(w,w),k=0;k<w;k++)for(var x=i.entry(k,w)/b,A=k;A<2*n;++A){var M=i.entry(k,A);M-=i.entry(w,A)*x,i.set_entry(k,A,M)}return new t(r,n,(function(t,e){return i.entry(t,e+n)}))}},{key:"dot",value:function(e){var r=this;if(e instanceof t){var n=this;if(n.shape[1]!==e.shape[0])throw"A.dot(B): A is a ".concat(n.shape.join(" x "),"-Matrix, B is a ").concat(e.shape.join(" x "),"-Matrix: \n                A has ").concat(n.shape[1]," cols and B ").concat(e.shape[0]," rows. \n                Must be equal!");var i=n.shape[1];return new t(n.shape[0],e.shape[1],(function(t,r){for(var a=n.row(t),o=e.col(r),s=0,u=0;u<i;++u)s+=a[u]*o[u];return s}))}if(Array.isArray(e)||e instanceof Float64Array){var a=this._rows;if(e.length!==a)throw"A.dot(B): A has ".concat(a," cols and B has ").concat(e.length," rows. Must be equal!");for(var o=new Array(a),s=function(t){o[t]=N(r.row(t).map((function(r){return r*e[t]})))},u=0;u<a;++u)s(u);return o}throw"B must be Matrix or Array"}},{key:"outer",value:function(e){var r=this,n=r._data.length;if(n==e._data.length){var i=new t;return i.shape=[n,n,function(t,n){return t<=n?r._data[t]*e._data[n]:i.entry(n,t)}],i}}},{key:"concat",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"horizontal",n=this,i=y.default(n.shape,2),a=i[0],o=i[1],s=y.default(e.shape,2),u=s[0],l=s[1];if("horizontal"==r){if(a!=u)throw'A.concat(B, "horizontal"): A and B need same number of rows, A has '.concat(a," rows, B has ").concat(u," rows.");var f=new t(a,o+l,"zeros");return f.set_block(0,0,n),f.set_block(0,o,e),f}if("vertical"==r){if(o!=l)throw'A.concat(B, "vertical"): A and B need same number of columns, A has '.concat(o," columns, B has ").concat(l," columns.");var h=new t(a+u,o,"zeros");return h.set_block(0,0,n),h.set_block(a,0,e),h}if("diag"==r){var c=new t(a+u,o+l,"zeros");return c.set_block(0,0,n),c.set_block(a,o,e),c}throw'type must be "horizontal" or "vertical", but type is '.concat(r,"!")}},{key:"set_block",value:function(t,e,r){for(var n=y.default(r.shape,2),i=n[0],a=n[1],o=0;o<i;++o)if(!(o>this._rows))for(var s=0;s<a;++s)s>this._cols||this.set_entry(o+t,s+e,r.entry(o,s));return this}},{key:"get_block",value:function(e,r){var n,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=y.default(this.shape,2),u=s[0],l=s[1];if(o=null!==(i=o)&&void 0!==i?i:l,(a=null!==(n=a)&&void 0!==n?n:u)<=e||o<=r)throw"\n                end_row must be greater than start_row, and \n                end_col must be greater than start_col, but\n                end_row = ".concat(a,", start_row = ").concat(e,", end_col = ").concat(o,", and start_col = ").concat(r,"!");for(var f=new t(a-e,o-r,"zeros"),h=e,c=0;h<a;++h,++c)for(var _=r,v=0;_<o;++_,++v)f.set_entry(c,v,this.entry(h,_));return f}},{key:"gather",value:function(e,r){for(var n=e.length,i=new t(n,r.length),a=0;a<n;++a)for(var o=e[a],s=0;s<n;++s){var u=r[s];i.set_entry(a,s,this.entry(o,u))}return i}},{key:"_apply_array",value:function(t,e){for(var r=this._data,n=y.default(this.shape,2),i=n[0],a=n[1],o=0;o<i;++o)for(var s=o*a,u=0;u<a;++u){var l=s+u;r[l]=t(r[l],e(o,u))}return this}},{key:"_apply_rowwise_array",value:function(t,e){return this._apply_array(e,(function(e,r){return t[r]}))}},{key:"_apply_colwise_array",value:function(t,e){for(var r=this._data,n=y.default(this.shape,2),i=n[0],a=n[1],o=0;o<i;++o)for(var s=o*a,u=0;u<a;++u){var l=s+u;r[l]=e(r[l],t[o])}return this}},{key:"_apply",value:function(e,r){var n=this._data;if(e instanceof t){var i=y.default(e.shape,2),a=i[0],o=i[1],s=y.default(this.shape,2),u=s[0],l=s[1];if(1===a){if(l!==o)throw"cols !== value_cols";for(var f=0;f<u;++f)for(var h=0;h<l;++h)n[f*l+h]=r(n[f*l+h],e.entry(0,h))}else if(1===o){if(u!==a)throw"rows !== value_rows";for(var c=0;c<u;++c)for(var _=0;_<l;++_)n[c*l+_]=r(n[c*l+_],e.entry(c,0))}else{if(u!=a||l!=o)throw"error";for(var v=0;v<u;++v)for(var d=0;d<l;++d)n[v*l+d]=r(n[v*l+d],e.entry(v,d))}}else if(Array.isArray(e)){var p=this._rows,m=this._cols;if(e.length===p)for(var g=0;g<p;++g)for(var w=0;w<m;++w)n[g*m+w]=r(n[g*m+w],e[g]);else{if(e.length!==m)throw"error";for(var b=0;b<p;++b)for(var k=0;k<m;++k)n[b*m+k]=r(n[b*m+k],e[k])}}else for(var x=0,A=this._rows*this._cols;x<A;++x)n[x]=r(n[x],e);return this}},{key:"clone",value:function(){var e=new t;return e._rows=this._rows,e._cols=this._cols,e._data=this._data.slice(0),e}},{key:"mult",value:function(t){return this.clone()._apply(t,(function(t,e){return t*e}))}},{key:"divide",value:function(t){return this.clone()._apply(t,(function(t,e){return t/e}))}},{key:"add",value:function(t){return this.clone()._apply(t,(function(t,e){return t+e}))}},{key:"sub",value:function(t){return this.clone()._apply(t,(function(t,e){return t-e}))}},{key:"shape",get:function(){return[this._rows,this._cols]}},{key:"shape",set:function(t){var e=y.default(t,3),r=e[0],n=e[1],i=e[2],a=void 0===i?function(){return 0}:i;this._rows=r,this._cols=n,this._data=new Float64Array(r*n);for(var o=0;o<r;++o)for(var s=0;s<n;++s)this._data[o*n+s]=a(o,s);return this}},{key:"to2dArray",get:function(){return g.default(this.iterate_rows())}},{key:"diag",get:function(){for(var t=this._rows,e=this._cols,r=Math.min(t,e),n=new Float64Array(r),i=0;i<r;++i)n[i]=this.entry(i,i);return n}},{key:"mean",get:function(){return this.sum/(this._rows*this._cols)}},{key:"sum",get:function(){return N(this._data)}},{key:"meanRows",get:function(){for(var t=this._data,e=this._rows,r=this._cols,n=[],i=0;i<e;++i){n[i]=0;for(var a=0;a<r;++a)n[i]+=t[i*r+a];n[i]/=r}return n}},{key:"meanCols",get:function(){for(var t=this._data,e=this._rows,r=this._cols,n=[],i=0;i<r;++i){n[i]=0;for(var a=0;a<e;++a)n[i]+=t[a*r+i];n[i]/=e}return n}}],[{key:"from",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"row";if(e instanceof t)return e.clone();if(!(Array.isArray(e)||e instanceof Float64Array)){if("number"==typeof e)return new t(1,1,e);throw"error"}var n=e.length;if(0===n)throw"Array is empty";if(!(Array.isArray(e[0])||e[0]instanceof Float64Array)){if("row"===r)return new t(1,n,(function(t,r){return e[r]}));if("col"===r)return new t(n,1,(function(t){return e[t]}));if("diag"===r)return new t(n,n,(function(t,r){return t==r?e[t]:0}));throw"1d array has NaN entries"}if(Array.isArray(e[0])||e[0]instanceof Float64Array){for(var i=e[0].length,a=0;a<n;++a)if(e[a].length!==i)throw"various array lengths";return new t(n,i,(function(t,r){return e[t][r]}))}}},{key:"solve_CG",value:function(e,r,n){for(var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001,a=e.shape[0],o=r.shape[1],s=new t(a,0),u=0;u<o;++u){var l=t.from(r.col(u)).T,f=new t(a,1,(function(){return n.random})),h=l.sub(e.dot(f)),c=h.clone();do{var _=e.dot(c),v=h.T.dot(h).entry(0,0)/c.T.dot(_).entry(0,0);f=f.add(c.mult(v));var d=h.sub(_.mult(v)),y=d.T.dot(d).entry(0,0)/h.T.dot(h).entry(0,0);c=d.add(c.mult(y)),h=d}while(Math.abs(h.mean)>i);s=s.concat(f,"horizontal")}return s}},{key:"solve",value:function(e,r){for(var n=("L"in e&&"U"in e?e:t.LU(e)),i=n.L,a=n.U,o=i.shape[0],s=r.clone(),u=0;u<o;++u){for(var l=0;l<u-1;++l)s.set_entry(0,u,s.entry(0,u)-i.entry(u,l)*s.entry(1,l));s.set_entry(0,u,s.entry(0,u)/i.entry(u,u))}for(var f=o-1;f>=0;--f){for(var h=o-1;h>f;--h)s.set_entry(0,f,s.entry(0,f)-a.entry(f,h)*s.entry(0,h));s.set_entry(0,f,s.entry(0,f)/a.entry(f,f))}return s}},{key:"LU",value:function(e){for(var r=e.shape[0],n=new t(r,r,"zeros"),i=new t(r,r,"identity"),a=0;a<r;++a){for(var o=a;o<r;++o){for(var s=0,u=0;u<a;++u)s+=n.entry(o,u)*i.entry(u,a);n.set_entry(o,a,e.entry(o,a)-s)}for(var l=a;l<r;++l){if(0===n.entry(a,a))return;for(var f=0,h=0;h<a;++h)f+=n.entry(a,h)*i.entry(h,l);i.set_entry(a,l,(e.entry(a,l)-f)/n.entry(a,a))}}return{L:n,U:i}}},{key:"SVD",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=t.T,n=r.dot(t),i=t.dot(r),a=simultaneous_poweriteration(n,e),o=a.eigenvectors,s=a.eigenvalues,u=simultaneous_poweriteration(i,e),l=u.eigenvectors;return{U:l,Sigma:s.map((function(t){return Math.sqrt(t)})),V:o}}}]),t}();function C(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S,r=t.shape[0],n=new E(r,r),i=0;i<r;++i)for(var a=t.row(i),o=i+1;o<r;++o){var s=e(a,t.row(o));n.set_entry(i,o,s),n.set_entry(o,i,s)}return n}function P(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(r||(r=Math.max(Math.round(e-t)+1,1)),r<2)return 1===r?[t]:[];for(var n=new Array(r),i=r-=1;i>=0;--i)n[i]=(i*e+(r-i)*t)/r;return n}function Y(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S,r=null;if(t instanceof E){var n=y.default(t.shape,2),i=n[0],a=n[1];if(1===i)r=t.row(0);else{if(1!==a)throw"matrix must be 1d!";r=t.col(0)}}else r=t;var o=r.length,s=new Array(o);return s.fill(0),e(r,s)}var q=function(){function t(e){return p.default(this,t),this._N=624,this._M=397,this._MATRIX_A=2567483615,this._UPPER_MASK=2147483648,this._LOWER_MASK=2147483647,this._mt=new Array(this._N),this._mti=this.N+1,this.seed=e||(new Date).getTime(),this}return m.default(t,[{key:"seed",get:function(){return this._seed},set:function(t){this._seed=t;var e=this._mt;for(e[0]=t>>>0,this._mti=1;this._mti<this._N;this._mti+=1){var r=this._mti,n=e[r-1]^e[r-1]>>>30;e[r]=(1812433253*((4294901760&n)>>>16)<<16)+1812433253*(65535&n)+r,e[r]>>>=0}}},{key:"random",get:function(){return this.random_int*(1/4294967296)}},{key:"random_int",get:function(){var t,e=new Array(0,this._MATRIX_A);if(this._mti>=this._N){var r;this._mti==this._N+1&&(this.seed=5489);var n=this._N-this._M,i=this._M-this._N;for(r=0;r<n;++r)t=this._mt[r]&this._UPPER_MASK|this._mt[r+1]&this._LOWER_MASK,this._mt[r]=this._mt[r+this._M]^t>>>1^e[1&t];for(;r<this._N-1;++r)t=this._mt[r]&this._UPPER_MASK|this._mt[r+1]&this._LOWER_MASK,this._mt[r]=this._mt[r+i]^t>>>1^e[1&t];t=this._mt[this._N-1]&this._UPPER_MASK|this._mt[0]&this._LOWER_MASK,this._mt[this._N-1]=this._mt[this._M-1]^t>>>1^e[1&t],this._mti=0}return t=this._mt[this._mti+=1],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,(t^=t>>>18)>>>0}},{key:"choice",value:function(t,e){if(t instanceof E){var r=y.default(t.shape,2),n=r[0];if(r[1],e>n)throw"n bigger than A!";for(var i=new Array(e),a=P(0,n-1),o=0,s=a.length;o<e;++o,--s){var u=this.random_int%s;i[o]=a.splice(u,1)[0]}return i.map((function(e){return t.row(e)}))}if(Array.isArray(t)||t instanceof Float64Array){var l=t.length;if(e>l)throw"n bigger than A!";for(var f=new Array(e),h=P(0,l-1),c=0,_=h.length;c<e;++c,--_){var v=this.random_int%_;f[c]=h.splice(v,1)[0]}return f.map((function(e){return t[e]}))}}}],[{key:"choice",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:19870307,i=y.default(e.shape,2),a=i[0];if(i[1],r>a)throw"n bigger than A!";for(var o=new t(n),s=new Array(r),u=P(0,a-1),l=0,f=u.length;l<r;++l,--f){var h=o.random_int%f;s[l]=u.splice(h,1)[0]}return s.map((function(t){return e.row(t)}))}}]),t}();function F(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return D(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function D(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function L(t){var e,r,n=F(t);try{for(n.s();!(r=n.n()).done;){var i=r.value;null!=i&&(e<i||void 0===e&&i>=i)&&(e=i)}}catch(t){n.e(t)}finally{n.f()}return e}function U(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return K(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return K(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function K(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(t){return t},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"min";return p.default(this,t),e?t.heapify(e,r,n):(this._accessor=r,this._container=[],this._comparator="min"==n?function(t,e){return t<e}:"max"==n?function(t,e){return t>e}:n,this)}return m.default(t,[{key:"_swap",value:function(t,e){var r=this._container,n=[r[t],r[e]];r[e]=n[0],r[t]=n[1]}},{key:"_heapify_up",value:function(){for(var t=this._container,e=t.length-1;e>0;){var r=Math.floor((e-1)/2);if(!this._comparator(t[e].value,t[r].value))break;this._swap(r,e),e=r}}},{key:"push",value:function(t){var e={element:t,value:this._accessor(t)};return this._container.push(e),this._heapify_up(),this}},{key:"_heapify_down",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=this._container,r=this._comparator,n=e.length,i=2*t+1,a=2*t+2,o=t;if(o>n)throw"index higher than length";i<n&&r(e[i].value,e[o].value)&&(o=i),a<n&&r(e[a].value,e[o].value)&&(o=a),o!==t&&(this._swap(t,o),this._heapify_down(o))}},{key:"pop",value:function(){var t=this._container;if(0===t.length)return null;if(1===t.length)return t.pop();this._swap(0,t.length-1);var e=t.pop();return this._heapify_down(),e}},{key:"first",get:function(){return this._container.length>0?this._container[0]:null}},{key:"iterate",value:w.default.mark((function t(){var e,r;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=0,r=this._container.length;case 1:if(!(e<r)){t.next=7;break}return t.next=4,this._container[e].element;case 4:++e,t.next=1;break;case 7:case"end":return t.stop()}}),t,this)}))},{key:"toArray",value:function(){var t=this;return this.data().sort((function(e,r){return t._comparator(e,r)?-1:0}))}},{key:"data",value:function(){return this._container.map((function(t){return t.element}))}},{key:"raw_data",value:function(){return this._container}},{key:"length",get:function(){return this._container.length}},{key:"empty",get:function(){return 0===this.length}}],[{key:"heapify",value:function(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(t){return t},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"min",a=new t(null,n,i),o=a._container,s=U(e);try{for(s.s();!(r=s.n()).done;){var u=r.value;o.push({element:u,value:n(u)})}}catch(t){s.e(t)}finally{s.f()}for(var l=Math.floor(e.length/2-1);l>=0;--l)a._heapify_down(l);return a}}]),t}(),$=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:S;return p.default(this,t),this._Node=function(){return function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;p.default(this,t),this.pivot=e,this.child1=r,this.child2=n,this.radius=i}}(),this._Leaf=function(){return function t(e){p.default(this,t),this.points=e}}(),this._metric=r,e&&this.add(e),this}return m.default(t,[{key:"add",value:function(t){return t=t.map((function(t,e){return{index:e,element:t}})),this._root=this._construct(t),this}},{key:"_construct",value:function(t){var e=this;if(1===t.length)return new this._Leaf(t);var r=this._greatest_spread(t),n=t.sort((function(t,e){return t.element[r]-e.element[r]})),i=n.length,a=Math.floor(i/2),o=t[a],s=n.slice(0,a),u=n.slice(a,i),l=Math.max.apply(Math,g.default(t.map((function(t){return e._metric(o.element,t.element)}))));return s.length>0&&u.length>0?new this._Node(o,this._construct(s),this._construct(u),l):new this._Leaf(t)}},{key:"_greatest_spread",value:function(t){for(var e=t[0].element.length,r=new Array(e),n=0;n<e;++n)r[n]=[1/0,-1/0];var i=t.reduce((function(t,r){for(var n=0;n<e;++n)t[n][0]=Math.min(t[n][0],r.element[n]),t[n][1]=Math.max(t[n][1],r.element[n]);return t}),r);i=i.map((function(t){return t[1]-t[0]}));for(var a=0,o=0;o<e;++o)a=i[o]>i[a]?o:a;return a}},{key:"search",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return this._search(t,r,new G(null,(function(r){return e._metric(r.element,t)}),"max"),this._root)}},{key:"_search",value:function(t,e,r,n){if(r.length>=e&&n.pivot&&n.radius&&this._metric(t,n.pivot.element)-n.radius>=r.first.value)return r;if(n.child1&&this._search(t,e,r,n.child1),n.child2&&this._search(t,e,r,n.child2),n.points)for(var i=0,a=n.points.length;i<a;++i){var o=n.points[i];e>r.length?r.push(o):(r.push(o),r.pop())}return r}}]),t}();function W(t){for(var e=y.default(t.shape,2),r=e[0],n=e[1],i=new E(r,n,"identity"),a=new E(n,n,0),o=function(e){for(var n=t.col(e),o=function(t){var r=i.col(t),o=N(r.map((function(t,e){return t*n[e]})));a.set_entry(t,e,o),n=n.map((function(t,e){return t-o*r[e]}))},s=0;s<e;++s)o(s);for(var u=Y(n,S),l=0;l<r;++l)i.set_entry(l,e,n[l]/u);a.set_entry(e,e,u)},s=0;s<n;++s)o(s);return{R:a,Q:i}}function Q(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1212,i=n instanceof q?n:new q(n);t instanceof E||(t=E.from(t));for(var a=t.shape[0],o=W(new E(a,e,(function(){return i.random}))),s=o.Q,u=o.R;r--;){var l=u.clone(),f=t.dot(s),h=W(f);s=h.Q,N((u=h.R).sub(l).diag)/a<1e-12&&(r=0)}var c=u.diag,_=s.transpose().to2dArray;return{eigenvalues:c,eigenvectors:_}}function H(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return V(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return V(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function V(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var J=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1212;if(p.default(this,t),Array.isArray(e))this._type="array",this.X=E.from(e);else{if(!(e instanceof E))throw"no valid type for X";this._type="matrix",this.X=e}var a=y.default(this.X.shape,2);return this._N=a[0],this._D=a[1],this._d=r,this._metric=n,this._seed=i,this._randomizer=new q(i),this._is_initialized=!1,this}var e,r;return m.default(t,[{key:"parameter_list",get:function(){return this._parameter_list},set:function(t){return this._parameter_list=t,this}},{key:"parameter",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(-1===this.parameter_list.findIndex((function(e){return e===t})))throw"".concat(t," is not a valid parameter!");return e?(this["_".concat(t)]=e,this):this["_".concat(t)]}},{key:"para",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.parameter(t,e)}},{key:"p",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.parameter(t,e)}},{key:"transform",value:function(){return this.check_init(),this.Y}},{key:"generator",value:function(){return this.transform()}},{key:"check_init",value:function(){this._is_initialized||"function"!=typeof this.init||(this.init(),this._is_initialized=!0)}},{key:"projection",get:function(){return"matrix"===this._type?this.Y:this.Y.to2dArray}},{key:"transform_async",value:(r=R.default(w.default.mark((function t(){return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.transform());case 1:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})}],[{key:"transform",value:function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];var n=M.default(this,e);return n.transform()}},{key:"transform_async",value:(e=R.default(w.default.mark((function t(){var e=arguments;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.transform.apply(this,e));case 1:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"generator",value:w.default.mark((function t(){var e,r,n,i,a,o,s,u,l=arguments;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(e=l.length,r=new Array(e),n=0;n<e;n++)r[n]=l[n];i=M.default(this,r),a=i.generator(),o=H(a),t.prev=4,o.s();case 6:if((s=o.n()).done){t.next=12;break}return u=s.value,t.next=10,u;case 10:t.next=6;break;case 12:t.next=17;break;case 14:t.prev=14,t.t0=t.catch(4),o.e(t.t0);case 17:return t.prev=17,o.f(),t.finish(17);case 20:case"end":return t.stop()}}),t,this,[[4,14,17,20]])}))}]),t}();function Z(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var tt=function(t){k.default(r,t);var e=Z(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return p.default(this,r),n=e.call(this,t,i),x.default(n,b.default(n))}return m.default(r,[{key:"transform",value:function(){var t=this.X,e=t.shape[1],r=new E(e,e,"center"),n=t.dot(r),i=Q(n.transpose().dot(n),this._d).eigenvectors;return i=E.from(i).transpose(),this.Y=t.dot(i),this.projection}}]),r}(J);function et(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var rt=function(t){k.default(r,t);var e=et(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1212;return p.default(this,r),n=e.call(this,t,i,a,o),x.default(n,b.default(n))}return m.default(r,[{key:"transform",value:function(){var t=this.X,e=t.shape[0],r=this._metric,n=new Float64Array(e),i=new Float64Array(e),a=0,o=new E;o.shape=[e,e,function(e,s){if(e===s)return 0;var u=e<s?r(t.row(e),t.row(s)):o.entry(s,e);return n[e]+=u,i[s]+=u,a+=u,u}],this._d_X=o,n=n.map((function(t){return t/e})),i=i.map((function(t){return t/e})),a/=Math.pow(e,2);var s=Q(new E(e,e,(function(t,e){return o.entry(t,e)-n[t]-i[e]+a})),this._d).eigenvectors;return this.Y=E.from(s).transpose(),this.projection}},{key:"stress",get:function(){var t=this.X.shape[0],e=this.Y,r=this._d_X,n=new E;n.shape=[t,t,function(t,r){return t<r?S(e.row(t),e.row(r)):n.entry(r,t)}];for(var i=0,a=0,o=0;o<t;++o)for(var s=o+1;s<t;++s)i+=Math.pow(r.entry(o,s)-n.entry(o,s),2),a+=Math.pow(r.entry(o,s),2);return Math.sqrt(i/a)}}]),r}(J);function nt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var it=function(t){k.default(r,t);var e=nt(r);function r(t,n){var i,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;return p.default(this,r),a=e.call(this,t,o,s,u),j.default((i=b.default(a),A.default(r.prototype)),"parameter_list",["k"],i,!0),a.parameter("k",Math.min(null!=n?n:Math.max(Math.floor(a.X.shape[0]/10),2),a._N-1)),x.default(a,b.default(a))}return m.default(r,[{key:"transform",value:function(){this.check_init();var t=this.X,e=this._N,r=this._metric,n=new E;n.shape=[e,e,function(e,i){return e<=i?r(t.row(e),t.row(i)):n.entry(i,e)}];for(var i=[],a=0;a<e;++a){for(var o=[],s=0;s<e;++s)o.push({index:s,distance:n.entry(a,s)});var u=new G(o,(function(t){return t.distance}),"min");i.push(u.toArray().slice(1,this._k+1))}for(var l=new E(e,e,(function(t,e){var r=i[t].find((function(t){return t.index===e}));return r?r.distance:1/0})),f=0;f<e;++f)for(var h=0;h<e;++h)for(var c=0;c<e;++c)l.set_entry(f,h,Math.min(l.entry(f,h),l.entry(f,c)+l.entry(c,h)));var _=new Float64Array(e),v=new Float64Array(e),d=0,y=new E(e,e,(function(t,e){var r=l.entry(t,e);return r=r===1/0?0:r,_[t]+=r,v[e]+=r,d+=r,r}));_=_.map((function(t){return t/e})),v=v.map((function(t){return t/e})),d/=Math.pow(e,2);var p=Q(new E(e,e,(function(t,e){return y.entry(t,e)-_[t]-v[e]+d})),this._d).eigenvectors;return this.Y=E.from(p).transpose(),this.projection}}]),r}(J);function at(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var ot=function(t){k.default(r,t);var e=at(r);function r(t){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1212;return p.default(this,r),n=e.call(this,t,i,a,o),x.default(n,b.default(n))}return m.default(r,[{key:"_choose_distant_objects",value:function(t){for(var e=this.X.shape[0],r=this._randomizer.random_int%e-1,n=null,i=-1/0,a=0;a<e;++a){var o=t(r,a);o>i&&(i=o,n=a)}i=-1/0;for(var s=0;s<e;++s){var u=t(n,s);u>i&&(i=u,r=s)}return[r,n,i]}},{key:"transform",value:function(){for(var t=this,e=this.X,r=e.shape[0],n=this._d,i=this._metric,a=new E(r,n,0),o=function(t,r){return i(e.row(t),e.row(r))},s=function(e){var n=o,i=t._choose_distant_objects(o),s=y.default(i,3),u=s[0],l=s[1],f=s[2];if(0!==f){for(var h=0;h<r;++h){var c=o(u,h),_=o(l,h),v=(Math.pow(c,2)+Math.pow(f,2)-Math.pow(_,2))/(2*f);a.set_entry(h,e,v)}o=function(t,r){return Math.sqrt(Math.pow(n(t,r),2)-Math.pow(a.entry(t,e)-a.entry(r,e),2))}}},u=0;u<n;++u)s(u);return this.Y=a,this.projection}}]),r}(J);function st(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var ut=function(t){k.default(r,t);var e=st(r);function r(t,n){var i,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;return p.default(this,r),a=e.call(this,t,o,s,u),j.default((i=b.default(a),A.default(r.prototype)),"parameter_list",["labels"],i,!0),a.parameter("labels",n),x.default(a,b.default(a))}return m.default(r,[{key:"transform",value:function(){var t=this.X,e=y.default(t.shape,2);e[0];var r=e[1],n=this._labels,i={},a=0;n.forEach((function(e,r){e in i?(i[e].count++,i[e].rows.push(t.row(r))):i[e]={id:a++,count:1,rows:[t.row(r)]}}));var o=t.mean,s=new E(a,r);for(var u in i)for(var l=E.from(i[u].rows).meanCols,f=0;f<r;++f)s.set_entry(i[u].id,f,l[f]);var h=new E(r,r),c=function(t){var e=s.row(i[t].id),n=new E(r,1,(function(t){return e[t]-o})),a=i[t].count;h=h.add(n.dot(n.transpose()).mult(a))};for(var _ in i)c(_);var v=new E(r,r),d=function(t){for(var e=s.row(i[t].id),n=new E(r,1,(function(t){return e[t]})),a=i[t].rows,o=function(t,e){var i=new E(r,1,(function(e,r){return a[t][e]-n.entry(e,0)}));v=v.add(i.dot(i.transpose()))},u=0,l=i[t].count;u<l;++u)o(u)};for(var p in i)d(p);var m=Q(v.inverse().dot(h),this._d).eigenvectors;return m=E.from(m).transpose(),this.Y=t.dot(m),this.projection}}]),r}(J);function lt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var ft=function(t){k.default(r,t);var e=lt(r);function r(t,n){var i,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;return p.default(this,r),a=e.call(this,t,o,s,u),j.default((i=b.default(a),A.default(r.prototype)),"parameter_list",["k"],i,!0),a.parameter("k",Math.min(null!=n?n:Math.max(Math.floor(a._N/10),2),a._N-1)),x.default(a,b.default(a))}return m.default(r,[{key:"transform",value:function(){for(var t=this,e=this.X,r=this._d,n=this._N,i=this._D,a=this.parameter("k"),o=O(e,a,null,this._metric),s=new E(a,1,1),u=new E(n,n),l=function(r){var n=o[r],l=new E(a,i,(function(t,i){return e.entry(n[t].j,i)-e.entry(r,i)})),f=l.dot(l.T);if(a>i)for(var h=N(f.diag)/1e3,c=0;c<a;++c)f.set_entry(c,c,f.entry(c,c)+h);var _=E.solve_CG(f,s,t._randomizer);_=_.divide(_.sum);for(var v=0;v<a;++v)u.set_entry(r,n[v].j,_.entry(v,0))},f=0;f<n;++f)l(f);var h=new E(n,n,"identity").sub(u),c=Q(h.T.dot(h).T.inverse(),r+1).eigenvectors;return this.Y=E.from(c.slice(1,1+r)).T,this.projection}}]),r}(J);function ht(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var ct=function(t){k.default(r,t);var e=ht(r);function r(t,n){var i,a,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;if(p.default(this,r),a=e.call(this,t,o,s,u),j.default((i=b.default(a),A.default(r.prototype)),"parameter_list",["k"],i,!0),a.parameter("k",Math.min(null!=n?n:Math.max(Math.floor(a._N/10),2),a._N-1)),a._D<=o)throw"Dimensionality of X (D = ".concat(a._D,") must be greater than the required dimensionality of the result (d = ").concat(o,")!");return x.default(a,b.default(a))}return m.default(r,[{key:"transform",value:function(){for(var t=this.X,e=this._d,r=y.default(t.shape,2),n=r[0],i=r[1],a=this.parameter("k"),o=O(t,a,null,this._metric),s=new E(i,i,"center"),u=new E(n,n,0),l=0;l<n;++l)for(var f=[l].concat(g.default(o[l].map((function(t){return t.j})))),h=E.from(f.map((function(e){return t.row(e)}))),c=Q((h=h.dot(s)).dot(h.transpose()),e).eigenvectors,_=E.from(c),v=_.transpose().dot(_).add(1/Math.sqrt(a+1)),d=0;d<a+1;++d)for(var p=0;p<a+1;++p)u.set_entry(f[d],f[p],u.entry(f[d],f[p])-(d===p?1:0)+v.entry(d,p));var m=Q(u,e+1).eigenvectors;return this.Y=E.from(m.slice(1)).transpose(),this.projection}}]),r}(J);function _t(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var vt=function(t){k.default(r,t);var e=_t(r);function r(t){var n,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:S,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1212;p.default(this,r),i=e.call(this,t,s,u,l),j.default((n=b.default(i),A.default(r.prototype)),"parameter_list",["perplexity","epsilon"],n,!0);var f=y.default(i.X.shape,2);return i._N=f[0],i._D=f[1],i.parameter("perplexity",Math.min(a,i._N-1)),i.parameter("epsilon",o),i._iter=0,i.Y=new E(i._N,i._d,(function(){return i._randomizer.random})),x.default(i,b.default(i))}return m.default(r,[{key:"init",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=Math.log(this._perplexity),n=this._N,i=this._D,a=this._metric,o=this.X;if(e)t=e;else{t=new E(n,n);for(var s=0;s<n;++s)for(var u=o.row(s),l=s+1;l<n;++l){var f=a(u,o.row(l));t.set_entry(s,l,f),t.set_entry(l,s,f)}}var h=new E(n,n,"zeros");this._ystep=new E(n,i,"zeros"),this._gains=new E(n,i,1);for(var c=new Array(n).fill(0),_=1e-4,v=50,d=0;d<n;++d){for(var y=-1/0,p=1/0,m=1,g=!1,w=0;!g;){for(var b=0,k=0;k<n;++k){var x=Math.exp(-t.entry(d,k)*m);d===k&&(x=0),c[k]=x,b+=x}for(var A=0,M=0;M<n;++M){var R=0===b?0:c[M]/b;c[M]=R,R>1e-7&&(A-=R*Math.log(R))}A>r?(y=m,m=p===1/0?2*m:(m+p)/2):(p=m,m=y===-1/0?m/2:(m+y)/2),++w,Math.abs(A-r)<_&&(g=!0),w>=v&&(g=!0)}for(var j=0;j<n;++j)h.set_entry(d,j,c[j])}for(var z=new E(n,n,"zeros"),S=2*n,N=0;N<n;++N)for(var B=N;B<n;++B){var O=Math.max((h.entry(N,B)+h.entry(B,N))/S,1e-100);z.set_entry(N,B,O),z.set_entry(B,N,O)}return this._P=z,this}},{key:"transform",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.check_init();for(var e=0;e<t;++e)this.next();return this.projection}},{key:"generator",value:w.default.mark((function t(){return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.check_init();case 1:return this.next(),t.next=5,this.projection;case 5:t.next=1;break;case 7:case"end":return t.stop()}}),t,this)}))},{key:"next",value:function(){for(var t=++this._iter,e=this._P,r=this._ystep,n=this._gains,i=this._N,a=this._epsilon,o=this._d,s=this.Y,u=t<100?4:1,l=new E(i,i,"zeros"),f=0,h=0;h<i;++h)for(var c=h+1;c<i;++c){for(var _=0,v=0;v<o;++v){var d=s.entry(h,v)-s.entry(c,v);_+=d*d}var y=1/(1+_);l.set_entry(h,c,y),l.set_entry(c,h,y),f+=2*y}for(var p=new E(i,i,0),m=0;m<i;++m)for(var g=m+1;g<i;++g){var w=Math.max(l.entry(m,g)/f,1e-100);p.set_entry(m,g,w),p.set_entry(g,m,w)}for(var b=new E(i,o,"zeros"),k=0;k<i;++k)for(var x=0;x<i;++x)for(var A=4*(u*e.entry(k,x)-p.entry(k,x))*l.entry(k,x),M=0;M<o;++M)b.set_entry(k,M,b.entry(k,M)+A*(s.entry(k,M)-s.entry(x,M)));for(var R=new Float64Array(o),j=0;j<i;++j)for(var z=0;z<o;++z){var S=b.entry(j,z),N=r.entry(j,z),B=n.entry(j,z),O=Math.sign(S)===Math.sign(N)?.8*B:B+.2;O<.01&&(O=.01),n.set_entry(j,z,O);var T=(t<250?.5:.8)*N-a*O*S;r.set_entry(j,z,T),s.set_entry(j,z,s.entry(j,z)+T),R[z]+=s.entry(j,z)}for(var I=0;I<i;++I)for(var X=0;X<2;++X)s.set_entry(I,X,s.entry(I,X)-R[X]/i);return this.Y}}]),r}(J);function dt(t,e){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:300,n=.01,i=e.length,a=.001,o=1e4,s=e.slice(),u=t(s),l=!1;r-- >=0&&!l;){l=!0;for(var f=0;f<i;++f){s[f]+=1e-6;var h=t(s);s[f]-=1e-6;var c=(h-u)/1e-6;Math.abs(c)>n&&(l=!1),s[f]-=a*c,u=t(s)}a*=o>=u?1.05:.4,o=u}return s}function yt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var pt=function(t){k.default(r,t);var e=yt(r);function r(t){var n,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:S,f=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1212;p.default(this,r),i=e.call(this,t,u,l,f),j.default((n=b.default(i),A.default(r.prototype)),"parameter_list",["n_neighbors","local_connectivity","min_dist"],n,!0);var h=y.default(i.X.shape,2);return i._N=h[0],i._D=h[1],a=Math.min(i._N-1,a),i.parameter("n_neighbors",a),i.parameter("local_connectivity",Math.min(o,a-1)),i.parameter("min_dist",s),i._iter=0,i._spread=1,i._set_op_mix_ratio=1,i._repulsion_strength=1,i._negative_sample_rate=5,i._n_epochs=350,i._initial_alpha=1,i.Y=new E(i._N,i._d,(function(){return i._randomizer.random})),x.default(i,b.default(i))}return m.default(r,[{key:"_find_ab_params",value:function(t,e){for(var r=P(0,3*t,300),n=P(0,3*t,300),i=0,a=r.length;i<a;++i){var o=r[i];n[i]=o<e?1:Math.exp(-(o-e)/t)}return dt((function(t){var e=P(1,300).map((function(e,i){return n[i]-(a=r[i],o=t[0],s=t[1],1/(1+o*Math.pow(a,2*s)));var a,o,s}));return Math.sqrt(N(e.map((function(t){return t*t}))))}),[1,1])}},{key:"_compute_membership_strengths",value:function(t,e,r){for(var n=0,i=t.length;n<i;++n)for(var a=0,o=t[n].length;a<o;++a){var s=t[n][a].value-r[n];t[n][a].value=s>0?Math.exp(-s/e[n]):1}return t}},{key:"_smooth_knn_dist",value:function(t,e){for(var r=1e-5,n=.001,i=this._local_connectivity,a=Math.log2(e),o=[],s=[],u=this.X,l=g.default(u).map((function(r){return t.search(r,e).raw_data().reverse()})),f=0,h=u.shape[0];f<h;++f){var c=0,_=1/0,v=1,d=l[f],y=d.filter((function(t){return t.value>0})),p=y.length;if(p>=i){var m=Math.floor(i),w=i-m;m>0?(o.push(y[m-1]),w>r&&(o[f].value+=w*(y[m].value-y[m-1]))):o[f].value=w*y[0].value}else p>0&&(o[f]=y[p-1].value);for(var b=0;b<64;++b){for(var k=0,x=0;x<e;++x){var A=d[x].value-o[f];k+=A>0?Math.exp(-A/v):1}if(Math.abs(k-a)<r)break;if(k>a){var M=[v,(c+_)/2];_=M[0],v=M[1]}else if(_===1/0){var R=[v,2*v];c=R[0],v=R[1]}else{var j=[v,(c+_)/2];c=j[0],v=j[1]}}s[f]=v;var z=d.reduce((function(t,e){return t+e.value}),0)/d.length;if(o[f]>0)s[f]<n*z&&(s[f]=n*z);else{var S=l.reduce((function(t,e){return t+e.reduce((function(t,e){return t+e.value}),0)/e.length}));s[f]>n*S&&(s[f]=n*S)}}return{distances:l,sigmas:s,rhos:o}}},{key:"_fuzzy_simplicial_set",value:function(t,e){var r=t.shape[0],n=new $(t.to2dArray,S),i=this._smooth_knn_dist(n,e),a=i.distances,o=i.sigmas,s=i.rhos;a=this._compute_membership_strengths(a,o,s);for(var u=new E(r,r,"zeros"),l=0;l<r;++l)for(var f=a[l],h=0;h<f.length;++h)u.set_entry(l,f[h].element.index,f[h].value);var c=u.T,_=u.mult(c);return u.add(c).sub(_).mult(this._set_op_mix_ratio).add(_.mult(1-this._set_op_mix_ratio))}},{key:"_make_epochs_per_sample",value:function(t){for(var e=this._weights,r=new Float32Array(e.length).fill(-1),n=L(e),i=e.map((function(e){return t*(e/n)})),a=0;a<r.length;++a)i[a]>0&&(r[a]=Math.round(t/i[a]));return r}},{key:"_tocoo",value:function(t){for(var e=[],r=[],n=[],i=y.default(t.shape,2),a=i[0],o=i[1],s=0;s<a;++s)for(var u=0;u<o;++u){var l=t.entry(s,u);0!==l&&(e.push(s),r.push(u),n.push(l))}return{rows:e,cols:r,data:n}}},{key:"init",value:function(){var t=this,e=this._find_ab_params(this._spread,this._min_dist),r=y.default(e,2),n=r[0],i=r[1];this._a=n,this._b=i,this._graph=this._fuzzy_simplicial_set(this.X,this._n_neighbors);var a=this._tocoo(this._graph),o=a.rows,s=a.cols,u=a.data;return this._head=o,this._tail=s,this._weights=u,this._epochs_per_sample=this._make_epochs_per_sample(this._n_epochs),this._epochs_per_negative_sample=this._epochs_per_sample.map((function(e){return e*t._negative_sample_rate})),this._epoch_of_next_sample=this._epochs_per_sample.slice(),this._epoch_of_next_negative_sample=this._epochs_per_negative_sample.slice(),this}},{key:"local_connectivity",get:function(){return this._local_connectivity},set:function(t){this._local_connectivity=t}},{key:"min_dist",get:function(){return this._min_dist},set:function(t){this._min_dist=t}},{key:"graph",value:function(){return this.check_init(),{cols:this._head,rows:this._tail,weights:this._weights}}},{key:"transform",value:function(t){this.check_init(),t=t||this._n_epochs;for(var e=0;e<t;++e)this.next();return this.projection}},{key:"generator",value:w.default.mark((function t(){return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.check_init(),this._iter=0;case 2:if(!(this._iter<this._n_epochs)){t.next=8;break}return this.next(),t.next=6,this.projection;case 6:t.next=2;break;case 8:return t.abrupt("return",this.projection);case 9:case"end":return t.stop()}}),t,this)}))},{key:"_clip",value:function(t){return t>4?4:t<-4?-4:t}},{key:"_optimize_layout",value:function(t,e,r,n){for(var i=this._d,a=this._alpha,o=this._repulsion_strength,s=this._a,u=this._b,l=this._epochs_per_sample,f=this._epochs_per_negative_sample,h=this._epoch_of_next_negative_sample,c=this._epoch_of_next_sample,_=this._clip,v=n.length,d=0,y=l.length;d<y;++d)if(c[d]<=this._iter){var p=r[d],m=n[d],g=t.row(p),w=e.row(m),b="precomputed"===this._metric?this._X.entry(p,m):B(g,w),k=0;b>0&&(k=-2*s*u*Math.pow(b,u-1)/(s*Math.pow(b,u)+1));for(var x=0;x<i;++x){var A=_(k*(g[x]-w[x]))*a,M=g[x]+A,R=w[x]-A;g[x]=M,w[x]=R,t.set_entry(p,x,M),e.set_entry(m,x,R)}c[d]+=l[d];for(var j=(this._iter-h[d])/f[d],z=0;z<j;++z){var S=Math.floor(this._randomizer.random*v),N=e.row(n[S]),O="precomputed"===this._metric?this._X.entry(p,n[S]):B(g,N),T=0;if(O>0)T=2*o*u/((.01+O)*(s*Math.pow(O,u)+1));else if(p===S)continue;for(var I=0;I<i;++I){var X=_(T*(g[I]-N[I]))*a,E=g[I]+X,C=N[I]-X;g[I]=E,N[I]=C,t.set_entry(p,I,E),e.set_entry(n[S],I,C)}}h[d]+=j*f[d]}return t}},{key:"next",value:function(){var t=++this._iter,e=this.Y;return this._alpha=this._initial_alpha*(1-t/this._n_epochs),this.Y=this._optimize_layout(e,e,this._head,this._tail),this.Y}}]),r}(J);function mt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var gt=function(t){k.default(r,t);var e=mt(r);function r(t){var n,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:S,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1212;return p.default(this,r),i=e.call(this,t,s,u,l),j.default((n=b.default(i),A.default(r.prototype)),"parameter_list",["weight_adj","c"],n,!0),i.parameter("weight_adj",a),i.parameter("c",o),x.default(i,b.default(i))}return m.default(r,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.X,n=r.shape[0],i=this._d,a=this._metric,o=this._c;this.n_inliers=2*o,this.n_outliers=1*o,this.n_random=1*o,this.Y=t||new tt(r,i).transform(),this.knn=e||new $(r.to2dArray,a);var s=this._generate_triplets(this.n_inliers,this.n_outliers,this.n_random),u=s.triplets,l=s.weights;return this.triplets=u,this.weights=l,this.lr=1e3*n/u.shape[0],this.C=1/0,this.tol=1e-7,this.vel=new E(n,i,0),this.gain=new E(n,i,1),this}},{key:"_generate_triplets",value:function(t,e,r){for(var n=this._metric,i=this._weight_adj,a=this.X,o=a.shape[0],s=this.knn,u=Math.min(t+20,o),l=new E(o,u),f=new E(o,u),h=function(t){s.search(a.row(t),u+1).raw_data().filter((function(t){return 0!=t.value})).sort((function(t,e){return t.value-e.value})).forEach((function(e,r){l.set_entry(t,r,e.element.index),f.set_entry(t,r,e.value)}))},c=0;c<o;++c)h(c);for(var _=new Float64Array(o),v=0;v<o;++v)_[v]=Math.max((f.entry(v,3)+f.entry(v,4)+f.entry(v,5)+f.entry(v,6))/4,1e-10);for(var d=this._find_p(f,_,l),y=this._sample_knn_triplets(d,l,t,e),p=y.shape[0],m=new Float64Array(p),w=0;w<p;++w){var b=y.entry(w,0),k=y.entry(w,2);m[w]=n(a.row(b),a.row(k))}var x=this._find_weights(y,d,l,m,_);if(r>0){var A=this._sample_random_triplets(a,r,_),M=A.random_triplets,R=A.random_weights;y=y.concat(M,"vertical"),x=Float64Array.from([].concat(g.default(x),g.default(R)))}p=y.shape[0];for(var j=-1/0,z=0;z<p;++z)isNaN(x[z])&&(x[z]=0),j<x[z]&&(j=x[z]);for(var S=-1/0,N=0;N<p;++N)x[N]/=j,x[N]+=1e-4,x[N]=Math.log(1+i*x[N]),S<x[N]&&(S=x[N]);for(var B=0;B<p;++B)x[B]/=S;return{triplets:y,weights:x}}},{key:"_find_p",value:function(t,e,r){var n=y.default(t.shape,2),i=n[0],a=n[1];return new E(i,a,(function(n,i){return Math.exp(-Math.pow(t.entry(n,i),2)/e[n]/e[r.entry(n,i)])}))}},{key:"_sample_knn_triplets",value:function(t,e,r,n){for(var i=e.shape[0],a=new E(i*r*n,3),o=0;o<i;++o)for(var s=o*r*n,u=this.__argsort(t.row(o).map((function(t){return-t}))),l=0;l<r;++l)for(var f=l*n,h=e.entry(o,u[l]),c=this._rejection_sample(n,i,u.slice(0,l+1)),_=0;_<n;++_){var v=s+f+_,d=c[_];a.set_entry(v,0,o),a.set_entry(v,1,h),a.set_entry(v,2,d)}return a}},{key:"__argsort",value:function(t){return t.map((function(t,e){return{d:t,i:e}})).sort((function(t,e){return t.d-e.d})).map((function(t){return t.i}))}},{key:"_rejection_sample",value:function(t,e,r){var n=this._randomizer,i=P(0,e-1).filter((function(t){return r.indexOf(t)<0}));return n.choice(i,Math.min(t,i.length-2))}},{key:"_find_weights",value:function(t,e,r,n,i){for(var a=t.shape[0],o=new Float64Array(a),s=0;s<a;++s){var u=t.entry(s,0),l=r.row(u).indexOf(t.entry(s,1)),f=e.entry(u,l),h=Math.exp(-Math.pow(n[s],2)/(i[u]*i[t.entry(s,2)]));h<1e-20&&(h=1e-20),o[s]=f/h}return o}},{key:"_sample_random_triplets",value:function(t,e,r){for(var n=this._metric,i=this._randomizer,a=t.shape[0],o=new E(a*e,3),s=new Float64Array(a*e),u=0;u<a;++u)for(var l=u*e,f=[].concat(g.default(P(0,u-1)),g.default(P(u+1,a-1))),h=0;h<e;++h){var c=i.choice(f,2),_=y.default(c,2),v=_[0],d=_[1],p=Math.exp(-Math.pow(n(t.row(u),t.row(v)),2)/(r[u]*r[v]));p<1e-20&&(p=1e-20);var m=Math.exp(-Math.pow(n(t.row(u),t.row(d)),2)/(r[u]*r[d]));if(m<1e-20&&(m=1e-20),p<m){var w=[d,v];v=w[0],d=w[1];var b=[m,p];p=b[0],m=b[1]}var k=l+h;o.set_entry(k,0,u),o.set_entry(k,1,v),o.set_entry(k,2,d),s[k]=p/m}return{random_triplets:o,random_weights:s}}},{key:"_grad",value:function(t){for(var e=this.n_inliers,r=this.n_outliers,n=this.triplets,i=this.weights,a=y.default(t.shape,2),o=a[0],s=a[1],u=n.shape[0],l=new E(o,s,0),f=new Array(s).fill(0),h=new Array(s).fill(0),c=1,_=1,v=0,d=0,p=o*e*r,m=0;m<u;++m){var g=n.row(m),w=y.default(g,3),b=w[0],k=w[1],x=w[2];if(m%r==0||m>=p){c=1,_=1;for(var A=0;A<s;++A){var M=t.entry(b,A),R=t.entry(k,A),j=t.entry(x,A);f[A]=M-R,h[A]=M-j,c+=Math.pow(f[A],2),_+=Math.pow(h[A],2)}}else{_=1;for(var z=0;z<s;++z){var S=t.entry(b,z),N=t.entry(x,z);h[z]=S-N,_+=Math.pow(h[z],2)}}c>_&&++v,d+=i[m]/(1+_/c);for(var B=Math.pow(i[m]/(c+_),2),O=0;O<s;++O){var T=f[O]*_*B,I=h[O]*c*B;l.set_entry(b,O,l.entry(b,O)+T-I),l.set_entry(k,O,l.entry(k,O)-T),l.set_entry(x,O,l.entry(x,O)+I)}}return{grad:l,loss:d,n_viol:v}}},{key:"transform",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:400;this.check_init();for(var e=0;e<t;++e)this._next(e);return this.projection}},{key:"generator",value:w.default.mark((function t(){var e;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.check_init(),e=0;case 2:if(!(e<800)){t.next=9;break}return this._next(e),t.next=6,this.projection;case 6:++e,t.next=2;break;case 9:return t.abrupt("return",this.projection);case 10:case"end":return t.stop()}}),t,this)}))},{key:"_next",value:function(t){var e=t>150?.5:.3,r=this.C,n=this.vel,i=this.Y.add(n.mult(e)),a=this._grad(i),o=a.grad,s=a.loss;return a.n_viol,this.C=s,this.Y=this._update_embedding(i,t,o),this.lr*=r>s+this.tol?1.01:.9,this.Y}},{key:"_update_embedding",value:function(t,e,r){for(var n=y.default(t.shape,2),i=n[0],a=n[1],o=e>150?.9:.5,s=this.gain,u=this.vel,l=this.lr,f=0;f<i;++f)for(var h=0;h<a;++h){var c=Math.sign(u.entry(f,h))!=Math.sign(r.entry(f,h))?s.entry(f,h)+.2:Math.max(.8*s.entry(f,h),.01);s.set_entry(f,h,c),u.set_entry(f,h,o*u.entry(f,h)-l*s.entry(f,h)*r.entry(f,h)),t.set_entry(f,h,t.entry(f,h)+u.entry(f,h))}return t}}]),r}(J),wt=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"complete",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S;if(p.default(this,t),this._id=0,this._matrix=e instanceof E?e:E.from(e),this._metric=n,this._linkage=r,"precomputed"===n&&e.shape[0]!==e.shape[1])throw"If metric is 'precomputed', then matrix has to be square!";return this.init(),this.root=this.do(),this}return m.default(t,[{key:"get_clusters",value:function(t){var e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"distance",n=[];switch(r){case"distance":e=function(t){return t.dist};break;case"depth":e=function(t){return t.depth};break;default:throw"invalid type"}return this._traverse(this.root,e,t,n),n}},{key:"_traverse",value:function(t,e,r,n){e(t)<=r?n.push(t.leaves()):(this._traverse(t.left,e,r,n),this._traverse(t.right,e,r,n))}},{key:"init",value:function(){var t,e=this._metric,r=this._matrix,n=this._n=r.shape[0],i=this._d_min=new Float64Array(n);if("precomputed"!==e){t=new E(n,n,0);for(var a=0;a<n;++a){i[a]=0;for(var o=0;o<n;++o)t.set_entry(a,o,a===o?1/0:e(r.row(a),r.row(o))),t.entry(a,i[a])>t.entry(a,o)&&(i[a]=o)}}else{t=this._matrix.clone();for(var s=0;s<n;++s)for(var u=0;u<n;++u)s===u?t.set_entry(s,u,1/0):t.entry(s,i[s])>t.entry(s,u)&&(i[s]=u)}this._distance_matrix=t;for(var l=this._clusters=new Array(n),f=this._c_size=new Uint16Array(n),h=0;h<n;++h)l[h]=[],l[h][0]=new bt(this._id++,null,null,0,r.row(h),h,1,0),f[h]=1;return this}},{key:"do",value:function(){for(var t=this._n,e=this._d_min,r=this._distance_matrix,n=this._clusters,i=this._c_size,a=this._linkage,o=null,s=0,u=t-1;s<u;++s){for(var l=0,f=0;f<t;++f)r.entry(f,e[f])<r.entry(l,e[l])&&(l=f);var h=e[l],c=n[l][0],_=n[h][0],v=c.isLeaf?[c.index]:c.index,d=_.isLeaf?[_.index]:_.index,y=v.concat(d),p=new bt(this._id++,c,_,r.entry(l,h),null,y);c.parent=p,_.parent=p,n[l].unshift(p),i[l]+=i[h];for(var m=0;m<t;++m)switch(a){case"single":r.entry(l,m)>r.entry(h,m)&&(r.set_entry(m,l,r.entry(h,m)),r.set_entry(l,m,r.entry(h,m)));break;case"complete":r.entry(l,m)<r.entry(h,m)&&(r.set_entry(m,l,r.entry(h,m)),r.set_entry(l,m,r.entry(h,m)));break;case"average":var g=(i[l]*r.entry(l,m)+i[h]*r.entry(h,m))/(i[l]+i[m]);r.set_entry(m,l,g),r.set_entry(l,m,g)}r.set_entry(l,l,1/0);for(var w=0;w<t;++w)r.set_entry(w,h,1/0),r.set_entry(h,w,1/0);for(var b=0;b<t;++b)e[b]===h&&(e[b]=l),r.entry(l,b)<r.entry(l,e[l])&&(e[l]=b);o=p}return o}}]),t}(),bt=function(){function t(e,r,n,i,a,o,s,u){return p.default(this,t),this.id=e,this.left=r,this.right=n,this.dist=i,this.index=o,this.size=null!=s?s:r.size+n.size,this.depth=null!=u?u:1+Math.max(r.depth,n.depth),this.centroid=null!=a?a:this._calculate_centroid(r,n),this.parent=null,this}return m.default(t,[{key:"_calculate_centroid",value:function(t,e){for(var r=t.size,n=e.size,i=t.centroid,a=e.centroid,o=this.size,s=t.centroid.length,u=new Float64Array(s),l=0;l<s;++l)u[l]=(r*i[l]+n*a[l])/o;return u}},{key:"isLeaf",get:function(){return 0===this.depth}},{key:"leaves",value:function(){if(this.isLeaf)return[this];var t=this.left,e=this.right;return(t.isLeaf?[t]:t.leaves()).concat(e.isLeaf?[e]:e.leaves())}},{key:"descendants",value:function(){if(this.isLeaf)return[this];var t=this.left.descendants(),e=this.right.descendants();return t.concat(e).concat([this])}}]),t}(),kt=function(){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1987,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];p.default(this,t),this._metric=n,this._matrix=e,this._K=r;var o=y.default(e.shape,2),s=o[0],u=o[1];return this._N=s,this._D=u,r>s&&(r=s),this._randomizer=new q(i),this._clusters=new Array(s).fill(void 0),this._cluster_centroids=this._get_random_centroids(r),a&&this.init(r,this._cluster_centroids),this}return m.default(t,[{key:"get_clusters",value:function(){var t=this._K,e=this._clusters,r=new Array(t).fill().map((function(){return new Array}));return e.forEach((function(t,e){return r[t].push(e)})),r}},{key:"_furthest_point",value:function(t,e){var r=this._matrix,n=this._metric,i=t.length;return G.heapify(e,(function(e){for(var a=r.row(e),o=0,s=0;s<i;++s)o+=n(a,t[s]);return o}),"max").pop().element}},{key:"_get_random_centroids",value:function(t){var e=this._N,r=this._randomizer,n=this._matrix,i=new Array(t).fill(),a=P(0,e-1),o=r.random_int%(e-1);i[0]=n.row(o);for(var s=[o],u=Math.floor((e-t)/t),l=1;l<t;++l){var f=r.choice(a.filter((function(t){return-1==s.indexOf(t)})),u),h=this._furthest_point(i.slice(0,l),f);s.push(h),i[l]=n.row(h)}return i}},{key:"_iteration",value:function(t){for(var e=t.length,r=this._N,n=this._D,i=this._matrix,a=this._metric,o=this._clusters,s=!1,u=0;u<r;++u){for(var l=i.row(u),f=1/0,h=null,c=0;c<e;++c){var _=a(t[c],l);_<f&&(f=_,h=c)}o[u]!==h&&(s=!0),o[u]=h}for(var v=0;v<e;++v)for(var d=t[v],y=0;y<n;++y)d[y]=0;return this._compute_centroid(t),{clusters_changed:s,cluster_centroids:t}}},{key:"_compute_centroid",value:function(t){for(var e=t.length,r=this._N,n=this._D,i=this._matrix,a=this._clusters,o=new Array(e).fill(0),s=0;s<r;++s){var u=i.row(s),l=a[s];o[l]++;for(var f=t[l],h=0;h<n;++h)f[h]+=u[h]}for(var c=function(e){var r=o[e];t[e]=t[e].map((function(t){return t/r}))},_=0;_<e;++_)c(_)}},{key:"init",value:function(t,e){t||(t=this._K),e||(e=this._get_random_centroids(t));var r=!1;do{var n=this._iteration(e);e=n.cluster_centroids,r=n.clusters_changed}while(r)}}]),t}(),xt=function(){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;p.default(this,t),this._metric=i,this._matrix=e,this._A=this._matrix.to2dArray,this._K=r;var o=y.default(e.shape,2),s=o[0],u=o[1];return this._N=s,this._D=u,this._max_iter=n||10*Math.log10(s),this._distance_matrix=new E(s,s,"zeros"),r>s&&(r=s),this._randomizer=new q(a),this._clusters=new Array(s).fill(void 0),this._cluster_medoids=this._get_random_medoids(r),this._is_initialized=!1,this}return m.default(t,[{key:"get_clusters",value:function(){var t=this,e=this._K,r=this._A;this._is_initialized||this.init(e,this._cluster_medoids);var n=new Array(e).fill().map((function(){return new Array}));return r.forEach((function(e,r){n[t._nearest_medoid(e,r).index_nearest].push(r)})),n.medoids=this._cluster_medoids,n}},{key:"generator",value:function(){var t=this;return z.default(w.default.mark((function e(){var r,n,i;return w.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t._max_iter,e.next=3,t.get_clusters();case 3:n=!1,i=0;case 5:return n=t._iteration(),e.next=8,t.get_clusters();case 8:if(!n&&++i<r){e.next=5;break}case 9:case"end":return e.stop()}}),e)})))()}},{key:"_iteration",value:function(){var t=this,e=this._A,r=this._K,n=this._cluster_medoids,i=e.map((function(e,r){return t._nearest_medoid(e,r)})),a=new Array(r).fill(0),o=new Array(r).fill(null);if(e.forEach((function(s,u){if(n.findIndex((function(t){return t===u}))<0){var l=i[u].distance_nearest,f=new Array(r).fill(-l);e.forEach((function(e,n){if(u!==n){var a=t._get_distance(n,u,e,s),o=i[n],l=o.index_nearest,h=o.distance_nearest,c=o.distance_second;if(f[l]+=Math.min(a,c)-h,a<h)for(var _=0;_<r;++_)_!==l&&(f[_]+=a-h)}})),f.map((function(t,e){return[t,e]})).filter((function(t){var e=y.default(t,2),r=e[0],n=e[1];return r<a[n]})).forEach((function(t){var e=y.default(t,2),r=e[0],n=e[1];r<a[n]&&(a[n]=r,o[n]=u)}))}})),Math.min.apply(Math,g.default(a))>=0)return!0;for(var s=function(){var r=a.map((function(t,e){return[t,e]})).sort((function(t,e){return y.default(t,1)[0]-y.default(e,1)[0]}))[0][1];0==n.filter((function(t){return t==o[r]})).length&&(n[r]=o[r]),a[r]=0,a.map((function(t,e){return[t,e]})).filter((function(t){return y.default(t,1)[0]<0})).forEach((function(o){var s=y.default(o,2);s[0];var u=s[1],l=e[u],f=0;e.forEach((function(e,a){n.findIndex((function(t){return t!=u&&t==a}))>=0||r!=u&&(i[a].index_nearest===n[u]?f+=Math.min(t._get_distance(a,u,e,l),i[a].distance_second)-i[a].distance_nearest:f+=Math.min(t._get_distance(a,u,e,l)-i[a].distance_nearest,0))})),a[u]=f}))};Math.min.apply(Math,g.default(a))<0;)s();return this._cluster_medoids=n,!1}},{key:"_get_distance",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(t===e)return 0;var i=this._distance_matrix,a=this._A,o=this._metric,s=i.entry(t,e);return 0===s&&(s=o(r||a[t],n||a[e]),i.set_entry(t,e,s),i.set_entry(e,t,s)),s}},{key:"_nearest_medoid",value:function(t,e){var r=this,n=this._cluster_medoids,i=this._A,a=n.map((function(n,a){var o=i[n];return[r._get_distance(e,n,t,o),a]})).sort((function(t,e){return t[0]-e[0]})),o=y.default(a,2),s=o[0],u=o[1];return{distance_nearest:s[0],index_nearest:s[1],distance_second:u[0],index_second:u[1]}}},{key:"init",value:function(t,e){t||(t=this._K),e||(e=this._get_random_medoids(t));var r=this._max_iter,n=!1,i=0;do{n=this._iteration()}while(!n&&++i<r);return this}},{key:"_get_random_medoids",value:function(t){for(var e=this,r=this._N,n=this._A,i=P(0,r-1),a=this._randomizer,o=Math.min(r,10+Math.ceil(Math.sqrt(r))),s=new Array(o).fill(1/0),u=[],l=1/0,f=a.choice(i,o),h=0;h<o;++h){for(var c=f[h],_=n[c],v=0;v<o;++v)if(v!==h){var d=n[f[v]];s[h]+=this._get_distance(h,v,_,d)}s[h]<l&&(l=s[h],u.push(c))}for(var y=1;y<t;++y){var p=1/0;f=a.choice(i.filter((function(t){return u.findIndex((function(e){return e===t}))<0})),o);for(var m=0;m<o;++m){for(var w=0,b=f[m],k=n[b],x=function(t){if(t===m)return"continue";var r=f[t],i=n[r],a=e._get_distance(b,r,k,i)-Math.min.apply(Math,g.default(u.map((function(t){return e._get_distance(r,t,i)}))));a<0&&(w+=a)},A=0;A<o;++A)x(A);w<p&&(p=w,u.push(b))}l+=p}return u.slice(0,t)}}]),t}();function At(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return Mt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Mt(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function Mt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var Rt=function(){function t(e,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S;return p.default(this,t),this._matrix=e,this._epsilon=r,this._min_points=n,this._metric=i,this._ordered_list=[],this._clusters=[],this._DB=new Array(e.shape[0]).fill(),this.init(),this}return m.default(t,[{key:"init",value:function(){for(var t=this._ordered_list,e=this._matrix,r=e.shape[0],n=this._DB,i=this._clusters,a=this._cluster_index=0,o=0;o<r;++o)n[o]={element:e.row(o),index:o,reachability_distance:void 0,processed:!1};var s,u=At(n);try{for(u.s();!(s=u.n()).done;){var l=s.value;if(!l.processed&&(l.neighbors=this._get_neighbors(l),l.processed=!0,i.push([l.index]),a=i.length-1,t.push(l),null!=this._core_distance(l))){var f=new G(null,(function(t){return t.reachability_distance}),"min");this._update(l,f),this._expand_cluster(f,i[a])}}}catch(t){u.e(t)}finally{u.f()}return this}},{key:"_get_neighbors",value:function(t){if("neighbors"in t)return t.neighbors;var e,r=this._DB,n=this._metric,i=this._epsilon,a=[],o=At(r);try{for(o.s();!(e=o.n()).done;){var s=e.value;s.index!=t.index&&(n(t.element,s.element)<i&&a.push(s))}}catch(t){o.e(t)}finally{o.f()}return a}},{key:"_core_distance",value:function(t){var e=this._min_points,r=this._metric;if(!(t.neighbors&&t.neighbors.length<=e))return r(t.element,t.neighbors[e].element)}},{key:"_update",value:function(t,e){var r,n=this._metric,i=this._core_distance(t),a=At(this._get_neighbors(t));try{var o=function(){var a=r.value;if(a.processed)return"continue";var o=Math.max(i,n(t.element,a.element));e.raw_data().findIndex((function(t){return t.element==a}))<0?(a.reachability_distance=o,e.push(a)):o<a.reachability_distance&&(a.reachability_distance=o,e=G.heapify(e.data(),(function(t){return t.reachability_distance}),"min"))};for(a.s();!(r=a.n()).done;)o()}catch(t){a.e(t)}finally{a.f()}}},{key:"_expand_cluster",value:function(t,e){for(var r=this._ordered_list;!t.empty;){var n=t.pop().element;n.neighbors=this._get_neighbors(n),n.processed=!0,e.push(n.index),r.push(n),null!=this._core_distance(n)&&(this._update(n,t),this._expand_cluster(t,e))}}},{key:"get_clusters",value:function(){var t,e=[],r=[],n=this._min_points,i=At(this._clusters);try{for(i.s();!(t=i.n()).done;){var a=t.value;a.length<n?r.push.apply(r,g.default(a)):e.push(a)}}catch(t){i.e(t)}finally{i.f()}return e.push(r),e}},{key:"get_cluster_affirmation",value:function(){for(var t=this._matrix.shape[0],e=new Array(t).fill(),r=this.get_clusters(),n=0,i=r.length;n<i;++n){var a,o=At(r[n]);try{for(o.s();!(a=o.n()).done;){e[a.value]=n<i-1?n:-1}}catch(t){o.e(t)}finally{o.f()}}return e}}]),t}();function jt(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return zt(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return zt(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function zt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function St(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var Nt=function(t){k.default(r,t);var e=St(r);function r(t,n,i){var a,o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:S,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1212;return p.default(this,r),o=e.call(this,t,s,u,l),j.default((a=b.default(o),A.default(r.prototype)),"parameter_list",["k","control_points"],a,!0),o.parameter("k",Math.min(null!=n?n:Math.max(Math.floor(o._N/10),2),o._N-1)),o.parameter("control_points",Math.min(null!=i?i:Math.ceil(Math.sqrt(o._N)),o._N-1)),o._is_initialized=!1,x.default(o,b.default(o))}return m.default(r,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:rt,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:$;if(this._is_initialized)return this;var n=this.X,i=this._N,a=this.parameter("k"),o=this._d,s=this._metric,u=this.parameter("control_points"),l=new xt(n,u,null,s).get_clusters().medoids,f=new E(u,i,"zeros");l.forEach((function(t,e){f.set_entry(e,t,1)}));var h=M.default(t,[E.from(l.map((function(t){return n.row(t)})))].concat(g.default(e),[o])).transform(),c=n.to2dArray,_=new r(c,s),v=new E(i,i,"I"),d=-1/a;c.forEach((function(t,e){var r,n=jt(_.search(t,a).iterate());try{for(n.s();!(r=n.n()).done;){var i=r.value.index;e!==i&&v.set_entry(e,i,d)}}catch(t){n.e(t)}finally{n.f()}}));var y=v.concat(f,"vertical"),p=new E(i,o,"zeros"),m=p.concat(h,"vertical");return this._A=y,this._b=m,this._is_initialized=!0,this}},{key:"transform",value:function(){this.check_init();var t=this._A,e=t.T,r=this._b,n=e.dot(t),i=e.dot(r);return this.Y=E.solve_CG(n,i,this._randomizer),this.projection}}]),r}(J);function Bt(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(!t)return;if("string"==typeof t)return Ot(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Ot(t,e)}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==r.return||r.return()}finally{if(s)throw a}}}}function Ot(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Tt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var It=function(t){k.default(r,t);var e=Tt(r);function r(t){var n,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:S,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1212;p.default(this,r),i=e.call(this,t,a,o,s),j.default((n=b.default(i),A.default(r.prototype)),"parameter_list",[],n,!0);var u=y.default(i.X.shape,2);return i._N=u[0],i._D=u[1],i._distance_matrix=new E(i._N,i._N,0),x.default(i,b.default(i))}return m.default(r,[{key:"__lazy_distance_matrix",value:function(t,e,r){var n=this._distance_matrix,i=this.X,a=n.entry(t,e);if(0===a){var o=r(i.row(t),i.row(e));return n.set_entry(t,e,o),n.set_entry(e,t,o),o}return a}},{key:"_make_minimum_spanning_tree",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:S,e=this._N,r=g.default(this.X),n=new Xt(r),i=[],a=[],o=0;o<e;++o)for(var s=o+1;s<e;++s)a.push([o,s,this.__lazy_distance_matrix(o,s,t)]);var u,l=Bt(a=a.sort((function(t,e){return t[2]-e[2]})));try{for(l.s();!(u=l.n()).done;){var f=y.default(u.value,3),h=f[0],c=f[1],_=f[2],v=n.find(r[h]),d=n.find(r[c]);v!==d&&(i.push([h,c,_]),n.union(v,d))}}catch(t){l.e(t)}finally{l.f()}return i.sort((function(t,e){return t[2]-e[2]}))}},{key:"init",value:function(){return this.Y=new E(this._N,this._d,0),this._Emst=this._make_minimum_spanning_tree(this._metric),this._is_initialized=!0,this}},{key:"__hull_cross",value:function(t,e,r){var n=y.default(t,2),i=n[0],a=n[1],o=y.default(e,2),s=o[0],u=o[1],l=y.default(r,2),f=l[0];return(s-i)*(l[1]-a)-(u-a)*(f-i)<=0}},{key:"__hull",value:function(t){var e=t.sort((function(t,e){var r=y.default(t,2),n=r[0],i=r[1],a=y.default(e,2),o=a[0];return i-a[1]||n-o})),r=e.length;if(r<=2)return e;for(var n=[],i=0;i<r;++i){for(;n.length>=2&&this.__hull_cross(n[n.length-2],n[n.length-1],e[i]);)n.pop();n.push(e[i])}for(var a=[],o=r-1;o>=0;--o){for(;a.length>=2&&this.__hull_cross(a[a.length-2],a[a.length-1],e[o]);)a.pop();a.push(e[o])}return a.pop(),n.pop(),n.concat(a)}},{key:"__findAngle",value:function(t,e){var r=y.default(t,2),n=r[0],i=r[1],a=y.default(e,2),o=a[0],s=a[1],u=S([n,i],[o,s]);if(0===u)return{sin:0,cos:1};var l=[(o-n)/u,(s-i)/u],f=l[0],h=Math.sqrt(1-f*f);return{sin:h=l[1]>=0?-h:h,cos:f}}},{key:"__align_hull",value:function(t,e,r){for(var n,i,a,o=-1,s=0;s<t.length;++s){var u=S(t[s],e);(-1===o||n>u)&&(n=u,o=s)}r?(i=t[o],a=t[(o+1)%t.length]):(0==o&&(o=t.length-1),i=t[o],a=t[(o-1)%t.length]);var l={tx:-t[o][0],ty:-t[o][1]};if(t.length>=2){var f=this.__findAngle(i,a),h=f.sin,c=f.cos;l.sin=h,l.cos=c}else l.sin=0,l.cos=1;return l}},{key:"__transform",value:function(t,e){var r=y.default(t,2),n=r[0],i=r[1],a=e.tx,o=e.ty,s=e.sin,u=e.cos,l=n+a,f=i+o;return[l*u-f*s,l*s+f*u]}},{key:"__transform_component",value:function(t,e,r){for(var n=t.length,i=0;i<n;++i){var a=t[i],o=this.__transform(a,e),s=y.default(o,2),u=s[0],l=s[1];a[0]=u,a[1]=l+r}}},{key:"__align_components",value:function(t,e,r){var n=g.default(t.__disjoint_set.children),i=g.default(e.__disjoint_set.children),a=this.__hull(n),o=this.__hull(i),s=this.__align_hull(a,t,!1),u=this.__align_hull(o,e,!0);this.__transform_component(n,s,0),this.__transform_component(i,u,r)}},{key:"transform",value:function(){this._is_initialized||this.init();var t,e=this._Emst,r=g.default(this.Y),n=new Xt(r.map((function(t,e){return t.i=e,t}))),i=Bt(e);try{for(i.s();!(t=i.n()).done;){var a=y.default(t.value,3),o=a[0],s=a[1],u=a[2],l=n.find(r[o]),f=n.find(r[s]);l!==f&&(this.__align_components(l,f,u),n.union(l,f))}}catch(t){i.e(t)}finally{i.f()}return this.projection}},{key:"generator",value:w.default.mark((function t(){var e,r,n,i,a,o,s,u,l,f,h;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this._is_initialized||this.init(),e=this._Emst,r=g.default(this.Y),n=new Xt(r.map((function(t,e){return t.i=e,t}))),i=Bt(e),t.prev=5,i.s();case 7:if((a=i.n()).done){t.next=19;break}if(o=y.default(a.value,3),s=o[0],u=o[1],l=o[2],f=n.find(r[s]),h=n.find(r[u]),f!==h){t.next=13;break}return t.abrupt("continue",17);case 13:return this.__align_components(f,h,l),n.union(f,h),t.next=17,this.projection;case 17:t.next=7;break;case 19:t.next=24;break;case 21:t.prev=21,t.t0=t.catch(5),i.e(t.t0);case 24:return t.prev=24,i.f(),t.finish(24);case 27:return t.abrupt("return",this.projection);case 28:case"end":return t.stop()}}),t,this,[[5,21,24,27]])}))}]),r}(J),Xt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(p.default(this,t),this._list=new Set,e){var r,n=Bt(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;this.make_set(i)}}catch(t){n.e(t)}finally{n.f()}}return this}return m.default(t,[{key:"make_set",value:function(t){var e=this._list;return e.has(t)||(e.add(t),t.__disjoint_set={},t.__disjoint_set.parent=t,t.__disjoint_set.children=new Set([t]),t.__disjoint_set.size=1),this}},{key:"find",value:function(t){var e;return this._list.has(t)?t.__disjoint_set.parent!==t?((e=t.__disjoint_set.children).add.apply(e,g.default(t)),t.__disjoint_set.parent=this.find(t.__disjoint_set.parent),t.__disjoint_set.parent):t:null}},{key:"union",value:function(t,e){var r=this.find(t),n=this.find(e);if(r===n)return this;if(r.__disjoint_set.size<n.__disjoint_set.size){var i=[n,r];r=i[0],n=i[1]}return n.__disjoint_set.parent=r,n.__disjoint_set.children.forEach(r.__disjoint_set.children.add,r.__disjoint_set.children),r.__disjoint_set.size+=n.__disjoint_set.size,this}}]),t}();function Et(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=A.default(t);if(e){var i=A.default(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return x.default(this,r)}}var Ct=function(t){k.default(r,t);var e=Et(r);function r(t){var n,i,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:S,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1212;p.default(this,r),i=e.call(this,t,o,s,u),j.default((n=b.default(i),A.default(r.prototype)),"parameter_list",["max_halves"],n,!0),i.parameter("max_halves",a);var l=y.default(i.X.shape,2);return i._N=l[0],i._D=l[1],x.default(i,b.default(i))}return m.default(r,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"random",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this._N,n=this._d;if("random"===t){var i=this._randomizer;console.log(i),this.Y=new E(r,n,(function(){return i.random}))}else this.Y=t.transform(this.X);var a=this.Y;e||(e=new E(r,r));for(var o=this._metric,s=new E(r,r),u=new E(r,r),l=0;l<r;++l)for(var f=a.row(l),h=l;h<r;++h){var c=l===h?1:o(f,a.row(h)),_=1/c;if(s.set_entry(l,h,c),s.set_entry(h,l,c),u.set_entry(l,h,_),u.set_entry(h,l,_),!e){var v=l===h?1:o(X.row(l),X.row(h));e.set_entry(l,h,v),e.set_entry(h,l,v)}}var d=e._apply(1,(function(t,e){return e/t})),y=e.sub(s),p=y._apply(2,(function(t,e){return Math.pow(t,e)})).mult(d);return console.log(p),this._distance_matrix=s,this._distance_inverse_matrix=u,this._Distance_matrix=e,this._Distance_inverse_matrix=u,this._delta=y,this._ones=new E(r,n,1),this._E=p.sum,this}},{key:"__distance_matrix",value:function(t){for(var e=this._metric,r=t.shape[0],n=new E(r,r),i=0;i<r;++i)for(var a=t.row(i),o=i;o<r;++o){var s=i===o?1:e(a,t.row(o));n.set_entry(i,o,s),n.set_entry(o,i,s)}return n}},{key:"transform",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20;this._is_initialized||this.init();for(var e=0;e<t;++e)console.log(g.default(this.Y)),this._step();return this.projection}},{key:"generator",value:w.default.mark((function t(){var e;return w.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this._is_initialized||this.init(),e=0;case 2:if(!(e<max_iter)){t.next=9;break}return this._step(),t.next=6,this.projection;case 6:++e,t.next=2;break;case 9:return t.abrupt("return",this.projection);case 10:case"end":return t.stop()}}),t,this)}))},{key:"_step",value:function(){var t=this.parameter("max_halves"),e=this._distance_matrix,r=this._distance_inverse_matrix,n=this._Distance_matrix,i=this._Distance_inverse_matrix,a=this._ones,o=this._E,s=this.Y,u=r.sub(i),l=u.dot(a),f=u.dot(s).sub(s.mult(l)),h=r._apply(3,(function(t,e){return Math.pow(t,e)})),c=s._apply(2,(function(t,e){return Math.pow(t,e)})),_=h.dot(c).sub(l).sub(s.mult(2).mult(h.dot(s))).add(c.mult(h.dot(a)));_=_._apply(null,(function(t){return Math.abs(t)}));for(var v=f.divide(_),d=s.clone(),y=0;y<t;++y){if(s=d.add(v),r=(e=this.__distance_matrix(s))._apply(1,(function(t,e){return e/t})),(u=n.sub(e))._apply(2,(function(t,e){return Math.pow(t,e)})).mult(i).sum<o)break;v=v.mult(.5)}this.Y=s}}]),r}(J);t.BallTree=$,t.FASTMAP=ot,t.Heap=G,t.Hierarchical_Clustering=wt,t.ISOMAP=it,t.KMeans=kt,t.KMedoids=xt,t.LDA=ut,t.LLE=ft,t.LSP=Nt,t.LTSA=ct,t.MDS=rt,t.Matrix=E,t.OPTICS=Rt,t.PCA=tt,t.Randomizer=q,t.SAMMON=Ct,t.TSNE=vt,t.TopoMap=It,t.TriMap=gt,t.UMAP=pt,t.canberra=function(t,e){if(t.length===e.length){for(var r=t.length,n=0,i=0;i<r;++i)n+=Math.abs(t[i]-e[i])/(Math.abs(t[i])+Math.abs(e[i]));return n}},t.chebyshev=function(t,e){if(t.length==e.length){for(var r=t.length,n=[],i=0;i<r;++i)n.push(Math.abs(t[i]-e[i]));return Math.max.apply(Math,n)}},t.cosine=function(t,e){if(t.length===e.length){for(var r=t.length,n=0,i=0,a=0,o=0;o<r;++o)n+=t[o]*e[o],i+=t[o]*t[o],a+=e[o]*e[o];return Math.acos(n/(Math.sqrt(i)*Math.sqrt(a)))}},t.distance_matrix=C,t.euclidean=S,t.euclidean_squared=B,t.k_nearest_neighbors=O,t.kahan_sum=function(t){for(var e,r,n=t.length,i=0,a=0,o=0;o<n;++o)a=(r=i+(e=t[o]-a))-i-e,i=r;return i},t.linspace=P,t.manhattan=function(t,e){if(t.length==e.length){for(var r=t.length,n=0,i=0;i<r;++i)n+=Math.abs(t[i]-e[i]);return n}},t.max=L,t.neumair_sum=N,t.norm=Y,t.powell=dt,t.qr=W,t.simultaneous_poweriteration=Q,t.version="0.3.11",Object.defineProperty(t,"__esModule",{value:!0})}));
