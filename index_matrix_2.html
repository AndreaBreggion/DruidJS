<!DOCTYPE html>
<head>
    <style>
        * {
            font-family: sans-serif;
        }

        body {
            background-color: #1d1d1d;
            margin: .25rem;
            color: #ddd;
        }

        canvas {
            background-color: #202020;
            margin: .25rem;
        }

        nav {
            display: block;
            color: #ddd;
        }

        #left, #mid, #right {
            position: relative;
        }

        svg path, svg line {
            stroke: #888;
        }

        svg text {
            fill: #888;
        }
    </style>
</head>
<body>
    
    <div style="color: #ddd" id="title1">UMAP</div>
    <div style="display: flex;">
            <div id="left"></div>
            <div id="mid"></div>
            <div id="right"></div>
    </div>
    <input type="checkbox" value="Digits" id="draw_digits" checked/>draw digits
    <script src="test/d3.js"></script>
    <script src="dist/druid.js"></script>
    <script>
        const dpr = window.devicePixelRatio;
        let width = 600 * dpr;
        let height = 600 * dpr;
        let margin = 10 * dpr;
        let color_scale = d3.scaleOrdinal(["#4e79a7","#f28e2c","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab"])
        //let color_scale = d3.scaleOrdinal(["#50BFE6","#FF9933","#FF355E","#AAF0D1","#66FF66","#FFFF66","#FF00CC","#FF6EFF","#AF6E4D","#BFAFB2"])
        //let color_scale = d3.scaleOrdinal(["#1b9e77", "#d95f02", "#7570b3", "#e7298a", "#66a61e", "#e6ab02", "#a6761d", "#666666", "#50bfe6", "#FB4D46"])

        let DR = druid.UMAP;
        const local_conn = 1;
        const min_dist = 1;
        const max_iter = 200;
        const perp = 20;
        const eps = 10;
        const max_iter_tsne = 1000;
        d3.select("#title1").text(`UMAP | local_conn = ${local_conn} | min_dist = ${min_dist} | max_iterations = ${max_iter}`)
        
        let left = d3.select("#left").append("canvas")
            .attr("width", width)
            .attr("height", height)
            .style("width", width / dpr + "px")
            .style("height", height / dpr + "px")            
            .node()
            .getContext("2d");

        let left_svg = d3.select("#left").append("svg")
            .attr("width", width / dpr)
            .attr("height", height / dpr)
            .style("position", "absolute")
            .style("top", "0px")
            .style("left", "0px")
            .style("margin", ".25rem")

        let mid = d3.select("#mid").append("canvas")
            .attr("width", width)
            .attr("height", height)
            .style("width", width / dpr + "px")
            .style("height", height / dpr + "px")      
            .node()
            .getContext("2d");

        let mid_svg = d3.select("#mid").append("svg")
            .attr("width", width / dpr)
            .attr("height", height / dpr)
            .style("position", "absolute")
            .style("top", "0px")
            .style("left", "0px")
            .style("margin", ".25rem")

        let right = d3.select("#right").append("canvas")
            .attr("width", width)
            .attr("height", height)
            .style("width", width / dpr + "px")
            .style("height", height / dpr + "px")            
            .node()
            .getContext("2d");

        let right_svg = d3.select("#right").append("svg")
            .attr("width", width / dpr)
            .attr("height", height / dpr)
            .style("position", "absolute")
            .style("top", "0px")
            .style("left", "0px")
            .style("margin", ".25rem")

        left.scale(dpr, dpr);
        mid.scale(dpr, dpr);
        right.scale(dpr, dpr);

        let labels = [];
        let mnist = [];
        let digits = {"full": [], "bottom": [], "top": []};
        let data = [];
        let top_half = [];
        let bottom_half = [];

        let matrix_data = [];
        let matrix_top = [];
        let matrix_bottom = [];
        let matrix_mid = [];

        let dr_data = null;
        let dr_top = null;
        let dr_bottom = null;

        let contexts = [left, mid, right]
        //let ordering = null;
        let ordering = [26,12,0,38,8,20,28,17,18,5,11,3,25,34,24,13,32,7,30,39,29,16,4,9,6,37,21,23,19,1,326,258,268,252,276,254,240,265,321,81,243,261,247,255,250,241,263,257,256,246,272,270,269,277,279,264,253,33,259,242,278,274,275,260,266,179,271,244,248,10,2,118,22,35,36,27,14,211,324,82,267,335,225,209,362,121,123,144,132,126,155,237,216,238,231,150,143,136,127,133,107,99,104,117,88,101,92,86,112,102,89,108,233,119,90,137,95,113,51,45,114,72,331,83,116,215,306,299,55,175,56,42,54,62,65,49,66,59,236,383,234,381,105,100,84,98,103,85,353,115,330,392,284,388,291,309,311,282,305,281,360,221,74,52,110,60,230,298,214,203,356,349,328,91,94,350,96,351,181,348,249,220,201,262,31,106,251,273,15,111,120,223,207,222,200,210,204,218,205,213,212,206,325,239,226,352,338,355,358,339,320,343,224,344,229,342,357,327,336,334,337,345,323,347,333,232,340,227,147,122,138,152,125,131,159,151,156,202,129,139,134,146,148,329,141,93,97,109,188,228,64,53,47,67,40,78,44,71,58,46,48,61,57,50,68,75,63,43,77,76,158,142,130,157,153,128,149,145,135,140,70,79,69,73,41,169,389,217,235,208,300,319,310,186,187,391,393,368,178,199,385,307,322,398,380,395,365,163,386,171,176,379,361,161,387,372,364,376,182,374,396,370,191,177,193,196,164,192,166,197,190,184,394,363,375,373,296,377,382,185,167,162,180,390,183,369,371,160,367,399,168,219,165,366,173,378,189,198,170,195,346,359,332,172,174,87,286,293,354,341,154,308,283,397,288,312,313,280,301,289,292,297,302,303,287,315,294,295,317,316,318,384,290,80,245,194,285,304,314,124]
        d3.select("#draw_digits").on("change", () => contexts.forEach(c => c.redraw()))


        discrepancies_functions = {
            sum_squared_distances: (data_y, data_x) => {
                let result = [];
                let sresult = [];
                let n = data_y.length;
                for (let i = 0; i < n; ++i) {
                    let res = [0, 0];
                    let sres = [];
                    sresult.push(sres);
                    for (let j = 0; j < n; ++j) {
                        res[0] += (data_y[i][0] - data_y[j][0]) ** 2 + (data_y[i][1] - data_y[j][1]) ** 2
                        res[1] += (data_x[i][0] - data_x[j][0]) ** 2 + (data_x[i][1] - data_x[j][1]) ** 2
                        
                        sres.push([
                            Math.pow(data_y[i][0] - data_y[j][0], 2) + Math.pow(data_y[i][1] - data_y[j][1], 2),
                            Math.pow(data_x[i][0] - data_x[j][0], 2) + Math.pow(data_x[i][1] - data_x[j][1], 2),
                        ])
                    }

                    //res = res.map(d => Math.sqrt(d))
                    result.push(res.map(d => d/n))
                }
                //console.log(sresult)
                //return result
                return [result, sresult]
            },

            sum_euclidean_distances: (data_y, data_x) => {
                let result = [];
                let n = data_y.length;
                for (let i = 0; i < n; ++i) {
                    let res = [0, 0]
                        
                    for (let j = 0; j < n; ++j) {
                        res[0] += Math.sqrt((data_y[i][0] - data_y[j][0]) ** 2 + (data_y[i][1] - data_y[j][1]) ** 2)
                        res[1] += Math.sqrt((data_x[i][0] - data_x[j][0]) ** 2 + (data_x[i][1] - data_x[j][1]) ** 2)
                    }

                    result.push(res)
                }
                return result
            },

            centroid: (data_y, data_x) => {
                let result = [];
                let n = data_y.length;
                for (let i = 0; i < n; ++i) {
                    let res = [0, 0]

                    // centroid should be at origin    
                    res[0] += Math.sqrt((data_y[i][0]) ** 2 + (data_y[i][1]) ** 2)
                    res[1] += Math.sqrt((data_x[i][0]) ** 2 + (data_x[i][1]) ** 2)
                    
                    result.push(res)
                }
                return result
            }
        }

        let N = null;
        d3.csv("data/mnist.csv").then( d => {
            //let indizes = ["sepallength","sepalwidth","petallength","petalwidth"]
            let indizes = druid.linspace(0, 767)
            d.forEach(d => {
                let l = {"name": d.name, "class": d.class}
                let v = indizes.map(i => +d[i])
                labels.push(l)
                mnist.push(v)
                digits.full.push({})
                digits.bottom.push({})
                digits.top.push({})
                data.push(v)
                top_half.push(v.slice(0,384))
                bottom_half.push(v.slice(384,768))
            })

            mnist.forEach((digit, i) => {
                digit.selected = true;
                // full
                digits.full[i].selected = create_mnist_digit(i, true, 0, 28, 0, 28)
                digits.full[i].unselected = create_mnist_digit(i, false, 0, 28, 0, 28)
                // bottom
                digits.bottom[i].selected = create_mnist_digit(i, true, 0, 28, 14, 28)
                digits.bottom[i].unselected = create_mnist_digit(i, false, 0, 28, 14, 28)
                // top
                digits.top[i].selected = create_mnist_digit(i, true, 0, 28, 0, 14)
                digits.top[i].unselected = create_mnist_digit(i, false, 0, 28, 0, 14)
            })


            matrix_data = druid.Matrix.from(data)
            matrix_top = druid.Matrix.from(top_half)
            matrix_bottom = druid.Matrix.from(bottom_half)


            //dr_data = new DR(matrix_data, local_conn, min_dist).init().transform(max_iter).to2dArray
            //console.log(dr_data)
            /* iter=500 */dr_data = [[-0.7732350800286119,1.3859512443488338],[-0.5749207392010475,0.7257897596478455],[-0.9314263346469218,0.7742911515439473],[-0.943208247921256,1.1467744478330175],[-1.1092964825695693,1.1099974878824075],[-0.8062047998703626,1.2143283593265828],[-1.0548340589903817,1.1788426813368693],[-0.9619428332813305,1.258629741111797],[-0.9177855129508501,1.3570831253402853],[-1.1243062487679207,1.068577739480072],[-1.1845385008477742,0.8322542994709016],[-0.9325555564988669,1.267175039188469],[-1.0790756329976943,1.3679660425351408],[-0.8658885657957127,1.1673687502925933],[-1.1233643704875742,0.7499118688112827],[-0.3946540604923243,-0.0000738371331252701],[-0.9726832952494058,0.9080530535848049],[-0.9366242158386283,1.278540788114636],[-0.710332809217372,1.1789757636849647],[-0.6726403477489759,0.8240362442836018],[-1.0361910559731788,1.236497230727646],[-0.929038590004618,1.14905483633769],[-1.0914304979133067,0.8877723807062905],[-0.7149471687230906,0.9619759158187858],[-0.7850404201772923,1.1050559665012645],[-0.8060619876662143,1.1133822889713472],[-0.7155984693779913,1.2370327427972452],[-1.0322467307748604,0.7406462618938456],[-0.8614656702518712,1.3157376469902837],[-0.8632568525087377,0.9593444122349725],[-1.1112011468153513,1.195311269189307],[-0.42482348714235973,0.25124045835767667],[-1.089690395730184,1.346274474764105],[-0.6299682199223491,0.8105352522503443],[-0.7337058501287601,1.1398384846852825],[-1.1506557334272163,0.9423115013080615],[-1.0248218737536146,0.9219011148891956],[-1.0649768346212665,1.13903834608084],[-1.0515301301196152,1.3938092162382845],[-0.9920427647730461,1.1446452120942048],[-0.4835973319735303,-1.30789472300141],[-0.21396527194336465,-0.9598922318129351],[0.0073961344269922605,-0.8375318907666799],[-0.34827150289169867,-0.9419288529792407],[-0.4430725909620132,-1.3419581684201616],[-0.19864040168480412,-0.5724669113750482],[-0.41318079588881684,-1.218168754567616],[-0.3265639171702619,-1.2513852795187923],[-0.3447212631181833,-1.2198675320077002],[-0.12899466428760778,-0.7299009934644358],[-0.4055131077675467,-1.2044708341376367],[-0.10684417555158048,-0.5939822980860193],[-0.12187857839364351,-1.1030456342304324],[-0.2596867286118334,-1.3323072352829253],[-0.01613520353632666,-0.9129240835849668],[0.01398504426095294,-0.7681221903176252],[-0.07907874141334054,-1.0337848912224497],[-0.4506911958764692,-1.084241780320505],[-0.3423356018640465,-1.2738814173465276],[0.051349309991088256,-0.884633564930046],[-0.16424887028961466,-0.9204152582338211],[-0.346675288344303,-1.1153263889219307],[-0.05310292754404476,-0.822178232447004],[-0.4093323569371005,-1.0629567455373858],[-0.2077659793346388,-1.2978083055816707],[-0.11703040626683277,-0.5934021061992941],[0.03005817640174151,-0.875411250921218],[-0.2610944785533649,-1.3726222481466495],[-0.473070658277993,-1.267048909174046],[-0.35818004676927806,-0.9991815549202719],[-0.35030291793653523,-1.0366618288984994],[-0.4695728856266844,-1.3601844988054144],[0.13028421338475227,-0.7521893889598087],[-0.4170374881106095,-0.8433242041359273],[-0.14774718456775632,-0.9443568919627074],[-0.5250116355611719,-1.1436016918600251],[-0.22309184185743045,-1.2301377724585145],[-0.18397575851290837,-1.1835115702754821],[-0.4195210414977127,-1.3083725545253317],[-0.4346523386861449,-1.0961342759757178],[0.9883098131096976,-0.4693797301203017],[-0.4202107079753706,0.902312771189781],[-0.5061679644068504,0.14868662030265184],[0.13973207660184037,-0.48625997760729806],[-0.15139369848368034,-0.2625319496689482],[0.1245933954948509,-0.3340312942679993],[-0.5855209702401297,-0.3549577832862986],[0.6750954066112157,-0.3919478526950936],[-0.2860601267844204,-0.6859898905546981],[-0.35914143293644873,-0.46030825431781336],[-0.243746365099366,-0.36897891150863654],[0.05567894471383395,-0.0644969403370122],[-0.4845665397586978,-0.4336953378615692],[0.037078781279061064,-0.8679019110076541],[0.2118319042447974,-0.3542165362694142],[-0.11441793690481897,-0.4201999190986376],[-0.34460151747593626,-0.12502852872354686],[-0.2616465108755096,-1.1379388019871772],[-0.1957029473584261,-0.15947287694269296],[-0.3246105230272326,-0.4480109888205663],[-0.019817456491064735,-0.2975385776209154],[-0.6228999713078761,-0.4981134500071589],[-0.6659794614865724,-0.312019760660166],[-0.007247862889833761,-0.25719474150359656],[-0.3352368220788658,-0.4472944393033736],[0.35154454539544233,-0.5793937338913966],[-0.5217618214605493,0.271353031318146],[-0.4824240048427552,-0.2548129406307443],[-0.6018511830316079,-0.3093093165535902],[-0.047663101144455045,-1.0112249690863206],[-0.29879713280804876,-0.7416137597457289],[-0.6423803549421317,0.05615586600677951],[-0.6866736766293335,-0.24911147912142123],[-0.12362091818493087,-0.3659021383978033],[-0.18941818355466322,-0.535327830097576],[0.4145411840212339,-0.22867183542890432],[0.05618647154567406,-0.5038241546152217],[-0.459322411669438,-0.47672363426618275],[-0.8758382164988222,0.7692802515099868],[-0.5533879023734988,-0.25310565385811906],[-0.7786625045819132,0.1642992470558315],[-0.46246334139058226,-0.04553335155887458],[-1.0071811851708357,0.036412211682289995],[-1.2513781423491526,0.17578623630036436],[1.165893500890215,-0.4070446925977459],[-1.0937111988042771,-0.15345768803232873],[-1.0993273584793188,0.22383909250447218],[-0.9518514018466518,-0.10935074446047373],[-0.9677996328894966,-0.31325340446600847],[-0.6905619846473993,-0.1019810080582007],[-0.7293626888934471,-0.4167966363539459],[-0.9291631802504287,-0.10419854214340148],[-1.2140299303171511,0.14323402006091668],[-0.44268314907459017,-0.563891659113423],[-0.9684419156384703,0.03577680283137094],[-1.0807242392694218,-0.033681313045245236],[-0.8418929433763488,-0.0014209103188628672],[-0.08149476679586058,-0.5186529614237007],[-1.0611100437682257,0.030451038856890798],[-0.8297541513590868,-0.023989782105215043],[-0.7507826784115281,-0.32966081923545],[-0.659997879430658,-0.4419639563880409],[-0.16343897710950356,-0.8035380108411689],[-1.0396878546723012,0.06086524821677486],[-1.2298097529238585,0.08476675899208692],[-0.8604169852677201,-0.3083934581109269],[-1.1060274965813603,0.07187598246630411],[-0.8444901089065012,-0.08905015068634707],[-0.8835186284748043,-0.4230095819940438],[-0.8507648431693128,-0.38313192145307656],[-1.0995421037867543,0.16048975968623064],[-0.8710528169299862,-0.11486281865236674],[-1.0496287808279217,-0.028273039813788807],[-0.7362686413382092,-0.7141076126686489],[0.8304364345856221,-0.14370045766080367],[-1.1805593985748442,0.2667002533852278],[-0.7849873280242528,-0.07507646892625039],[-0.7657840189050547,-0.38683181543023337],[-0.3844782653002441,-0.766497738014363],[-0.8937973944450037,-0.11735427164540885],[1.0688892874288964,0.11304894561264858],[1.2752186509522465,0.39858280015463365],[0.9522794996344094,0.08568540130669383],[0.7483640416947368,0.05329634189251218],[1.3077377038837361,0.5033654165203612],[0.8751652891247141,-0.13562249725140102],[1.475528966449178,0.537649764944259],[0.9705575265509515,0.09197337018015664],[0.8448477601839068,0.1527378890549884],[0.06707739328530382,-0.6500524128712092],[1.50560344607281,0.5056072703010915],[0.9131637781080539,0.19971362719807664],[0.7118098091395262,-0.25860192928493936],[0.9997251038259045,0.07379454221442983],[0.8084805291380144,-0.3762134253396324],[-0.04574675010807911,-0.9693590797122872],[0.8704904486584095,0.33485304041173053],[1.3618643274329814,0.42255798423569446],[0.37989470707495526,-0.263183306693572],[0.03671946008418857,0.9376323167450982],[1.0193845033957454,0.20108956457234603],[0.460011091640291,0.14057953202905177],[1.083253198172183,0.452837546109064],[1.237034220618531,0.29287047401473953],[1.4269472842088196,0.5570490808511067],[0.7775460147388263,-0.030581077811321713],[0.5279922004840659,-0.11067819193886995],[0.7299126445349868,0.0005198330462882232],[-0.0007751335656308822,-0.9290303066648226],[1.3772253175261284,0.4639709098612706],[1.4310738026297458,0.5521283032389203],[1.2890696117754197,0.2575210942598785],[1.4755462014077532,0.3371245145377097],[1.3158033989813303,0.6070315463006901],[0.655851317209514,-0.18232702876901105],[1.3983691147758681,0.22587445998659275],[1.4501000274970588,0.4284156037059127],[1.4518357960289847,0.5579308690538802],[1.399067978463634,0.49718945676433896],[0.5132499874143663,-0.14302533295855221],[-0.6318928256238865,0.1356477857405258],[-0.24748039134100375,0.2720371719787342],[-0.8962638313333677,0.13086536765078946],[0.128325938231511,-0.42166183513999195],[-0.6202490901101424,0.2289288981794595],[-1.1291541928774287,0.4124048177442387],[-0.8034243566417215,0.25482334218355435],[-0.7313277557349291,0.13552634137189554],[-0.20676835596046475,0.24209548102967396],[-0.28164667722433256,0.2522449255599157],[-0.8625257126579442,0.2496571810768577],[-1.1198021110483034,0.6391975866299989],[-0.7046870345240923,0.2685138823700886],[-1.0863543034999523,0.30864827852243404],[0.30070178956490823,-0.6961364938831704],[0.07461676055501526,-0.5403318052410141],[-1.213354979271791,0.42431264914659894],[-0.22723948358674628,0.19712749906977406],[-0.8949815009022376,0.3564531505482956],[0.7150733283747185,0.36576361208629166],[-0.30125768788895524,0.2851326774338893],[0.1594046109581339,-0.8168956701220316],[-0.5837099199983308,0.1577579009440272],[-0.8157352610911461,0.25961800956187747],[-0.15127670034560314,0.27409082831345294],[-0.5613040442699858,0.15518280242159205],[-0.25512200687136694,0.16155042688788113],[-1.024374523720568,0.3279848104609298],[-0.31103645340004765,-1.0325846553545985],[0.010443436317936016,0.10416998296797204],[0.0307040357890725,-0.6803288273457266],[-1.0266480077440434,0.3691947803685282],[-0.3779497943945381,0.2021402189842165],[-0.6091418353213263,-0.24152455764101982],[0.1635238465869172,-0.5668943162438272],[-0.16667640502801565,0.25840248196182886],[0.11319422072675643,-0.8686576193833421],[-1.177235508643917,0.36011599614814177],[-1.1741181857555567,0.32885422020017946],[-0.5949736247833015,0.3192091731071847],[-0.057476890168844455,0.7719054963580897],[-0.36623320529218395,1.0186601403307656],[-0.018302422587553165,0.754162549081667],[-0.12912736299670907,0.9340679293007782],[-0.20046319186377598,0.7550437893589644],[0.27161114987025625,0.0881551404151622],[0.051352610822144075,1.021891925990658],[-0.15929628639445445,0.8396130917810555],[-0.45799509347706363,0.8264175526715143],[-0.16406304280369002,0.5310009499726538],[-0.3134895489658971,0.9892762561945797],[-0.4341651488582147,0.36779386086098265],[-0.3589851487739455,0.47990264721775683],[0.06182197972297583,0.8048879516768722],[-0.19604352590335997,0.6545148057819451],[-0.10462616199943499,0.8215745328729918],[-0.35004702273139526,1.1460185341736502],[-0.2553682658730265,0.9739084085054656],[-0.518500874293287,0.6435349726894057],[-0.0760018771329406,0.7231029991729659],[-0.1554859362588321,1.0265713217085315],[-0.23542537582440715,0.9245692897709454],[-0.20181395993766213,0.1366962141889005],[-0.26533112903770717,0.8716069465018786],[0.13076552823186993,0.7838929518827625],[-0.25770505276888406,0.8527280132964331],[0.004540097462803312,1.0036913131471985],[-0.3882464952908233,0.39722330817937584],[-0.17393818361035837,0.5126646530480827],[0.23022573518944348,0.8932570313694719],[0.2100810573942647,1.0023155205781953],[-0.14901550502433525,0.9236792548845091],[-0.053227230359747066,1.1386058112100315],[-0.2625477677446508,0.12069623946575761],[-0.2605089925908177,0.9643852785096003],[-0.3343178245800193,0.9608173368786302],[-0.2565383049039085,0.5048281906023512],[0.21934587476081563,0.836414490389882],[0.10700559022936784,0.6999290532885746],[0.03417549234714835,0.9880293686611026],[1.352107943165881,-0.3489269068676427],[0.6988976549036988,-0.8245567609409277],[0.6239441050635396,-0.7461165128319112],[1.1066999735346428,-0.307108541825565],[0.7030910716755963,-0.6045108763359371],[1.2198515168591109,-0.6255358369951209],[0.730123003097165,-0.3530871066633249],[0.9743636163319451,-0.6538006585150751],[1.3818529037458431,-0.034403927822985736],[1.3781535760304087,-0.2927111280861759],[0.5949844959180749,-0.6137961273822092],[0.698635313201725,-0.8746742579100719],[1.147388775812006,-0.5047218808955001],[0.883776603502238,-0.4450381239907376],[0.8837364786430764,-0.6588512671601006],[0.7085875459924501,-0.751307174140978],[1.247271800839508,0.02679137995654963],[1.0886284071774393,-0.6504184945570688],[0.22921130046926755,-0.636487689130443],[0.30578190132026506,-0.8960518082812651],[0.8939612595695162,-0.6367605749098657],[1.3507087003511118,-0.3042984258642145],[0.9386061525698866,-0.7337631554807633],[0.8921657451451733,-0.6913642928505308],[1.2388049179737504,-0.6064611516423399],[0.7694010641567456,-0.6938066262152359],[0.4262356039001431,-1.0426629569484265],[0.6812069925452889,-0.09237622328781342],[1.1342096483817306,-0.38529228743620736],[0.7742079932948859,-0.6482856585174219],[1.003043707571152,-0.28878353807537793],[0.6734805512121278,-0.7638779859504241],[1.3284916580953463,-0.11713045160183941],[1.343756085662432,-0.16521115582037138],[1.1861311600474782,-0.5942421789433016],[1.0389646138683954,-0.7038492024613706],[0.7174726462071854,-0.7465607993112572],[0.7684833016898178,-0.7441615432110622],[0.6102962442823969,-0.6878349310818296],[0.9575698854951314,-0.34690823411712884],[0.07361378535355544,0.05675938347696483],[-0.5651845100647445,0.8266231662747424],[0.7014578416209022,0.41563465906308905],[-0.09401339192322224,-0.21117754607731662],[-0.9467579961934206,0.6058427064450703],[-0.8282906931771898,0.4521639599966216],[-0.5842223862677135,0.7424484763920207],[-0.41020835021510693,0.05981705948558128],[0.19029123579755464,-0.14213769319579653],[-0.30363644546396446,-0.6273907309130728],[0.4487149988589254,-0.40222576308010083],[0.06598440953691523,-0.5986135806830117],[0.6190864878510558,-0.11022381757775696],[-0.527555781043361,0.14534326032318498],[-0.21633343485195317,-0.027104632125566748],[-0.5198884713981401,0.06410720938387834],[-0.4497642857343792,0.04655331594258238],[-0.25363648226065866,-0.01964516939953401],[-0.02227510748073419,0.10298037545735174],[0.05757962710860536,0.02843522546565672],[-0.45056177561664273,-0.03319824360227357],[0.33883034085409836,0.11727181687298838],[-0.0758788487812919,0.0028732682065187357],[-0.058728670078548866,0.05118192264396124],[0.031592938201711065,0.1670335019753415],[-0.18294032396114043,-0.11111118159897922],[0.8913621842966959,0.07417482806619405],[-0.4052600808460641,-0.09321479517049037],[0.3501106694443511,0.0751986618915859],[0.01046120268951686,-0.07534206754736446],[0.2692019805340712,-0.4500149893711759],[0.2783092192279872,-0.14808985684315196],[0.0837841090252011,0.10749503773856034],[0.3620389801620439,-0.2711238278268982],[0.24334848573471357,0.016814135280425076],[0.03957488370063273,-0.04454337476551635],[-0.04168579761582439,-0.2745914643428193],[-0.1548788030457366,0.026770101484972306],[-0.037684030090270645,0.22476207319700348],[0.6642301613644831,-0.02915869076112948],[0.3099259169252368,-1.004321444062975],[1.111453348500743,0.3436360469282506],[-0.039621010967019026,0.27417144146046907],[1.3249385030142538,0.13709584397777033],[1.1819835974014103,0.25124866390264844],[0.9399591831869354,0.30346640603318675],[1.0776244513377349,-0.1415550682005337],[0.9557313236596396,0.11884224805030724],[0.6999251116534773,-0.16123972142605697],[1.1304746217256392,0.21444191873026966],[1.226279107189213,0.1893678593088754],[1.107799600129399,0.12837381085961327],[1.1239182912437222,0.44065908249390107],[1.2242712942328757,0.052068033455671986],[1.2818333514980123,0.3023935086980482],[1.2799025678470701,0.07717180609651327],[1.0022740765904354,0.3910994669123695],[1.1156127654477952,0.3103555644047538],[1.0929177776509187,0.002201862769642753],[0.6788117376645099,0.3971020089352117],[1.1000217532950503,0.45789111058384246],[0.3295284395433684,-0.5834496657452446],[0.816091515568737,-0.08505875545999148],[0.3013995627099126,-0.7412051553494241],[0.47852937598746537,-0.6687271899851699],[0.6488019099851957,0.01885835495406333],[0.9283575815562561,0.09221917790597653],[1.3158865144559897,0.22159818852573962],[0.5881922704692619,-0.6794823868253334],[0.29543457269975126,-0.5615233656016378],[1.2910827412997758,0.2881212488834903],[0.8761003677508545,-0.034647493507852595],[0.7623010077481276,-0.60682988141277],[0.7606006112810102,-0.13911075611227644],[1.2766754838635008,0.2037986042542939],[0.9512169874174496,0.45721043954374085],[1.3958453967150306,0.17144851982309936],[1.0455353627378574,0.21821039889286828],[0.9524057278379771,0.45021545620152026],[0.751957005104832,0.22110933743739514]]
            
            //dr_top = new DR(matrix_top, local_conn, min_dist).init().transform(max_iter).to2dArray
            //console.log(dr_top)
            /* iter=500 */dr_top = [[1.1019501387434019,0.592638076166488],[1.081293036480225,-0.054332637408004036],[-0.06235412193216778,0.4553356851951174],[1.2838427769956218,0.11276112381039581],[0.3469044569386684,0.28331627722738534],[1.3141653490095175,0.3531746778988545],[1.323552336323728,0.412263180901344],[1.0554136750992997,-0.04558476139406609],[1.1903486280274542,0.6082818417194442],[0.7978332515415919,0.41149604282334856],[0.15674316972658137,0.5420870715334829],[1.2000477967522956,0.23550154966215048],[1.2097648761589808,0.5220196383743273],[1.2431469093770329,0.15602276129204085],[-0.5951043385836251,0.3026996486996359],[0.7695115268947629,-0.8642614996726365],[0.46802664389185183,0.6802368583346067],[1.3115184343627688,0.34604075154653924],[1.3000799799440959,0.25107820477554393],[1.1263672309335933,-0.22659231335729063],[1.2501741285795174,0.5082445802359533],[1.3668571029046244,0.14257338087208046],[0.2682208573831793,0.5090103883611479],[1.2692875443100387,-0.026295910635540903],[1.3313964272384224,0.06857946087903655],[1.301362842673457,0.26547425365386934],[1.0941944247108477,0.4543464686454497],[-0.3937399955288496,0.5690924343564657],[0.9335571749162237,0.6686734954624353],[0.5722900208402373,0.6821812748739862],[0.9201658660632743,0.43532333043092164],[0.6241310361861054,-0.5668698474668117],[0.9746213454462664,0.7693486053285534],[0.3798664976237176,0.8804588594378945],[1.3204084623583532,0.09431584215771285],[0.11517454246838638,0.44416251242249544],[0.1718274950310621,0.24954692643773205],[1.209981200052571,0.21902086784241775],[1.166442515447425,0.7449742895648219],[0.2695435001108981,0.401566228901915],[-1.5413074909793427,-0.964110430762182],[-1.4454974877248377,-0.7811466420867639],[-0.4923583436046865,-0.831432018902137],[-1.2679379606339218,-0.8774899487150616],[-1.2495805012908259,-1.257946726913008],[-0.42373314753713176,-0.8565693122007118],[-1.1128968013547333,-1.3160786768051635],[-1.3092637720142708,-0.997231823979968],[-1.0724250681985048,-1.239322055186169],[-0.509790896788646,-0.8946334191078156],[-1.088075050010844,-1.234949832592621],[-0.3853964586199092,-0.6512368959754274],[-1.0266829142016114,-1.3064630376952004],[-1.0803985457086989,-1.213691574297351],[-0.6257790312252342,-0.8286707835090833],[-0.5961858879236226,-0.9880346103672403],[-0.8764142984497274,-1.2090388102721032],[-1.4602133304071132,-0.9056506387622415],[-0.999938421136647,-1.1928951276992965],[-0.5163330589650975,-0.8076272730407041],[-1.2142020293629356,-1.2025223033568586],[-1.0142748524102627,-1.1779528917543596],[-0.4706997177148849,-0.7934679013223341],[-0.9855998524719856,-1.277829196608972],[-1.0303130211125406,-1.0581168719366705],[-0.4793507007880843,-0.6049520733164685],[-0.4852501695704844,-0.7299839302685001],[-1.2650471576772957,-1.0520738536231842],[-1.4159123365128403,-0.9129922045612517],[-1.431829002738215,-0.9990533915186127],[-1.556498308894668,-0.8772940639199027],[-1.375480088616103,-1.0852075269947479],[-0.3970632431905501,-0.7427019618294],[-1.4373812944572315,-0.8991043089626246],[-1.0955575557640351,-1.1115720743088617],[-1.5646395602071348,-0.8719561836115653],[-0.8486756898646937,-1.1913580551042773],[-0.9063075955660918,-1.1506667971346953],[-1.2496773446001104,-1.272876027845749],[-1.5326151002022366,-0.7955682463212133],[-0.07801314769280404,1.211334596431847],[0.5781559468163006,0.9743260974360343],[-0.8125202780540357,0.14793564434033973],[-0.41071238752406375,-0.4725780599357411],[-0.43238976533131007,0.03445179155670073],[-0.9601935193186358,-0.0011747659043798986],[-0.6375395964902072,-0.5838371249825983],[-0.45974640207142825,0.5035111334360197],[-0.994534719537441,-1.0891195636308273],[-0.6760638204227755,-0.36272096806381765],[-0.8381329874276169,-0.22444566937796856],[-0.25654164852208167,0.10601819225230098],[-0.5706003020259494,-0.5510763898411543],[-0.5827686311358016,-0.27289231970769723],[-0.37495462891674025,0.5831074173423468],[-0.4850885572166085,-0.12727782317089076],[-0.09606854317263727,0.17952985928430967],[-1.151774659387162,-1.3016038071131193],[-0.40169094299367697,0.1350471038782034],[-0.6146509228220974,-0.2951638095236542],[-0.281958474694863,0.341611400562822],[-0.8965836396427025,-1.008940274610707],[-1.1019552123908378,-1.0578494471225013],[-0.36267310847723905,-0.07990637292943009],[-0.6689505174089774,-0.4557194258231597],[-0.495437892631506,0.3041117394785321],[-0.06348459646564567,0.22214730070170619],[-0.3817284677019894,-0.26653763918490425],[-0.9059691078220734,-0.20778143325787524],[-0.5374085420682012,-0.8251449223575773],[-1.130207970691351,-0.5409385871427477],[-0.3570545809260909,0.06312061527158042],[-0.5477203663684486,-0.33547513687283503],[-0.7264969781217485,-0.15746149043226987],[-0.5395271254937359,-0.5981227106524594],[0.8439571328183194,0.8224248905644669],[-0.9828915310691281,-0.02597535263894489],[-0.8181245040422273,-0.44866438159212324],[-0.6111250506696043,-0.07140547031218418],[-0.28120909671055105,0.1484320734049668],[-0.736810541119875,-0.1327713541253083],[-0.7655978172107947,0.2176537334165308],[-0.9199709392854762,-0.06724969830543746],[-1.0364338105860742,-0.16322984078470593],[-0.28396114731560856,1.39015574041739],[-1.1971898950316953,-0.20026688435455028],[-0.15424135225463262,0.004524635392239552],[-1.0634239260674652,-0.8549702117095285],[-1.150767429884001,0.014827307735526124],[-0.7498329449893125,-0.3102525247481823],[-0.9698718055461046,-0.7596540029564733],[-1.1125391092751742,-0.6817142887794573],[-0.9150862999847559,-0.46165330268503263],[-1.484847166687451,-0.6842623784848281],[-0.7787464598480074,-0.40528674179002266],[-1.1409082102202195,-0.5115848687121187],[-1.112023126479252,-0.23456615216884727],[-0.5229620003535775,-0.016304189905738745],[-1.1591089614708843,-0.37444569970370956],[-0.4572837207144999,-0.17722472170120607],[-0.7155998636949904,-0.5684989361279927],[-1.1697270979669063,-1.1555485862850123],[-1.389142910709148,-0.7402782972348243],[-0.7635701506259328,-0.6880109083575019],[-1.007091696684553,0.2419181836341088],[-0.9887252131707069,0.054712869493927035],[-1.1703208384535218,-0.183855719175833],[-1.0238522616381736,-0.11420250634130227],[-1.2373027509173973,-1.0217973218260528],[-0.7348067719769703,-0.04447688856188875],[-0.7849856412428848,-0.5766242669186632],[-0.7345411434822059,-0.28196968667761835],[-1.1133390981853402,0.012957046501900993],[-1.3767272845348753,-0.7104699984194465],[-0.32797996894672676,0.6978764488216105],[0.018895123548002324,-0.6381583844731198],[-0.4767033097490491,-0.18405360114702907],[-0.8100542532441193,-0.41066066819496333],[-0.8853541006937775,-0.23279318111546354],[-0.8763120663043675,-0.7487979035207238],[0.3382063600963107,0.4548044691981177],[0.7307526941580496,0.3358087455154275],[0.15303831658455858,0.37033012644424407],[0.6568753811243229,-0.3996837757134767],[0.60797612963702,0.46499551464754024],[0.33402580047250835,0.42420162305572373],[0.36212674687278784,0.5900215537344389],[0.701261948067374,0.0237885790128511],[0.38055906306175896,0.16685273779489104],[-0.1597313725836839,-1.0874022590208567],[0.45365203684478655,0.5227514506239382],[0.4824574172320848,0.08272732109180309],[0.822432385055051,0.43475277221565767],[0.46178247121798305,0.4656441749175268],[-0.016927770978279084,0.5037401821136729],[-0.37166855883079086,-1.1580942326767265],[0.11021151739176753,0.17151947814472507],[0.865504076209424,0.1991475988629125],[0.4145907066962501,-0.6140923858161028],[0.5762329934058886,-0.006573304715919465],[0.33221369483687263,0.32366919720363635],[1.1582267500390102,-0.3750187676784348],[0.1268043621508952,0.6027545496768344],[0.35031857388058496,0.597381249069266],[0.5699728682514453,0.35895203590445746],[0.6672951884921221,-0.10742475127745299],[0.9123152932909534,-0.52123377557142],[0.77264540206253,-0.14005004474793148],[-0.5637114637012428,-1.2013870231726473],[0.5126532196363661,0.5771788304314671],[0.5088259918405571,0.5739556397033856],[0.10098171302865797,0.629672930937003],[0.3841822946393263,0.42759013631880316],[0.3311785774692239,0.44975893454735205],[0.2181363026746282,0.22411658201957113],[0.410706010444254,0.7603651723178911],[0.46615155754780213,0.4807069101325156],[0.6277404485494544,0.5300437387787145],[0.5197237851900449,0.5178720637404163],[0.11249139267560296,-0.668202572792377],[0.6203198088722092,0.15460471433479134],[0.8206212550954282,-0.34434872627035173],[0.32490028049476205,-0.4148938295296461],[0.5819321018724223,-0.46634798834333246],[0.7284484796995795,-0.34221493219769095],[-0.009732160471835873,-0.025410962629235444],[0.02687430506576824,0.09942872496140631],[0.32781831210768964,-0.6611153375636535],[0.89336773198475,-0.2591554182226622],[0.7656484699029847,0.2885858835504913],[0.3939331344355127,-0.4424545178402648],[0.15558990572695702,-0.1417220651935665],[0.17173662469951154,-0.15724613533654774],[0.13070135067735528,-0.12036065326029308],[0.6439474005853658,-0.4936880569815745],[-0.138530985026283,-0.6711953566303867],[0.026962014887619092,-0.032489264711368544],[0.693512244680244,-0.7444678619438166],[0.27464392816077804,-0.3354283084578752],[0.7457549595445389,0.16563847663814485],[0.865384995155988,-0.6365129889763032],[0.5429305976220717,-0.4270189343564408],[0.6039675295531649,-0.7511578610232874],[-0.017649924342927392,-0.1989962790903348],[0.7947036332251666,-0.19380591841682965],[0.5579033205920957,-0.6636145530810372],[0.7366298783336888,-0.4688582326133859],[-0.1450326840063101,0.15784443868454867],[-0.8090500086248462,-1.1251303686558516],[-0.03844059427286818,0.15314784043572519],[0.5164014200849191,-0.687806595025861],[-0.14572361095116323,0.07363012189312831],[0.9137289493559257,-0.1774497477852493],[-1.0310024174254842,-1.2623448413744547],[0.10083737901609535,-0.31841382540106644],[0.8642132609884431,-0.17524901989281175],[0.23488142659059466,-0.5995230696787469],[-0.06068602014795056,-0.06044356490330149],[-0.03212400844930573,-0.1438797597724051],[0.6342141868802026,-0.21371910069428623],[1.1630396040092257,-0.555613340740435],[0.8378425968500954,-0.4976086083524167],[0.30004337368821327,0.035593326390828024],[1.0819619406913226,-0.49070601256965923],[0.20796581258457708,0.24575922143425089],[-0.06793407526724901,-0.10735192673173528],[0.4003407887422756,0.0848211503642354],[1.0302034382201182,-0.6333523396879768],[0.2808274513712851,-0.11299016454432387],[0.7879254384029034,-0.8671911719109952],[1.2064994857813915,-0.5437269931375114],[0.6802329238065558,-0.922962319877629],[0.5358237593317907,-1.0249365159777084],[0.40156171537037955,-0.001756874960872748],[0.9522749831335555,-0.6596601894448871],[1.0406771659087206,-0.6191501128421066],[0.5437383748960257,0.6079494431055603],[1.0640506202199314,-0.5698118742181726],[0.8836408048370167,-0.7861115963749685],[0.31010233439455304,-0.09526917636974568],[1.1774455814796865,-0.5620528623800044],[0.8442005557070835,-0.65057499120811],[0.36597488621313823,-0.8376119509523292],[0.806819765575232,-0.841545982414031],[0.23184630179639018,0.1518477722188536],[0.7277828613614119,-0.3836835876412966],[0.5347435024780699,0.042264850206956285],[0.5676704010015523,-0.9518106379048191],[0.6942632046790507,-0.8133479898306623],[0.3158575792335882,-0.026725413624109295],[0.4414697658512587,-0.03134460733223354],[0.37778329434134783,-0.006356846321710276],[0.07502807716423397,0.13006495142844765],[0.33528866915114497,-0.998662339677945],[0.33697334618503316,0.2703965370214248],[0.7687552898532749,-0.8858337769318775],[0.6822626367968123,-0.9950732686981665],[0.37519800033949136,-0.0278517299908383],[0.3001843232909823,-0.2938366041754253],[0.315304482482578,0.058157901786517086],[-0.1399179173803749,1.4975292916980887],[-0.2296935929202065,0.84936382029138],[-0.5303926576881518,0.5156761389210777],[-0.5595998033034477,0.9716701653982798],[0.14181650983761662,1.2638027626933062],[-0.10240994446530856,1.4974371632629402],[0.2207473367747281,0.06834278357107944],[-0.0696520119472566,1.1899172001616931],[0.18962895691600623,1.135731573644211],[-0.24044710256977203,1.4716225736295168],[0.2559863755537635,1.2316988775968358],[-0.15189132608191583,1.009462180335181],[-0.2831105497259389,1.1506585402153306],[-0.601973319775113,0.6401972977255038],[0.021523916609438754,1.3567562737366576],[0.3619310095176145,1.0562288879701718],[0.032776932178912754,0.9865237972745016],[-0.14565222729545338,1.1553833004992002],[-0.5216871858691994,-0.206545386733778],[-0.7201993535947487,0.4413347737637491],[-0.7238262215912689,0.7684191770931726],[-0.1507730519280413,1.4215058501628797],[-0.37071327293073253,1.0908770321313175],[-0.22615774560560473,1.0471289368842651],[-0.16957299759396566,1.5213899225802217],[-0.43306588075894603,0.838147703405803],[-0.9346965981961042,0.40423203215413606],[-0.3950631304164669,-0.5855519014409233],[-0.5523672213480357,0.9216375763975149],[-0.5521050706529389,0.5612438927828486],[0.10910125638497473,1.4457777120576925],[-0.6491517014322329,0.7798296627673585],[0.13193809885292224,1.203743451183807],[-0.052273307877991254,1.320747047778485],[-0.3519437466810428,1.2351618509449347],[0.0398894256755109,1.4649989524336844],[-0.02569634797677059,1.2698094632921406],[0.10939553134347052,1.5044628771280832],[0.28578621086830475,1.3026813732166729],[-0.6206871646074212,0.9651896412538565],[-0.005470985955963861,0.40578152008140567],[0.739868268180454,-0.04612123645388619],[-0.35785429752370934,0.2069797686427014],[-0.06542360052844776,0.05663463260932283],[0.005922548286263641,-0.03797825424631714],[0.017853770812898732,0.20019352903538123],[-0.04289678740647581,-0.09785117349605044],[-0.3156357582256434,-0.20176673154557756],[0.946622155834019,-0.11894990734929459],[-1.0908214873855042,-1.0113142902441439],[0.9773885722955845,0.031863656269739374],[0.4798811622505198,-0.6568594143126764],[0.4186644216745671,1.2082628028083104],[0.05695510150019277,-0.22864458835035154],[0.015004889974113133,0.045769008804377835],[-0.44308731667712864,-0.4052478237917707],[-0.14532692069646636,-0.2610944755617226],[-0.19828473301663607,-0.17924733705519535],[0.8869778280986597,-0.2589694560973333],[-0.1762067165249603,0.4978039460953766],[-0.387896537712304,-0.29340249537146923],[0.6659725576262107,0.7231545227652472],[0.18534616808057852,-0.36565055621960496],[0.10026381520119126,0.310184610482325],[1.179850782261485,0.2529786595851965],[-0.4137270586669075,0.010698756723269295],[0.45277705166541826,0.9477802170710667],[-0.233586923656602,-0.32129934054624787],[-0.09718966148388153,0.30998264470457976],[-0.17055374856524955,0.17728544520953154],[-0.0614240129574301,-0.17919979769967342],[1.0614998001664353,0.05692219261570075],[0.2032331947557922,0.7958178250825232],[1.0574681202833287,-0.09420579880055807],[0.8027490074032404,0.20243258529007402],[0.19585938998032973,0.03474754091032996],[0.6370294276617834,-0.4873359223101498],[-0.3798181392677911,-0.13811890393907705],[0.689567018950616,0.46283472465988773],[0.7184921121016298,0.8103138474767997],[-0.9878975166845979,-0.24218816979533],[0.6553283878351281,0.7597203637078407],[0.0297934320562918,0.6316233174043806],[0.36685739928625904,1.0730910664678044],[0.12666395448744214,0.9604342280257401],[-0.3118771839112055,0.56373908676374],[0.051309237591500106,0.8596265012510529],[0.6162169240799337,0.9644978099403476],[0.7738932377470604,-0.1769003986169198],[0.5253342896302706,1.07862060892855],[0.28285468553285276,0.9481776584446748],[0.42699072070180527,0.9044473089181079],[0.506232051158078,0.924758244508705],[0.22942672064954317,0.8386106169695161],[0.5016359931573251,1.011324516336212],[0.34986100704888035,0.9170812689698176],[-0.06541659628160332,1.1189228194057599],[0.1054953557322029,0.9792233181627834],[0.40271549105848575,0.6720170571929314],[0.048969389134939256,0.7430317367033572],[0.2858865022237434,1.0732853453339302],[0.7205830807722239,-0.3714559079443971],[-0.2395476421958319,0.41944804546575865],[0.4615927070272248,-0.522762238114881],[0.5634329763918133,-0.08812676478263112],[0.03475853431397167,0.05362216685584965],[0.8387916984728614,0.10261086674350435],[0.4551753035361042,1.0352044455647498],[0.6699928225173686,0.20556462405591536],[-0.48156380809663935,0.1031518814385644],[0.5385350354956431,0.8408407481627836],[0.7557357770192934,0.42200219964684044],[0.5783568608149783,0.7048342783855404],[0.8923294123107923,0.06279498036369502],[0.14656487212387256,0.8969857796415843],[0.07133482458068498,0.8049030201399866],[0.19519650435401797,0.9621824175915783],[-0.14372085915109448,0.7792937556703281],[-0.15041661026323436,0.9916529105229569],[-0.2866709483923392,0.5692891288242202]]
            
            //dr_bottom = new DR(matrix_bottom, local_conn, min_dist).init().transform(max_iter).to2dArray
            //console.log(dr_bottom)
            /* iter=500 */dr_bottom = [[-0.441318141304885,1.1461390074046804],[-0.15689154498018448,0.8234439794475622],[-0.05335248179295671,1.3265967459485544],[-0.31271420392765675,1.1349339066394368],[-0.32827549011342294,1.4720918292382392],[-0.34151288847125294,1.0619114232687263],[-0.09615216007974722,1.542238632499186],[-0.3452971237624297,1.4806903182530897],[-0.4931805297352415,1.3602744559374915],[-0.1938063290763926,1.4763370801290976],[-0.09049907437751145,1.5569406712787393],[-0.370786425585675,1.1763428862039578],[-0.6139269807224602,1.2603195393079674],[-0.222861029384152,1.306321140625434],[-0.13645314559653085,1.577840336009239],[-0.2470583501119304,0.48176449805559207],[-0.568060871500166,1.1314813580198684],[-0.24117803922801057,1.3053291895521264],[-0.24962993683852813,1.0184421997939925],[-0.15440565824206842,1.016307051025596],[-0.4855773670853795,1.3581947536211094],[-0.1370715904168101,1.4797044629375613],[-0.1885860875152246,1.4952579066315035],[-0.10392361283596044,1.120285516574774],[-0.24032249360838145,1.2059898489710787],[-0.1671486615483681,1.1036008519705587],[-0.31371918123882697,0.8380795716995613],[-0.1334312533787591,1.4713188999085445],[-0.367533453298809,1.266803618110474],[-0.635326300649891,0.9506834291102699],[-0.4347683128197119,1.4735879225381319],[-0.02557907953286756,0.4379827323474569],[-0.22083178484575117,1.5799454284479921],[-0.6280992331854343,1.0253576475861776],[-0.32229439798032333,1.115264296723346],[-0.2801689087503578,1.5186075258075875],[-0.3145243292971229,1.5321249180969088],[-0.1836969212331312,1.5739638626939239],[-0.5129161343062191,1.4325799063646785],[-0.585143449035528,1.3121985443027946],[-0.32850607466322657,-0.7892996278446557],[0.582552963401084,-0.7243261860329493],[-0.7108318900906717,-0.42121247499493786],[-0.37630191608491853,-0.8797005742373042],[-0.5262031540389133,-0.952367296292525],[-0.5451407328456934,-0.14603196891133696],[-0.405212346319302,-0.9524465389863136],[-0.5614056446998688,-0.7637499452552843],[-0.3722690599206038,-0.9642418458663803],[-0.7789619054017376,-0.22165574698352425],[-0.3091034597096718,-1.0729262108097568],[-0.6499308097906913,-0.2558408414148927],[-0.7653121741630871,-0.5603760501845086],[-0.6066355365977185,-0.8526561187375115],[-0.8330693611959364,-0.521973989282287],[-0.7385822871418589,-0.210785509270845],[-0.8527818868746688,-0.46722044647620214],[-0.3480499765523648,-0.9475024600926966],[-0.26606619766272,-0.9533712466271074],[-0.8134622075234682,-0.4135295735019295],[-0.6266910043619672,-0.5913444846138436],[-0.19104517202543853,-0.9502852741541871],[-0.8614101499423068,-0.4609168966363751],[-0.4634833764619414,-0.9725914141130387],[-0.7126222107671152,-0.7981505496690222],[-0.7548442499358375,-0.17351735815563274],[-0.8929220639507371,-0.3704194539333461],[-0.6681146593252332,-0.7013213084211618],[-0.4686862344547741,-1.06495713312366],[0.3385011707206826,-0.8568216668371286],[0.4558579596021959,-0.6875131352672088],[-0.5439358990406101,-0.9828381718764232],[-0.5989728369287888,-0.4136328181458773],[0.4190610442435237,-0.6428706760510107],[-0.6850569273780791,-0.47960403065051765],[-0.4151454580562397,-0.9872166871059246],[-0.5447874256606557,-0.988199185120477],[-0.3999228143505318,-1.0254756337909805],[-0.5769581016613712,-0.8996679516350755],[0.5320132530336863,-0.723429087279914],[-0.6285700930778202,-0.1440616306134531],[-0.4064586900373662,0.77589274086038],[-0.09084145000457809,0.9332680563518169],[-0.4363108881994023,-0.26578329030461667],[-0.4907685985000793,0.02266561655178423],[-0.3227691424179754,0.07996256095259299],[-0.41865801237566136,0.5679664404521793],[-0.0853380083638188,-0.7925809636832495],[-0.797141086782356,0.07919706531922849],[-0.5002124559527803,0.21072071221523903],[-0.34163274489750245,0.029104068678084294],[-0.23920767564030518,-0.07336102744017738],[-0.5091178159909222,0.46471054862637234],[-0.3891461930082691,-0.10957392819736733],[-0.2185234662779143,-0.25997206829515995],[-0.44892854277084326,-0.127430119272967],[-0.3899977598613264,0.10718798117127727],[-0.48985442562361553,-0.037690970095605555],[-0.4414323974593726,0.2523104392389105],[-0.7265327549029992,0.1767114874711882],[-0.5020880170544323,-0.09833230503030321],[-0.633106253729841,0.5321966242835627],[-0.4223392120900715,0.7408749929333518],[-0.535531941998829,0.09312068684785638],[-0.7162495016204395,0.17232654807258227],[-0.7864094628625306,-0.3802778750072256],[-0.11772645218520923,0.5357350818845698],[-0.6095517586288005,0.5549260203123825],[-0.6210565347538778,0.33144683288469284],[-0.20388216076937282,-0.5469153036717973],[-0.38972655234011877,-0.38557138159914206],[0.0032295237950006606,0.6927606621686272],[-0.32748318838309654,0.7503823153298813],[-0.488554742801497,-0.05875718282799677],[-0.5561428679263882,-0.059414224094234955],[-0.41569029355687476,-0.11493687742954514],[-0.3006933907152891,-0.11967977011739471],[-0.7113224094678513,0.2958712846658394],[-0.23093655392700574,1.2553454523754686],[-0.24809408207766126,0.4470056963418151],[-0.07703576521208647,0.802284976613569],[0.2962686642864004,0.8723636853830647],[0.5589142786188663,0.7641073213476992],[-0.058659574881984616,1.4024449369012792],[0.06606162489967296,0.806478686779768],[0.39055065344017403,0.7811301217847874],[0.1732368282778535,1.3145892457188804],[-0.22808348832610542,1.262362213470986],[0.09486352972110561,0.24481863548507646],[0.39322874142341924,0.6680565910168619],[0.2465799296711834,-0.13507168127138858],[0.2689378857320781,0.761268927235553],[0.06565800200074288,1.3263903222638531],[-0.6486799098050243,0.8958804851682844],[0.27909633757922025,0.968388012306581],[0.39265429805440955,0.5888743634263796],[0.01940245256252046,1.159097661938786],[-0.3454494901677623,-0.24932221215527092],[0.5083937281455096,0.8576654766525964],[0.22119927240865783,0.8800057457476831],[0.16367299685033013,-0.33641656892849264],[-0.1878690432498107,0.38385092953223804],[0.07803266578523577,-0.5126452887773926],[-0.03985784526492911,1.3155757580482688],[-0.02485370102346174,1.3209702827315344],[0.0872476091826321,0.3988149296797553],[0.3389925236529463,1.097535829758253],[0.40773262581517966,0.5248588893787226],[0.3360298565213501,0.8197252695771376],[0.040276835095303984,0.24733388309813875],[-0.010992430594432223,1.4850751294460354],[0.25209601988938013,0.7967126592562419],[0.4176227218275934,0.8241169364018006],[-0.11948079953649658,0.03556655464769899],[0.5655908190861166,-0.544154355321664],[0.1316821475882475,1.396620328319553],[0.20518941618987127,0.6386483598517025],[0.2667179998906673,0.05259454080518329],[-0.1998947383041087,-0.5514189863444491],[0.33600058144423084,0.7375355488848909],[0.39433998631253453,-1.134231485330731],[1.1040050230755694,-1.176157454038636],[0.6446889331283707,-1.0116538403086468],[0.625394903075731,-1.1573965452298784],[1.0678344826060688,-1.0822197506044127],[-0.01042623250207221,-0.9430712244681765],[1.173878159890025,-1.1772306181641956],[0.6363231629268687,-0.8957388769404586],[0.2943489996201072,-0.9763857126529649],[0.427242448574926,-1.0922675544405736],[0.9924113947572373,-1.0580146265532149],[0.7485053548422941,-1.0063110731483755],[-0.2794546194659888,-0.6010995014603859],[0.1565712470194092,-0.9222915403381496],[-0.2108470819082648,-0.8093194937427032],[-0.7197667255049991,-0.36800133629818277],[0.9012837602923839,-0.9184826161942341],[1.146939035992255,-1.1468177530198251],[0.30815630795947924,-0.8650282706168705],[-0.6034798818089324,0.9300372397780018],[0.8771901753443122,-0.9171675736189921],[-0.3146166347428202,-0.5420479924375122],[1.1469927473418347,-0.7940967878313174],[0.6558320781513437,-1.2190152135214951],[1.2730654249852262,-0.9168270325649936],[0.5162003367028102,-0.8572626458687952],[0.05034502398025617,-0.9148687350933146],[0.20486166166364828,-1.0926182281354915],[-0.17861268329880525,-0.5214432259748891],[0.6723064096068196,-1.216737926532257],[1.2214601974228494,-0.9928759222659587],[1.0087953671633032,-1.1609877123033687],[1.0515666189997581,-1.2281011739201384],[1.2714368796624864,-1.0368830241829994],[0.6416851514321307,0.3782855104490236],[0.4518142088681026,-1.066544997550101],[1.0571661761644113,-1.2587960541290422],[1.2124149376117241,-1.0933847175269171],[0.7688589897557718,-1.158002809073316],[0.657557642563403,-0.799532912454916],[0.3561842814027489,0.7158897016971708],[-0.11773798822734668,0.10823900007161548],[0.3876593274221874,0.8681874296977881],[-0.17472095686460412,-0.5381966383487754],[0.2983067907388668,0.8065924404221116],[0.18474283724128593,1.249124624243334],[0.48230089023424444,0.7600485356790936],[0.17389103593802002,0.7039223703755577],[0.3221294200467241,0.01661564823834858],[0.5508991375894481,0.7122980061943133],[0.39550934018613426,0.9673110205324699],[-0.045471161586104286,1.604405831574481],[0.5756023504067299,0.6714556908032271],[0.28555049693948387,1.2722153981921944],[-0.37999248555019455,-0.7391420160390648],[-0.08312726118135408,-0.1272273905283027],[0.09015436841969782,1.4859342860359916],[0.3425360813896613,-0.24296920146215528],[0.23233918948621002,1.0915891535537465],[0.4064872962293532,-0.7322561917050887],[0.06941616076637198,0.1676186198436527],[-0.5238489618853788,-0.6333103341041963],[0.2553900355958448,0.6204995616618797],[0.18767574096050071,0.8050123093086056],[0.3496675610515877,0.20315581879123937],[0.10819484943943543,0.8213176985717964],[0.2464742241553538,0.47227375537755323],[0.2967690026736123,0.8467626241668721],[-0.5764156653047735,-0.4993506694687134],[0.4175429367750748,-0.07198454083255387],[-0.4238936398662059,-0.7716254455005669],[0.06655630730505345,1.3926031346861085],[0.19115709280527898,0.12825236786980254],[-0.3017886639671386,0.45815267128588055],[-0.6371979096920752,-0.30676726632541407],[0.3798149134086985,-0.07382135214758113],[-0.8030202989514308,-0.4869594993266746],[0.0632927729935073,1.4313420046830283],[0.03545521490716699,1.4443107071906618],[0.40395694489659584,0.5956908899677245],[-0.03773752617575613,0.4595226961597019],[-0.39189776949126426,1.0198399998799643],[-0.5986377717705947,0.7141976273921697],[-0.4094781272774618,0.6223326271672096],[-0.49438620214349405,1.104732454688855],[-0.05538297180887358,0.6137244433172571],[-0.7033676460631854,0.581321635060639],[-0.5122706572048041,0.5685202733579118],[-0.3548720101497107,1.291266246974236],[0.04834858939969472,0.1354723943755621],[-0.24780189043324263,0.9888735147403473],[-0.1867961788854754,0.6208988713997096],[-0.26927801904120374,0.6691333242277131],[-0.5851553649423322,0.5341712450916836],[-0.14165118441033608,0.543322493209557],[-0.5337105061233852,0.5700820427341139],[-0.6105224675030066,0.769012356198411],[-0.5390164843795358,0.7901155180340736],[-0.27985786810685553,0.8887793140268939],[-0.5124747372640043,0.7039319829413236],[-0.7185715883389485,0.868580299606588],[-0.6214670812723955,0.5837519537124488],[-0.22037879304888985,0.0761112813523655],[-0.5703896013518779,0.7571865149679948],[-0.6761195001194144,0.48518418956272835],[-0.26345407233738,0.7279394452687531],[-0.7152809872078445,0.7713167094795402],[0.04101278624441858,0.8484882927984102],[-0.17688087830419835,0.6535801571643329],[-0.6051496093705347,0.4614289701247574],[-0.7441248285232659,0.5050592696679461],[-0.6414588500984457,1.0592870174145497],[-0.715321467945943,0.7434857176107739],[-0.26594673315766076,0.301047582758757],[-0.7493117715725748,0.9771489479023842],[-0.6230273870122498,0.96848557736503],[-0.4255372117324716,0.4428472220546411],[-0.6279470530123781,0.3871460062625739],[-0.7011821310356826,0.5628863065365765],[-0.6722281112712039,0.681272679587657],[0.9811335014812044,-0.8652074354240912],[0.08107522210426796,-1.0859209654672484],[-0.12289568447146994,-0.9072698037496144],[0.7191455785386409,-0.8917829127298231],[-0.45018285486315934,-0.5602001448594452],[0.11877685274491569,-0.3821603556730468],[0.040497505910682255,-0.8656828661902763],[-0.10147366136224739,-0.5639787252371584],[0.8523315230770425,-0.9366589559830374],[0.9199012694905642,-0.7360601081116068],[-0.6366142305543345,-0.17519651600304362],[-0.2299079815558417,-0.9092856515587182],[0.38190046500506275,-0.8044340164442424],[0.1460013361509433,-0.9413542170807839],[-0.4559898479009252,-0.48433434669334363],[-0.5820119591611799,-0.386697302002463],[0.9833441456667794,-0.919148884873513],[0.08492655585646683,-0.8399018265292235],[-0.40784852853683995,-0.7248251052689882],[-0.7290413118797706,-0.5112717842581],[0.26267755822965383,-1.2000275307417716],[0.810523288673929,-0.9084205049053874],[-0.07050005576664789,-0.8382445623497847],[-0.14533407711192553,-0.7408433793174841],[0.10565868826255918,-0.1968481163008297],[0.021316598616923504,-1.0318264346287274],[-0.5836950618599855,-0.761132976683782],[0.9323423640143544,-0.8666533483630006],[0.6891029906602575,-0.952409174436855],[-0.02034695461214836,-0.840035534428305],[0.28981695296687815,-1.152752967478495],[-0.038786258734040735,-0.9178182013846599],[0.8873633102519447,-0.9253253066913849],[0.9214463263332597,-0.8553826697806793],[0.12851586528070874,-0.15318416593386242],[-0.05691724951432224,-0.5181979477224468],[-0.5730466066942622,-0.5356881404914714],[-0.6812622725392095,-0.44924394061156636],[-0.5841990605531614,-0.35463968024935216],[0.5068551327355777,-1.011044366793803],[0.31000261883125885,-0.006736152609774462],[-0.43703620444687064,0.8265592094754537],[1.1686017657410124,-0.7075672880434744],[0.010521307492265142,-0.195317816619386],[0.0723587979691469,1.519357393037551],[0.44134330464230603,0.9077326644604656],[-0.21795182104762056,0.9817571666189375],[0.3462102587635943,0.26523143382365916],[-0.03427360153942995,-0.23202307409486736],[0.137442012811714,0.2641960115438212],[-0.577268756424146,-0.28004296709442333],[-0.49476028583139664,-0.3032208692050194],[0.057645696538859946,-0.40858047193157926],[0.1940468296408026,0.306641030981021],[0.21107109641410432,0.19154988900864342],[-0.09384412347097001,0.7067198328334963],[0.24387949354677071,0.39308493805237116],[0.27311599221251054,0.16037457612099898],[0.3937947032713467,0.3845510070903402],[0.3112178151340048,0.01476788392400468],[0.2816884262161974,0.056387477034662827],[0.3165491170774083,-0.2341564541541688],[0.4243487845415113,-0.07463573408223113],[0.37628343376105045,0.03409406449065754],[0.3124497887314139,-0.11998246010647814],[0.3724339436898001,0.10311847573973867],[0.10120951742483457,-0.5646843526457396],[-0.036241272670641686,0.10408695487321515],[-0.0886130512737125,-0.42625223714570404],[-0.06424667925381478,-0.1884420590023319],[-0.30746788159305977,-0.4707658581013876],[-0.5693744991407546,-0.5313499082649286],[0.3430659532029487,0.29322263384129643],[-0.4338822878746239,-0.1993613064520023],[0.2229573828420704,-0.22626301337696095],[0.451013009737632,0.13847452257787285],[-0.28291294808324013,-0.38687767247453764],[0.35505753626656134,0.00040176155053416734],[0.47332112680778904,0.254617555317894],[-0.08608559118273124,-0.3328187623213937],[-0.5605010973167336,-0.9100351323028221],[1.0458774378690074,-1.1373460767681014],[0.49314071995659126,0.67737360158128],[0.9852429908481556,-1.0072446815513778],[1.1350744531847043,-0.9998104088955185],[1.117027618499082,-1.0087725175456042],[0.12662656853071486,-1.0397050860646841],[0.3145241448613645,-1.1560804875115107],[0.23864416108365685,-1.0585573531282395],[0.4942876998348486,-1.20666472657429],[0.9815490181799886,-1.100448555983308],[0.4788399668803329,-1.147080372303183],[1.2345735985822115,-0.8858468604796332],[0.8022536394015247,-0.9397355672566182],[0.9972485065193433,-1.1011418799597492],[0.7828053071824961,-1.0996250020312581],[1.1835708604901363,-0.6709450235652935],[1.1287188945229558,-0.6475344576763409],[0.3734346322844279,-1.044122888410556],[1.0397261821138644,-0.5948498392068089],[1.2897512561595417,-1.0769365209862625],[-0.7406379392676952,-0.3535208818223552],[0.7512553703650844,-0.8072004713072916],[-0.7115424446640487,-0.5714671872928345],[-0.6841049766633284,-0.20041108058177193],[0.6172748194628161,-0.9026459021789128],[0.542816674824993,-1.244728202545757],[1.018887655763417,-1.2321432765250453],[-0.39143265988854803,-0.6324350678617633],[0.693356346108201,-0.7687087757277435],[0.8072139957684445,-1.1934956273138662],[0.3612967734262371,-1.1606365340479883],[-0.521813090504442,-0.5641539781661404],[0.23398276239987936,-1.158646499065576],[0.98044429413939,-0.9277879128567069],[1.174115380371201,-0.9738321894342536],[0.9735577496023724,-1.2369559868929472],[0.8333541847659377,-0.5909972433675487],[1.3041574589729468,-0.9423596048897913],[0.5053172570818374,-0.8629811104033763]]
            
            
            N = data.length;
            //dr_mid = get_dr_mid(matrix_data, dr_data, dr_bottom);
            //console.log(dr_mid)
            /* iter=500 */
            //dr_mid = [[-3.2020629339370617,3.7207394815388386],[-3.9278142867425374,1.8900992120771172],[-3.0814928391063114,1.6488678856396646],[-2.7408487861736135,3.3586725125623462],[-3.5854789698508456,3.048098995594755],[-2.9274882988800845,3.2579761076339624],[-4.18295604686344,2.7381186706393077],[-3.842945242444651,3.306605026768048],[-3.257527938238944,3.5412640611906707],[-3.629261892941118,3.002115707063082],[-3.1548199057156343,2.157232716703745],[-2.9491666255490077,3.4789149798402894],[-2.9044151224827344,3.5225350777307916],[-3.585517624984909,3.401542309229046],[-2.8826000071711073,2.0707559599088823],[-0.9874490307289052,-2.085563684740278],[-1.9436418229058883,2.7766604057263438],[-3.340174662443003,3.5746226864571775],[-3.163379934864926,3.2496520276421674],[-3.7325224550602245,2.144380410931336],[-3.085250507313918,3.2270880669270228],[-4.136958701747701,2.9450357561181355],[-3.1760481962400293,2.2329493668250127],[-3.3686307166502005,2.7025027789159597],[-3.447709060630545,3.230130772306535],[-2.968152985558434,3.2499354809239387],[-2.2375037200580032,3.3475349909050025],[-2.8467378978500095,1.838071384024004],[-3.076433981145075,3.551602866609919],[-1.9668104782563929,3.0676633473400763],[-3.395014434800976,3.2981614385453484],[-1.062674213922751,-0.48864987547016087],[-3.938584218846892,3.4196664956502563],[-4.515299490327361,2.418564500320358],[-3.251301514725664,3.251728374841925],[-3.2673834560325314,2.405597004150008],[-3.2979787944644094,2.4334209899096817],[-4.1029070149620805,2.8872619316582204],[-3.238151306289147,3.6988842213921513],[-2.585816941082303,2.3924709251363026],[2.1825130102722263,4.128051658809946],[-1.2267000858145782,2.68980239550517],[3.07237926885429,2.064813807765213],[1.4525850043900495,4.057973336317204],[2.437251471319029,3.7235008653776966],[2.719570469546327,2.0792536917679327],[1.9273109185034838,3.877855879018214],[2.6110734187080378,3.7806635898456316],[1.8337952516835025,3.950983613975949],[3.2305707857270654,2.0868103605355692],[1.6253830840129628,4.1757460523059],[2.8026866594557895,1.9620967068542763],[3.209559229001212,3.0257176905788072],[2.5731956318280518,3.796395040009186],[3.397905916011799,2.05027721901245],[3.1374184537455663,2.5994380353389834],[3.5133475577137623,2.2462189858258985],[1.8584454821231333,3.9678985269262674],[1.5695192242648837,3.9814352056445173],[3.300236462744831,1.965009528494952],[2.9015719673666567,2.729904587462548],[1.327859112157576,4.001256826385471],[3.5434864568248146,2.36577677297306],[1.9480892533235301,4.157022268991229],[2.710891854657927,3.710069265275615],[3.196335146169065,1.8749455743684549],[3.3284009757691977,2.34415791666716],[2.3701685761087954,3.9557018938917805],[1.9753083866292773,3.8082922105983976],[-1.0070316768410685,2.830516050931902],[-1.1461446179237604,2.3891586003971508],[2.446416733748237,3.6978583955591464],[2.7271123371836046,1.491242308902149],[-1.0106698807491046,2.741229133087563],[3.1012958005984843,2.7454694805685538],[1.9511657835564669,3.879015302323933],[2.137586378139702,4.192691626995108],[1.613638176826135,4.2769354201701075],[2.4613537365866853,3.7298543212409156],[-1.118014632666937,2.4749356957908337],[1.2883128896823732,-0.37097782928612927],[-4.124881056011104,1.7099166108304973],[-1.994419471179874,-1.2149391613511262],[3.057085034127248,1.439449084792322],[2.2654302374853663,1.748611001669065],[1.4436118990129923,2.0484769317877967],[-0.9932009446217659,-2.5756974439868463],[0.4960185152381301,-1.0663027329315897],[3.6517984794989293,1.2484420979674142],[2.559651989693879,1.101854918583556],[2.0942278516520494,1.86228279509993],[-0.3944780002725389,-1.266431670928346],[-0.7180911172211619,-2.640039684268851],[1.134298731985281,-2.383667922421266],[1.7918816712721188,0.8811336151703975],[2.1144089354867055,1.8792736460621589],[0.15065121238520568,-2.2922642305747405],[4.055649518689338,0.34257862373873144],[2.574118428667933,1.9100748965033039],[3.512072036705276,1.4499117871554212],[1.8926922377182431,1.8621648132402513],[-0.6270140616977355,-2.682942000482474],[-1.7239811414029063,-2.799780418809463],[2.1959624131547084,1.95799697233366],[3.4485431844243837,1.537113982295947],[1.6510204541669418,0.6449701780600015],[-1.1741130926467993,-0.8292755745010949],[-0.8197354991165222,-2.5522577262676136],[-0.07458531946021688,-2.550150650839403],[1.9029775400886815,3.3687613704460597],[3.0112919369162796,2.8571387400758317],[-1.4759266325779463,-1.1136387707559463],[-1.8983566518991728,-2.653667173976406],[2.266705197245555,1.8650957825064982],[2.7401297213853497,1.629402176234713],[0.7307341087933815,0.6740045286989713],[1.687887676097366,1.9909568493963714],[3.5352803486282496,1.158972252160269],[-3.272480615237721,1.6298931472847924],[-0.21147958962164926,-0.9324258377594664],[-0.9030875811686264,-1.0033446948333513],[-2.2250184890274882,-1.5176154154681978],[-2.605969993698114,-0.07537568308337785],[-2.56142978579702,-2.736362926064208],[1.818270840180979,3.355924348697449],[-2.33851976982235,-0.49836507992146817],[-2.929249290151946,-2.3971632840795123],[-2.6755761650472256,-2.6342153116970826],[0.23180062936595164,2.5578716303633717],[-1.6357878102526298,-0.0356695901251993],[-0.6312669185601991,3.197112245957552],[-1.8426649602290979,-0.3791367794067418],[-2.655284421239158,-2.769612900409866],[-1.40444094303443,-2.3534158897111155],[-1.9898454472454021,-0.2241701040936682],[-1.7214339725434382,0.6504514950098098],[-2.19621480923055,-2.028385411534462],[1.9120423783148126,1.8684823813241929],[-2.259368992331259,-0.385178858761571],[-2.0483389473818896,-0.4310909968638351],[0.04142629660384147,3.9610276567135236],[0.475122705854245,1.8778498090683087],[0.21347865794072515,2.880673623797781],[-2.70371259594561,-2.4289989780142784],[-2.2994041300166814,-2.7325902207942434],[0.23397323766852754,2.2161159659593737],[-1.8791348481083328,-0.09614577677647536],[-2.5366967808699146,-0.3997425723827296],[-1.683499706902814,-2.306353357513727],[0.13571629074376682,2.463604101595917],[-2.661254444338611,-2.6165554540106593],[-1.735721411046238,-0.314069336093749],[-2.039592213060662,-0.43379564247463887],[0.32152204658264233,2.7367571479013377],[2.5642876179209955,-3.299858390699418],[-2.8872558371117316,-2.4653507595346857],[-1.6406592329618805,-0.17018875104766637],[-0.2750147117293583,2.5655947680102082],[0.9952868159185739,3.616595617356806],[-1.971859582276184,-0.45562306968298905],[2.0819446615884134,-1.9768463095394653],[2.9949319898636353,-4.212286364232958],[3.238777879395141,-2.796157297260067],[3.6341277549979827,-2.529256173834164],[2.4677317421661105,-4.583760788568099],[0.7275577238956572,-1.4009067253437855],[2.3787435906106933,-4.8988958131406966],[3.226624715650507,-2.8860744322864855],[1.8234775068474212,-2.0571699126478484],[0.728818093040788,4.188368813774012],[2.1352525484822995,-4.745569387371028],[3.5434063583001225,-2.6611412997344503],[0.9956864192209823,-0.174699730722299],[1.3860837346685182,-1.66843915191032],[0.5637121513080602,-1.4307064722256855],[3.402928683799127,2.5139556388755757],[3.521037640219499,-2.8092441021547923],[2.606121426298022,-4.32732237886318],[4.607536616742418,-2.7604705765873647],[-4.865358633978628,0.4145755090430457],[3.5785866370974975,-3.517613919644327],[-0.2617108264676226,-0.12334533990000261],[3.0804305900962916,-4.604865249244907],[2.4039022545258435,-2.0610504902617124],[1.8162248971682002,-4.376200968508322],[3.366488104861714,-2.5319414955490593],[1.3114267518375895,-3.4180534146158967],[1.4470390952662833,-3.1476777760505685],[1.7223427171714192,3.1376219051821237],[3.933894930016087,-3.719264314827145],[1.9656776107522431,-4.514135003581281],[2.9890126157648655,-4.027302229216636],[2.471137922751335,-4.424042329808904],[2.485949733349581,-4.7667840644436055],[-5.3721316869329465,-0.2745843330473282],[1.8325079970067784,-1.2502573287808942],[2.5600120890298825,-4.434130382439909],[2.064538782385296,-4.704031987809569],[3.6213409267957792,-4.122155662866068],[3.7624884939158907,-1.9502311955834728],[-2.3480985612247394,0.494117195203144],[-3.627702611030616,-0.36053252027765187],[-2.1061523399255124,0.22346465564402526],[2.3363461852991687,-0.3728379709941524],[-2.885163515279044,0.5214597138086069],[-2.9003276763681525,-1.6315448598650932],[-2.0185417545422637,0.7827275753738889],[-2.001597692488389,0.05578850794695153],[-0.05410358096212526,0.99374890454817],[-3.5067815907146147,-1.4546151664842522],[-2.569962205255644,0.1861981634929906],[-3.728708541762905,1.5397768087876176],[-1.216460453461647,1.3034061210294918],[-3.015556305733638,-1.4969428666096798],[2.5234710499641544,-0.4517178044682836],[1.1942367386224018,1.179426217266865],[-2.9176275225621566,-2.3995595813458617],[0.5480032261193473,0.9370918141165906],[-2.8924993978964477,-1.5723887615342924],[1.8320706746965596,-2.261818401962794],[-0.5593133421068006,0.6605959090063864],[2.6007611326565145,0.35699044443266165],[-2.4279034447670993,0.5831348819964978],[-2.09426581253662,-0.45067262129471725],[-0.10513508019227805,-0.13045404186349438],[-2.308161671267034,-1.3992183607508235],[-1.0458290611891623,-1.1450203658161724],[-1.36467577924125,1.1843808722023716],[3.166415962498912,3.2292596420296378],[0.023942084799044583,0.1471793337603407],[1.7446461791084638,0.7484679520967853],[-3.002019314895835,-2.357639435541958],[-0.5003911391273107,1.2579355454068575],[-0.12574902915903316,-1.025397246806266],[2.1704789170019545,1.4573838946429776],[-0.05669010325982865,1.0767862885143136],[3.1233996634630543,2.0487671609772464],[-2.8555148888094837,-2.504208986256521],[-2.839047804089856,-2.610018810005284],[-1.7666518343279185,1.0765584299962307],[-3.1899256996980943,1.3969717086652986],[-4.849711949117979,0.41137946249053986],[-5.169010846502456,0.6963049921961275],[-4.9413230017440535,1.5320875591154393],[-4.264291817468063,0.1998739814636632],[2.3593607737040916,3.159068730201781],[-5.277784292819915,1.1130616171170755],[-4.683168101710228,1.609454495019692],[-1.9015319085760323,1.9554699101541784],[-0.8817330860641667,-1.2920632842371107],[-4.573775206800862,0.1202250380869637],[-2.7760406309181485,-0.7527678324141887],[-3.2195694164149797,-0.6723313997258689],[-5.272064180367448,0.8441914650515862],[-3.809678928932899,1.2688996115242483],[-4.903541184550122,1.401754796442702],[-4.158848714370698,1.886389954637827],[-4.354464827587967,1.520010481230282],[-3.453290878100405,0.8243722502010987],[-5.0347980079778045,0.5988020860312009],[-4.926581786596292,0.9032502680644929],[-4.724461864301211,1.7375062642397088],[-3.8195545053463604,-0.2838204905893598],[-4.39541267986939,1.370566328076701],[-5.3081614036789055,0.8239841907826805],[-4.695938176576077,1.3800221248891875],[-5.1634383848579795,0.8000410979422747],[-3.4924099779790603,0.6665798662094864],[-4.58596929053047,1.1671419520854391],[-5.42940769108056,0.7580786696418893],[-5.358950133422337,0.9433933747695651],[-4.486276031927023,0.3551551405523856],[-5.1715233573245385,1.073671603142091],[-0.7757512498719863,-1.6449914070779337],[-4.513796245481503,0.6386110686404861],[-4.683828591954186,1.029479610193825],[-4.0558350763849464,0.17454743568309988],[-5.351083208858639,0.9507638581872538],[-5.390846139140689,0.5575114653955041],[-5.25923274689494,0.8017393230730999],[0.1840922325503094,-3.3989406749525446],[0.4106088189228242,-2.302309521509306],[3.0811928596809626,-0.6471790103427089],[0.5682726531682426,-3.3682723361473945],[1.1950369410087107,-0.5405786113326875],[3.3411349074612073,-1.6074389688667212],[0.6765745181859797,-2.078527486858402],[3.029912002339743,-1.5588350685328702],[1.4365515300019776,-3.640348112683654],[0.8594240121363241,-3.6924906301654117],[1.5374595288797857,0.22912357208162917],[3.49811006059877,-0.7772779205582179],[1.8241806208264526,-2.6254931000367008],[1.7671476128322812,-2.5153697152470413],[1.4750133655525122,-0.8332329315027011],[1.6511994363084148,-0.49087043194878527],[2.127620248089435,-3.708008825216408],[3.019234945244523,-3.0818679292997135],[2.7350208542482215,-0.18446574085940046],[2.512966329696633,0.034568731142421975],[0.6058307544967969,-2.8543743503128183],[0.3641842229700294,-3.5026309291395985],[2.9748557484969504,-2.533892525838567],[3.12777976454643,-2.18990183125891],[3.6827742355231874,-1.4330188675019317],[1.414012047340001,-1.4610960103368962],[3.37373047641196,0.04336343363746952],[4.307059393615786,-2.1829674243796595],[0.5847254087669957,-3.3635797785390045],[3.115473159455404,-1.845044891056436],[3.1386106461479395,-2.4392577841189262],[3.1392262639733266,-1.082414359793141],[1.0399376602176917,-3.6171285484361815],[0.8300688349544845,-3.6913172642845713],[3.7924955880751487,-1.3068488746420464],[3.31545215179121,-1.6412281011541858],[1.1891858401128197,-0.6755059370838276],[1.1706781523999077,-0.356458429612152],[1.5183269844555578,-0.27654524215540266],[1.014616962004135,-3.2456495541629007],[0.1739289577006217,-0.4655542207458993],[-3.552564059972112,0.747533019580521],[4.18972620222192,-3.7873558864744776],[0.5943066192782799,1.5214796506841097],[-2.892151798564002,1.6646324186177004],[-1.7310487064661144,1.5465968057070558],[-3.195717839065593,1.1661653636233065],[-0.784316498836777,1.3910917918427903],[0.3228105023203471,-0.6885269576420653],[0.7387516355988939,-1.0622504821743552],[0.8804008153379924,0.6677403210715164],[2.3494422801739887,1.4824320636094315],[1.0154168667516545,-0.7709650913358382],[-0.7526694567841609,1.5828477172686775],[-0.7700212785995416,0.5801276165911201],[-1.6986749744887721,-1.416433058151797],[-0.9158735323173839,0.786597073770424],[-0.879365785017501,0.8867208371480914],[-0.9171658115950865,-0.6419157243883721],[-0.07557700206919164,-0.313072251312603],[0.214445013383487,3.606351446418156],[1.1800170800796108,-0.7524985779521665],[0.053752687513547615,0.21654945652347796],[-0.18139930497214982,0.20688194688035066],[-0.027455604653166175,0.223597388426407],[-0.6852604134117006,0.6499973274681697],[0.9503832583698401,0.12222821554828768],[0.2940237419932481,1.754677486068403],[0.016655039145304626,-1.6736565658807125],[1.923059953022237,0.21933652545929358],[2.5377676233360615,0.400654024072275],[1.1842903198691945,1.4838565701960513],[-1.4586874662372429,-1.6186996371681313],[0.6875809979348746,0.6631820818046222],[0.6265551467068459,-0.46690554813268426],[-0.7051318495341474,-0.10508971728682537],[1.3659717685719277,1.605528349504848],[-0.3291328718235062,0.7190852686624152],[-0.7465335819499289,-0.23596995942735388],[0.8272846164020253,-0.036258370294977145],[2.994902281705372,-0.09377189022393013],[3.67857094072203,-3.883877533248134],[-1.5039239035057104,1.9618639364840698],[2.8150100398204176,-3.9083754384942138],[3.205614363698784,-4.308363684612848],[4.014299943421131,-3.9516273708274534],[1.5977959578456868,-1.7887503022410964],[2.3261322109343343,-1.8607503610508092],[1.7611578976556748,-3.4568400404746065],[2.3546810346464904,-1.8272628014490124],[3.25179146333378,-3.955150428532455],[2.296931149092803,-1.8062391793430959],[3.1645285009174366,-4.640291572771043],[2.688695796839865,-3.85556973851287],[2.8522010978910175,-4.049889730337933],[2.0543861270274544,-3.782948888049201],[2.6168553075785153,-4.961086378420761],[2.026802076966514,-4.8549616899735435],[2.209726066977355,-1.6871278831288217],[4.251558020989924,-3.4400329570069443],[3.511291692857923,-4.360614156482171],[1.4904963745955004,0.45327240166435334],[4.053667620695998,-2.828520810899377],[2.2276710371344968,0.8056521497627659],[1.4801907726592147,0.19498908926715436],[3.8531364268526396,-2.392387685547465],[1.849491961609521,-3.4506273321844674],[2.9539913434247254,-3.998451755990711],[2.059020581535139,-1.0988775803783017],[-0.3561167355398029,3.8190369882093154],[3.455146784511784,-3.83050098524812],[1.7639637308364011,-3.083667157358203],[1.1160718906293563,-0.473139014593832],[1.6133155693378862,-3.31309149773009],[3.0387664789875184,-3.9469251982058706],[3.977569935812388,-4.116009103738009],[2.6979942425064194,-3.9437179444884563],[-0.8222603240286162,-3.344771230654078],[3.6435383456205024,-4.371110731987769],[2.3646654743251947,-2.9518550474927787]]
            /* iter=1000 */
            //dr_mid = [[0.1570490835500502,-0.025360569151266537],[-0.2286399669823921,-0.5598781357982029],[-0.4553760926339774,0.47465563711323944],[0.16075323272321745,-0.1533978070241314],[-0.08018856461641115,-0.40644366416481253],[0.19170929032046197,-0.12541540576227903],[-0.26968368759744454,-0.3176286783159512],[-0.22627549577828815,-0.3274509546840062],[-0.03479986353959198,-0.3032268946554103],[-0.0500668344706685,-0.39840670715621446],[-0.3604990333985704,0.49314027992991405],[0.18840302680310764,-0.09730508534760192],[0.1200799556552652,-0.11328678689527139],[-0.03536293202824265,-0.4290975590242008],[-0.08683693150036899,0.5466486612556579],[-0.3205758894406386,-0.5075009070301767],[-0.22328671514302095,-0.310024990120966],[0.2067263861313172,-0.1752121674187527],[0.24254075709765985,-0.08018818354026025],[-0.35498418824168815,-0.4383651969139882],[-0.07756761566572148,-0.39032780809907214],[-0.39742526620855356,-0.1694058561818933],[-0.42291774290208456,0.4350259621567444],[-0.15025810212018445,-0.5029536348076258],[-0.06395731752361496,-0.47186844291704194],[0.29424166348576025,-0.2051786397196978],[0.21623795694707143,0.0997665626763912],[-0.1037206203247129,0.5890998873200142],[0.15511461649610334,-0.1789124910001302],[-0.28781178871995955,-0.2091847517502481],[-0.07072213101885523,-0.39588566494684224],[-0.77055221238873,-0.3504985118445439],[0.12919083602594517,-0.30086975686873474],[0.20910686993818736,0.42628291368240273],[-0.054241604219510006,-0.39179175706621566],[-0.3296099959718712,0.3469987913968611],[-0.16501400999059526,0.5926606803987017],[-0.39695778654818237,0.014941095621088469],[0.09546985349559574,-0.2434527915790612],[-0.12450067653234403,-0.3671780172448131],[-0.10241417339148262,0.019608586313650825],[0.036271167308497214,0.08111764646137837],[0.4979258592776796,-0.091865978294809],[-0.06054587436102364,0.13667296008707663],[-0.1054870067772257,0.08155901579507052],[0.41024584089429705,-0.4269771247479905],[-0.10207126619881567,0.13792708738654944],[-0.16207215690549254,0.03910135648925058],[-0.14984040294404574,0.10565983072638276],[0.40791146830378117,-0.13099601080040174],[-0.0571713706819452,0.1299081744697433],[0.5252457519365795,-0.15245704507861543],[-0.29665672877448296,-0.14172376184381064],[-0.17752932031514915,-0.0227942349311102],[0.44057711687780193,-0.04144768186768332],[0.3021563691041506,-0.27383431280770676],[0.3582443849901329,-0.0841189342528977],[-0.08318434176093199,0.1330677395055206],[-0.1287425172728855,0.1559721647576366],[0.4385195573269589,-0.10711097806895387],[0.17638930053853105,0.1708034524480767],[-0.11179103293785651,0.1291735773582345],[0.40425361302599616,-0.00744933024037543],[-0.050343540040428084,0.11895886565048872],[-0.17593357573319512,-0.011432418935919035],[0.43566089060323193,-0.023058126923804875],[0.41002243783989056,-0.03466485731317029],[-0.2088479212073473,0.06093475141192871],[-0.0715157586304893,0.17853301557924497],[0.05358757257729811,0.04788542812670669],[0.1786731083641718,0.01661724364084614],[-0.061819972191991236,0.11856374203297106],[0.344254790643578,-0.4774436698831705],[0.08105701205271709,0.08319473968587358],[0.28288802276813135,-0.17099337428199463],[-0.06424355103312827,0.16820754636956997],[-0.05178435676266765,0.15861574786524513],[0.04146974487860945,0.17811462590446278],[-0.11997450700151918,0.06680734418335203],[0.22585598034771995,0.03767536570879336],[-0.06299386504389673,0.09764279066436261],[-0.1748997433947436,-0.4191682647976534],[0.046143077195741844,0.24463045726169794],[0.09934933006001816,-0.5693468230097793],[0.47291739332162597,-0.1844208172489681],[-0.509168230420712,-0.34509182470515715],[-0.35736889241589037,-0.2316238994292041],[-0.34275521099335876,0.5216600646541624],[0.2245566364426502,0.04203271554035758],[0.07076987871274569,-0.493064646699191],[0.2691198643915795,-0.6142658063223968],[-0.59745266149596,-0.1589966501137236],[-0.3237642849921432,-0.18012249679863776],[-0.5917056595093749,0.26483305411223845],[-0.22770023085053354,-0.7022598599491685],[0.3902878788491617,-0.5013839794110494],[0.5158372782212968,-0.28002586385139133],[-0.22277470995940482,0.31459195507523857],[0.18295695936495027,-0.31057737535745283],[0.28738803080395925,0.13613529147230935],[0.5091157921193632,-0.06533105480536046],[-0.17898863289298458,-0.15268118119931673],[-0.20422925583130294,-0.07972520978846913],[0.2932798481737487,0.15103788661084505],[0.2857179125715467,0.12249676341009658],[0.25723127256737033,0.08758314179033543],[-0.6290579548249665,-0.4920879602914384],[0.10892695122851076,0.23845713101472565],[0.23316483444237857,-0.22299324325003272],[-0.4376128749219743,0.0923638403570404],[-0.17870980226838,-0.08847346406189943],[0.2588257543469143,-0.5405846090082694],[-0.22444094840376588,-0.15291348745644304],[0.36448073853971397,-0.3912971622001295],[0.33458319615946086,-0.4179098231927394],[-0.39752637401917973,-0.27771303750583615],[-0.20351337225997015,-0.7139821933090685],[0.15295802621244708,0.033605632127256625],[-0.49224856855688,0.3972590439877382],[-0.08662786933218283,-0.5814058702108165],[-0.05391086791994411,-0.5996502760559991],[-0.33496961345301773,-0.08673194459249788],[0.4332495273106169,-0.02196110665431003],[0.03668128617650166,0.034277214325694826],[0.11837281627970508,0.21309188686924882],[-0.01950662013367601,-0.18715614811906447],[0.005485850089665698,0.1155493340091742],[0.007257928834907408,0.0990043935416353],[-0.33440503552616935,0.06576828668441165],[0.5146990630419417,-0.22198588685449863],[-0.13829192598103376,0.24360872586747934],[0.2969509713123435,-0.31127043316601394],[0.1254118443564166,-0.12488142214669548],[-0.016033272895976863,0.13062127226428805],[0.4333139242008095,-0.23011673014625694],[-0.220436559229789,0.1945667550112107],[-0.11570640820377319,0.10657729621651658],[0.4271017915138684,-0.5163228042713633],[0.3992101603134053,-0.2436316343628206],[0.41546062364294306,-0.24951663252131798],[-0.270564977038671,0.15797154858936718],[-0.5244881489214019,0.09901500501476121],[0.005210652009298736,-0.14199913276872111],[-0.08566821251962417,0.15756102710086198],[0.014479654073939537,-0.11973268246384201],[-0.4237318128850974,0.031685923547169065],[0.37253970909751877,-0.2320686334533988],[0.23727784638466812,-0.02058433151454299],[0.20912991761450814,-0.09765696795683998],[-0.3918564243221627,0.025611538175179582],[0.0754115624043717,0.05692839587054572],[0.40527441775226075,-0.3021171612786476],[0.3218271544947703,-0.2726119960623694],[-0.30794451868211625,0.17883242764211965],[0.4819039766131211,0.33405023169467807],[0.0511970119089093,0.10649913216284886],[0.3583247358486392,-0.23879200775529752],[-0.18529617779751265,0.24233599120074756],[-0.18709612641664547,0.17227876565308556],[0.3357753341989293,-0.3344665108347435],[-0.3778493142559912,-0.12999553613069778],[-0.23891431529073764,-0.36333636978507183],[-0.14334396710082772,-0.4352114620973667],[0.278481187604986,-0.07880958372223333],[-0.345798492835356,0.07385207885897803],[-0.42580182387251886,0.28303045439473623],[-0.3559931428382303,0.1133323848748167],[-0.44664843875968424,-0.1728487579554632],[-0.4007083900625723,-0.16320811526789025],[0.1105235747622771,-0.10445404383264632],[0.2600676634174797,0.30377675814871763],[-0.027243799087721284,-0.4209234073883897],[-0.27662983807374963,-0.39668677439120337],[-0.3968668049225167,0.2844109915107243],[-0.33290341868737316,0.3575483377739622],[-0.2235028613905709,-0.4207791699158735],[-0.026403468286617285,-0.35645635068316767],[-0.2513761589333783,-0.2544547147908872],[0.23847159605534923,-0.16112868922667176],[0.14142815303856118,0.1588949182159698],[-0.19164616204854587,-0.38932230910366056],[0.11419666191810246,0.19530237553365712],[-0.2004128758953151,-0.2906290366229],[-0.40865845903501075,-0.08806444481889356],[-0.03559162313276349,0.2590789496899165],[-0.11039770706910997,-0.45124221782693175],[0.2906738540868111,-0.043370084253274266],[0.20951298997671472,-0.05573663278448633],[-0.4803984777490683,0.0305615952747917],[0.11388116334569058,0.264531384164088],[-0.08770511739498615,0.2925952518266466],[-0.17425797726476266,-0.37987034668988384],[-0.32739757364557964,-0.034366321435210914],[-0.31604055265515635,-0.16911351167377023],[-0.007892139830705252,-0.0012847184283294305],[0.3920938349354582,0.305266926783751],[-0.3934905994571132,-0.06701287488214831],[-0.3063168458394358,0.17836076870533144],[0.24101020188616123,0.2585662437775399],[0.23016265222910676,-0.1816971253244523],[0.6424041582457591,0.07306913703656365],[-0.2594400805158495,0.5479634366310828],[0.6260936535100031,-0.08436057360581606],[0.5009187497622345,0.4188510067210404],[0.5857249633860349,-0.11191241372109015],[0.4317106247871731,0.23240533552197623],[0.4964275541902456,0.3335417498061872],[0.66560170181964,0.13883918756685457],[-0.4732462397749718,0.3473832956075213],[-0.3331751797162959,-0.12351197394643601],[0.4961661487640191,0.26148268890477483],[-0.022755203259695475,0.44503825632784355],[0.3127111611954669,0.3065199694010194],[0.13435754741383926,0.34869494640504506],[0.6045852133840642,-0.12345160671421894],[-0.6366820459569674,-0.38017507782196164],[-0.004624943753406926,0.3901299280439537],[-0.33259603544597266,0.03835749552802606],[0.323618381707272,0.3313394697401849],[-0.2826193325497001,0.24236092587760094],[-0.31785855153736364,0.6506371298379495],[0.5042722270493488,-0.291961231229571],[0.7282468112548741,0.1871803010658462],[0.6520623346981692,0.3153091967273552],[0.1904605917909267,0.6769228804376105],[0.08915446312538926,-0.4120824045485942],[0.6489021975326185,-0.23096966386944237],[-0.5797011035055837,0.3177212991134553],[-0.33145946747255284,-0.01015688936096075],[0.15637186625544755,0.5188662902812502],[0.3014857585786951,0.4417478962394423],[-0.09972686584613549,0.32444795851687613],[-0.491675614238608,0.5434395449787096],[-0.06320180554941796,-0.5865349760379925],[0.43745395625023065,-0.1793269408615948],[-0.41543220930842184,0.17164827892734874],[0.4802654888626817,-0.0870237397546596],[-0.046669619495159076,0.28658093144374974],[0.03181819140688873,0.23743095474127485],[0.4704370091853118,0.5412395510409338],[0.19895922082085146,-0.2496419315252668],[-0.03917378026476568,-0.17201244575223698],[0.132949502481774,-0.1415933117215998],[-0.04410402203615851,-0.3259481050267194],[-0.04864493271344261,0.5559196720657178],[-0.07650039423109249,0.053685933098818375],[0.06343981694587768,-0.19962503907680876],[-0.053605991925463864,-0.31218524845437967],[-0.023012247624027177,0.6102028752568233],[-0.3308579921395844,-0.0751979251645694],[-0.03394774991140969,-0.2542843712206214],[-0.710029536165027,-0.1579117843446243],[-0.6185249596007364,-0.0861845734542232],[0.08303989707031098,-0.23508876577738713],[-0.1255448673350096,-0.4655870030179695],[0.018052541630309178,-0.29266277526524814],[-0.14202264473763546,-0.305611034671272],[-0.04305125118408951,-0.23362874984777854],[-0.5715697479426063,0.09019992567245635],[0.06431920209559322,-0.20883335527137054],[0.27897727962437874,-0.03771297268534578],[-0.19331509163669727,-0.1392724026404843],[-0.3944549175732288,0.4979124580572227],[-0.12144204548915757,-0.08556623561193649],[0.17227876740330725,-0.21743600176893657],[-0.012214421442990267,-0.3783037236041345],[0.2746446869189815,-0.15611703200804244],[-0.23218687705517993,0.5044658398683651],[-0.534472430207141,-0.015771917633112566],[-0.002825390818994144,-0.21010370954744467],[0.15403942782281113,-0.15611536255919625],[0.08218709851435885,0.46006663300055395],[0.1105682764257234,-0.17171453573506026],[-0.6170172381048468,-0.3500180824458569],[0.20327734546593174,0.4507279421435129],[0.19234824004994472,0.23436410422914017],[-0.37150734399219815,-0.06303667971256387],[0.04412938122488927,-0.22604127681756186],[0.26310626387214364,-0.12140286824193008],[0.12867133457719798,-0.08787391482304648],[0.29127595894883895,0.13838579472970441],[-0.27927695355484594,0.017453011470439563],[-0.4696400070702642,0.2940008871039269],[0.32407151750768753,0.32272093847291633],[-0.27228624417112934,-0.32925853073698774],[0.26116970162128994,0.22403760128410466],[-0.37810666179645774,0.4626000255285646],[0.1908569592028845,0.14312327352488355],[0.3957309941028025,0.3551840127091897],[0.16105570536275823,0.3008925000845068],[-0.24509295657659888,-0.044907816421848545],[-0.6021882688263023,0.24089853281702184],[0.012756591190022325,0.43870827697349124],[-0.3480402558868884,0.5784139595697182],[0.022690755590269566,0.01767840520857549],[-0.1458618724261449,0.0015791593302000857],[-0.11084473043648017,0.01630272159076898],[0.1342899415934729,0.34059127955793017],[0.597805840607815,0.21388375624333414],[0.07653881240528469,-0.4224811222114862],[-0.24961246513841964,-0.1119231837451375],[0.2859742952117742,0.3006926881835402],[0.09489668861976293,0.4428882733813668],[0.1841238326700399,0.3368387336347937],[0.1817385496537459,0.19273824030282907],[-0.38394813143201745,0.3564219809052489],[-0.5039830945956878,0.056067561747353147],[0.19946518191260232,0.019166670122265483],[0.2884641180028961,0.32760840573058847],[-0.4817177916477265,0.438930653739283],[-0.3959081791299524,-0.21909586975148582],[-0.5615686708528579,0.2155163626237111],[0.3668734390123412,0.34657487570357853],[0.4254639833923527,0.1985429271026454],[0.04968276652880759,0.2404827641820002],[0.19869354148278331,0.16545405157346219],[-0.18747062738231365,-0.20360378934529613],[-0.15289057588892838,-0.01447653965840924],[-0.28353093774216326,-0.133466458233492],[-0.4433614447139354,0.04125750773045593],[0.642435783537437,0.43281482769334545],[-0.29158172586570014,-0.4110252418424524],[0.13529991658311447,-0.10556611859014535],[0.05794285725584136,0.7638978736349663],[-0.033947168886695765,0.3815820785588715],[0.5095320159767394,0.4164212735540458],[-0.5974670026488587,-0.037002729437705474],[0.38176428050103084,0.6179403151072712],[-0.15075961808787985,0.7203414289881743],[0.20059098116345103,0.1584190689904849],[-0.403901352755309,-0.19195299785632935],[0.3191629075094286,-0.5383276038530195],[-0.42425921752227147,-0.3751692675892386],[-0.4175753063617605,0.7084014475927936],[0.7070006840589291,0.46254752511212976],[-0.25224040246417984,-0.31752486344440134],[0.6400990000862998,0.46088663398348945],[0.5707911185392521,0.5751941958493655],[0.30269478565395036,-0.4293337132956629],[0.7353076644465026,0.33619192172359813],[-0.4701489402561492,0.43407957641690376],[-0.30252672048263474,0.6274434346473411],[0.3365533267900918,0.34687811826164616],[0.45531494772723624,0.5483919965464054],[-0.14044970820735767,0.5682226282149789],[0.6530100226714572,0.3050715516944379],[0.36378125379737125,-0.01887760146379369],[-0.2336447098061411,0.669927214409494],[-0.39126479561826405,0.3837807946198428],[-0.04328226708363802,0.7571988451905509],[0.3110563124738519,-0.558676673576536],[0.1285360775176191,0.3615950624263704],[0.3880670035810848,-0.40586892526699336],[-0.3885484599790946,-0.39232561576923924],[-0.09117877913905852,0.7570111425259015],[0.5749127831426178,-0.26932848408677335],[0.4107516957546571,0.49927600425571184],[0.266726672402742,0.5893800034264951],[0.5533643151940408,-0.28487766315030244],[-0.016222419387509592,-0.30616775129575496],[0.4737393564612675,-0.028760366763252204],[-0.027443476118774783,-0.27118433513437834],[0.11280820354619986,-0.01101966214114255],[-0.15509898913852374,0.12039277376912447],[-0.1659869600904922,-0.3135283627714566],[0.1423341852362959,-0.09242856036513253],[-0.3504038559458069,0.4251730876922147],[-0.24530835421298516,-0.12564038172207645],[0.3100927883896983,-0.21375702677437283],[-0.33734944375238746,-0.18341114407842773],[-0.13597554613082496,-0.38921763975798646],[-0.41465037992537057,-0.11019557113301941],[-0.17530150278207757,-0.2900864561102535],[-0.019258469432806645,0.4312097202826158],[-0.21377850770237683,-0.27895686149498344],[-0.3299272471686155,0.0342622018950014],[-0.09882386089946384,-0.30672922708055106],[0.024186712920379657,-0.1175151682712551],[-0.5129608301069312,0.18297980395442925],[0.016106023572906986,-0.32066888771408336],[0.16845049074824944,-0.03462840414732422],[0.318872995370491,0.11019920207912924],[-0.1579142768595672,-0.40565272940087876],[0.4603063729699345,-0.08563838185744503],[-0.45343900134055887,-0.08305032353687565],[0.2247654114019229,-0.20700555798574138],[0.19194839551763504,-0.2076096811079391],[-0.20340019554887404,-0.3974667059057645],[-0.5416518405584816,-0.1637095058700922],[0.004346020358452414,-0.2581431818027208],[-0.4153887670042014,-0.038985435562599154],[0.1360451491541905,-0.2661213030330846],[-0.22169259556391746,-0.24774242152786113],[0.25948133073129404,-0.1381442699255054],[-0.13664792664404882,0.2556598865675268],[0.05828818153954704,-0.17451308268935184],[-0.20993302408244027,-0.26246166919106184],[0.22751976989205755,0.479281569694078],[0.016616048669617328,0.1541641619465262],[-0.44296520230460523,-0.057791652929531256]];
            matrix_mid = get_mid_matrix(dr_data, dr_bottom);

            
            procrust([dr_data, dr_top, dr_bottom]);
            draw_embedding(left, left_svg, dr_data, "full")
            draw_embedding(right, right_svg, dr_bottom, "bottom")
            //draw_embedding(mid, mid_svg, dr_mid, "full")
            draw_matrix(mid, mid_svg, matrix_mid, ordering);

            prepare_left(dr_data, dr_bottom)
            prepare_mid()
            prepare_right()
        })

        function get_mid_matrix(left, right) {
            let d_left = new druid.Matrix(N, N, (i, j) => druid.euclidean_squared(left[i], left[j]));
            let d_right = new druid.Matrix(N, N, (i, j) => druid.euclidean_squared(right[i], right[j]));
            return new druid.Matrix(N, N, (i, j) => {
                let val = ((d_left.entry(i, j)) - (d_right.entry(i, j)))
                return val
            });
        }

        function get_dr_mid(matrix_data, left, right) {
            let d_left = new druid.Matrix(N, N, (i, j) => druid.euclidean_squared(left[i], left[j]));
            let d_right = new druid.Matrix(N, N, (i, j) => druid.euclidean_squared(right[i], right[j]));
            let d_left_max = -Infinity;
            let d_right_max = -Infinity;
            for (let i = 0; i < N; ++i) {
                for (let j = 0; j < N; ++j) {
                    d_left_max = d_left_max > d_left.entry(i, j) ? d_left_max : d_left.entry(i, j)
                    d_right_max = d_right_max > d_right.entry(i, j) ? d_right_max : d_right.entry(i, j)
                }
            }
            matrix_mid = new druid.Matrix(N, N, (i, j) => {
                let val = Math.abs((d_left.entry(i, j)) - (d_right.entry(i, j)))
                return val//1 / (val + 1e-8)
            });
            //console.log(d3.extent(matrix_mid._data))
            /*let mmdata = matrix_mid._data.sort((a,b) => a - b)
            let b = d3.quantile(mmdata, .3)
            let u = d3.quantile(mmdata, .8)*/
            let mean = d3.mean(matrix_mid._data)
            let extent = d3.extent(matrix_mid._data)
            console.log(extent[0], mean, extent[1]);
            let b = extent[0] + (mean - extent[0]);
            let u = mean + (extent[1] - mean);
            let counter = [0,0,0]
            let vals = [1, 500, 500]
            matrix_mid = new druid.Matrix(N, N, (i, j) => {
                if (matrix_mid.entry(i, j) < b) {
                    counter[0]++
                    return vals[0]
                } else if (matrix_mid.entry(i, j) < u) {
                    counter[1]++
                    return vals[1]
                } else {
                    counter[2]++
                    return vals[2]
                }
            })
            console.log(b, u, counter)
            dr_mid = new druid.TSNE(matrix_data, perp, eps).init(matrix_mid).transform(max_iter_tsne).to2dArray;
            return dr_mid;
        }

        function prepare_left(data1, data2) {
            let matrix = new druid.Matrix()
            matrix.shape = [data1.length, data1.length, (i,j) => {
                return druid.euclidean(data1[i], data1[j]) - druid.euclidean(data2[i], data2[j])
            }]
            
            let m_extent = d3.extent(matrix._data)
            matrix = matrix.to2dArray

            let scale = d3.scaleLinear()
                //.domain([m_extent[0], 0.5 * m_extent[0], 0, 0.5 * m_extent[1], m_extent[1]])
                .domain([m_extent[0], 0, m_extent[1]])
                //.range(["steelblue", "white", "transparent", "white", "salmon"])
                .range(["steelblue", "white", "salmon"])

            let x_scale = d3.scaleLinear()
                .domain(m_extent)
                .range([0, width / dpr])
                
            let left_control = d3.select("#left").append("div")
            
            let select_dist = left_control.append("svg")
                .style("margin", ".25rem")
                .attr("width", width / dpr)
                .attr("height", 50)            

            /*let scale = d3.scaleLinear()
                .domain([-1, 0, 1])
                .range(["steelblue", "white", "salmon"])*/

            select_dist.append("defs").append("linearGradient")
                .attr("id", "gradient")
                .selectAll("stop").data(scale.range())
                    .enter()
                    .append("stop")
                    .attr("offset", (d,i) => {
                        return Math.round(x_scale(scale.domain()[i]) / (width / dpr) * 100) + "%"
                    })
                    .attr("stop-color", d => d3.color(d).toString())

            let select_rect = select_dist.append("rect")
                .attr("y", 30)
                .attr("width", width / dpr)
                .attr("height", 20)
                .attr("fill", "url(#gradient)")
                
            let histogram = d3.histogram()
                .domain(x_scale.domain())
                .thresholds(x_scale.ticks(20))
                (d3.merge(matrix))

            let y_scale = d3.scaleLinear()
                .domain([0, d3.max(histogram, d => d.length)]).nice()
                .range([30, 0])

            let histo_g = select_dist.append("g")

            histo_g
                .selectAll("rect").data(histogram)
                .enter()
                .append("rect")
                    .attr("fill", "#444")
                    .attr("x", d => x_scale(d.x0) + 1)
                    .attr("y", d => y_scale(d.length))
                    .attr("width", d => x_scale(d.x1) - x_scale(d.x0) - 1)
                    .attr("x", d => x_scale(d.x0) + 1)
                    .attr("height", d => y_scale(0) - y_scale(d.length))

            histo_g
                .append("g")
                .call(d3.brushX().on("brush", () => console.log(d3.event.selection)))


            

            
                
            let div_clust = d3.select("#left").append("div")
            const clusters = Array.from(new Set(labels.map(d => d.class)));
            
            let select_clust = div_clust.append("svg")
                .style("margin", ".25rem")
                .attr("width", width / dpr)
                .attr("height",  width / clusters.length / dpr)

            let select_clust_rect = select_clust.selectAll("rect")
                .data(clusters)
                .enter()
                .append("rect")
                .attr("width", width / clusters.length / dpr)
                .attr("height", width / clusters.length / dpr)
                .attr("x", (d, i) => i * (width / clusters.length / dpr))
                .attr("fill", (d, i) => color_scale(i))
                .attr("stroke", "red")
                .attr("stroke-width", 0)

            select_clust.selectAll("text")
                .data(clusters)
                .enter()
                    .append("text")
                        .attr("x", (d, i) => (i + .5) * (width / clusters.length / dpr))
                        .attr("y", width / clusters.length / dpr / 2)
                        .attr("dominant-baseline", "middle")
                        .attr("text-anchor", "middle")
                        .style("fill", "black")
                        .style("pointer-events", "none")
                        .text(d => d)
            
            const click_rect = function(d) {
                this_rect = d3.select(this)
                let enabled = this_rect.attr("stroke-width") !== "0"
                this_rect.attr("stroke-width", enabled ? 0 : 10);
                for (let i = 0; i < N; ++i) {
                    if (labels[i].class == d) {
                        mnist[i].selected = enabled;
                    }
                }
                contexts.forEach(context => context.redraw())
            }

            select_clust_rect.on("click", click_rect)  
            
            let buttons = div_clust.append("div")
                .attr("display", "flex")
            
            
            buttons.append("button")
                .text("select all")
                .on("click", () => {
                    select_clust_rect
                        .attr("stroke-width", 0)
                    for (let i = 0; i < N; ++i) {
                        mnist[i].selected = true;
                    }
                    contexts.forEach(context => context.redraw())
                })

                buttons.append("button")
                    .text("invert selection")
                    .on("click", () => {
                        select_clust_rect
                            .attr("stroke-width", function() { 
                                return d3.select(this).attr("stroke-width") == 0 ? 10 : 0;
                            })
                        for (let i = 0; i < N; ++i) {
                            mnist[i].selected = !mnist[i].selected;
                        }
                        contexts.forEach(context => context.redraw())
                    }) 

                buttons.append("button")
                    .text("select none")
                    .on("click", () => {
                        select_clust_rect
                            .attr("stroke-width", 10)
                        for (let i = 0; i < N; ++i) {
                            mnist[i].selected = false;
                        }
                        contexts.forEach(context => context.redraw())
                    })   

        }
        let re;
        function prepare_mid() {
            let mid_control = d3.select("#mid").append("div")
            re = new druid.Reorder(matrix_mid)
            let button = mid_control
                .selectAll("button")
                    .data(["optimal_leaf_ordering", "spectral_order", "barycenter_order"])
                    .enter()
                    .append("button")
                        .text(d => "sort " + d)
                
            button.on("click", (type) => {
                    let s = Date.now()
                    console.log("start")
                    //button.text("sorting...")
                    window.requestAnimationFrame(() => {
                        
                        ordering = re.reorder(type, druid.euclidean)
                        console.log("end - ", (Date.now() - s) / 1000 + "s", ordering)
                        //draw_matrix(mid, mid_svg, matrix_mid, ordering)
                        mid.redraw();
                    })
                })

            mid_control.append("button")
                .text("sort (label)")
                .on("click", () => {
                    ordering = druid.linspace(0, N -1);
                    //draw_matrix(mid, mid_svg, matrix_mid, ordering)
                    mid.redraw();
                })

            mid_control.append("button")
                .text("remove brush")
                    .on("click", () => {
                        mid_svg.select(".brush")
                            .call(mid_svg.brush.move, null)
                    })

            /*let mid_control = d3.select("#mid").append("div");

            let select_function = mid_control.append("select")
                .attr("name", "functions")

            select_function
                .selectAll("option")
                .data(Object.keys(discrepancies_functions))
                .enter()
                    .append("option")
                    .attr("value", d => d)
                    .text(d => d)

            select_function.on("change", function() {
                let f = this.options[this.selectedIndex].value

                let part_control = d3.select("#right").select("select").node()
                let data = d3.select(part_control.options[part_control.selectedIndex]).datum().data
                let part = part_control.options[part_control.selectedIndex].value

                mid_svg.selectAll("*").remove()
                draw_shepard(mid, mid_svg, dr_data, data, discrepancies_functions[f])
            })*/
        }

        function prepare_right() {
            let right_control = d3.select("#right").append("div");

            let select_part = right_control.append("select")
                .attr("name", "part")

            select_part
                .selectAll("option")
                .data([{"name": "bottom", "data": dr_bottom}, {"name": "top", "data": dr_top}, {"name": "full", "data": dr_data}])
                .enter()
                    .append("option")
                    .attr("value", d => d.name)
                    .text(d => d.name)

            select_part.on("change", function() {
                let data = d3.select(this.options[this.selectedIndex]).datum().data
                let part = this.options[this.selectedIndex].value

                //let f = d3.select("#mid").select("select").node()
                //f = f.options[f.selectedIndex].value

                mid_svg.selectAll("*").remove()
                right_svg.selectAll("*").remove()
                //draw_shepard(mid, mid_svg, dr_data, data, discrepancies_functions[f])


                
                
                
                //dr_mid = get_dr_mid(matrix_data, dr_data, data);
                matrix_mid = get_mid_matrix(dr_data, data);
                ordering = null;


                //draw_embedding(mid, mid_svg, dr_mid, "full")
                draw_embedding(right, right_svg, data, part)
                draw_matrix(mid, mid_svg, matrix_mid);
            })
        }


        function procrust(embeddings) {
            let [source, ...others] = embeddings
             
            // translate + scale
            embeddings.forEach(data => {
                x_mean = d3.mean(data, d => d[0])
                y_mean = d3.mean(data, d => d[1])
                let scale_factor = 0;
                let n = data.length;

                for (let i = 0; i < n; ++i) {
                    //data[i][0] -= x_mean
                    //data[i][1] -= y_mean
                    scale_factor += (data[i][0] * data[i][0] + data[i][1] * data[i][1])
                }

                scale_factor = Math.sqrt(scale_factor / n);

                for (let i = 0; i < n; ++i) {
                    //data[i][0] /= scale_factor;
                    //data[i][1] /= scale_factor;
                    data[i][0] = (data[i][0] - x_mean) / scale_factor
                    data[i][1] = (data[i][1] - y_mean) / scale_factor
                }
            })

            // rotate
            others.forEach(data => {
                let n = data.length;

                let t = 0, b = 0;

                for (let i = 0; i < n; ++i) {
                    t += (source[i][1] * data[i][1] - source[i][0] * data[i][0])
                    b += (source[i][1] * data[i][1] + source[i][0] * data[i][0])
                }

                let phi = Math.atan(t/b);

                let cos_a = Math.cos(phi)
                let sin_a = Math.sin(phi)

                for (let i = 0; i < n; ++i) {
                    data[i] = [
                        data[i][0] * cos_a + data[i][1] * sin_a,
                        data[i][0] * -sin_a + data[i][1] * cos_a
                    ]
                }
            })
        }

        function draw_matrix(context, svg, matrix) {
            if (svg.brush) {
                svg.select(".brush").call(svg.brush, null)
            }
            context.clearRect(0,0,width, height)
            let permute = ordering ? (i => {
                return ordering[i]
                }) : (i => i);
            
            let x = d3.scaleLinear()
                .domain([0, N])
                .range([margin, width / dpr - margin])
                .nice()

            let y = d3.scaleLinear()
                .domain([0, N])
                .range([margin, height / dpr - margin])
                .nice()

            let extent = d3.extent(matrix._data)
            let c = d3.scaleLinear()
                .domain([extent[0], 0, extent[1]])
                .range(["steelblue", d3.select(context.canvas).style("background-color"), "salmon"])

            let w = x(1) - x(0);
            let h = y(1) - y(0);

            brushed = function() {
                if (d3.event.sourceEvent.type === "brush") return;
                let sel = d3.event.selection;
                if (!sel) {
                    data.forEach((d,i) => {
                        d.scanned = d.selected = true
                        mnist[i].selected = d.selected;
                    })
                    return
                }
                sel[0][1] = sel[0][0];
                sel[1][1] = sel[1][0];
                //sel = sel.map(d => [Math.round(x.invert(d[0])), Math.round(y.invert(d[1]))])
                d3.select(this).call(brush.move, sel)
            }
            
            brushed_end = function() {
                if (d3.event.sourceEvent.type === "brush") return;
                let sel = d3.event.selection;
                if (!sel) {
                    contexts.forEach(c => c.redraw());
                    return 
                }
                let [[x1, y1], [x2, y2]] = d3.event.selection;
                sel[0][1] = sel[0][0];
                sel[0][0] = sel[0][1];
                sel = sel.map(d => [Math.round(x.invert(d[0])), Math.round(y.invert(d[1]))])
                data.forEach((d,i) => {
                    const oi = ordering.indexOf(i);
                    d.scanned = d.selected = oi <= sel[1][1] && oi >= sel[0][0];
                    mnist[i].selected = d.selected;
                })
                contexts.forEach(c => c.redraw());
                //d3.select(this).call(brush.move, sel.map(d => [x(d[0]), y(d[1])]))
            }

            brush = d3.brush()
                .extent([[margin, margin], [width / dpr - margin, height / dpr - margin]])
                .on("brush", brushed)
                .on("end", brushed_end)

            svg.append("g")
                .attr("class", "brush")
                .call(brush)


            svg.brush = brush;

            const [n, m] = matrix.shape
            context.redraw = () => {
                if (svg.brush) {
                    svg.select(".brush").call(svg.brush, null)
                }

                context.clearRect(0,0,width, height)
                for (let i = 0; i < n; ++i) {
                    let pi = permute(i);
                    for (let j = 0; j < m; ++j) {
                        let pj = permute(j);
                        let color = d3.hsl(c(matrix.entry(pi, pj)))
                        if (mnist[pi].selected && mnist[pj].selected) {
                            color.s = color.s
                        } else if (mnist[pi].selected || mnist[pj].selected) {
                            color.s = color.s
                        } else {
                            color.s = 0
                            color.opacity = .2
                            //color = "#202020"
                        }
                        context.fillStyle = color;
                        context.fillRect(x(i), y(j), w, h);
                    }
                }

                for (let i = 0; i < n; ++i) {
                    let pi = permute(i);
                    let color = color_scale(labels[pi].class);
                    context.fillStyle = color;
                    context.fillRect(x(i), 0, w, margin / 2)
                    context.fillRect(0, y(i), margin / 2, h)
                }
            }
            context.redraw();
        }

        function draw_embedding(context, svg, data, type) {
            context.clearRect(0, 0, width / dpr, height / dpr)

            let x_extent = d3.extent(data, d => d[0])
            let y_extent = d3.extent(data, d => d[1])

            let x_span = x_extent[1] - x_extent[0]
            let y_span = y_extent[1] - y_extent[0]
            let offset = Math.abs(x_span - y_span) / 2

            if (x_span > y_span) {
                y_extent[0] -= offset
                y_extent[1] += offset
            } else {
                x_extent[0] -= offset
                x_extent[1] += offset
            }

            let x = d3.scaleLinear()
                .domain(x_extent)
                .range([20, width / dpr - 40])

            let y = d3.scaleLinear()
                .domain(y_extent)
                .range([20, height / dpr - 40])

            context.canvas.quadtree = d3.quadtree()
                .x(d => (d[0]))
                .y(d => (d[1]))
                .addAll(data)

            svg.append("g")
                .attr("class", "brush")
                .call(d3.brush().on("brush", function() {
                    data.forEach((d,i) => {
                        d.scanned = d.selected = false
                        //mnist[i].selected = false
                    })
                    let sel = d3.event.selection;
                    sel = sel.map(d => [x.invert(d[0]), y.invert(d[1])])
                    search(context.canvas.quadtree, sel)
                    data.forEach((d,i) => {mnist[i].selected = d.selected})
                    contexts.forEach(context => context.redraw())
                }))
            
            context.redraw = () => {
                context.clearRect(0, 0, width / dpr, height / dpr)

                let x_extent = d3.extent(data, d => d[0])
                let y_extent = d3.extent(data, d => d[1])

                let x_span = x_extent[1] - x_extent[0]
                let y_span = y_extent[1] - y_extent[0]
                let offset = Math.abs(x_span - y_span) / 2

                if (x_span > y_span) {
                    y_extent[0] -= offset
                    y_extent[1] += offset
                } else {
                    x_extent[0] -= offset
                    x_extent[1] += offset
                }

                let x = d3.scaleLinear()
                    .domain(x_extent)
                    .range([20, width / dpr - 40])

                let y = d3.scaleLinear()
                    .domain(y_extent)
                    .range([20, height / dpr - 40])

                context.canvas.quadtree = d3.quadtree()
                    .x(d => (d[0]))
                    .y(d => (d[1]))
                    .addAll(data)


                data.forEach((d,i) => {
                        if (d3.select("#draw_digits").property("checked") === true) {
                            draw_mnist_digit(context, i, mnist[i].selected, x(d[0]) - 14 / dpr, y(d[1]) - 14 / dpr, type)
                        } else {
                            context.beginPath();
                            context.strokeStyle = mnist[i].selected ? color_scale(labels[i].class) : d3.hsl("#444")
                            context.arc(x(d[0]) - 1 / dpr, y(d[1]) - 1 / dpr, 2, 0, 2 * Math.PI);
                            context.stroke();
                        }
                    })
            }
            context.redraw()
        }

        digit_scale = 1 / 1.5

        function draw_mnist_digit(context, digit, colored, x, y, type) {
            context.drawImage(digits[type][digit][colored ? "selected" : "unselected"], x, y)
        }


        function create_mnist_digit(digit, colored, x_from, x_to, y_from, y_to) {
            let canvas = document.createElement("canvas")
            canvas.width = 28 * digit_scale
            canvas.height = 28 * digit_scale
            let context = canvas.getContext("2d")
            mnist[digit].forEach( (pixel, j) => {
                offset_x = (j % 28)
                offset_y = Math.floor(j / 28)
                //let c = d3.interpolateSpectral(digit / mnist.length)
                let c = color_scale(Math.floor(digit/40))
                if (offset_x >= x_from && offset_x <= x_to && offset_y >= y_from && offset_y <= y_to) {
                    c = colored ? d3.hsl(c) : d3.hsl("#444")
                } else {
                    c = colored ? d3.hsl("#222") : d3.hsl("#444") 
                }
                c.s = c.s * pixel / 255;
                c.opacity = pixel / 255;
                c = c.toString()
                context.fillStyle = c.toString()
                context.fillRect(offset_x * digit_scale, offset_y * digit_scale, 1, 1);
            })
            return canvas;
        }
        let discrepancies = null
        let others = null;

        /*function draw_shepard(context, axis_svg, data_y, data_x, discrepancies_function) {
            context.clearRect(0, 0, width / dpr, height / dpr)
            let [a, b] = discrepancies_function(data_y, data_x);
            discrepancies = a;
            others = b;

            axis_g = axis_svg.append("g").attr("class", ".class")
                //.attr("transform", "translate(50,20)")

            let x = d3.scaleLinear()
                //.domain([0, d3.max(discrepancies, d => d[0])])
                .domain(d3.extent(discrepancies, d => d[0]))
                .range([30 * dpr, width / dpr - 20])
                .nice()

            let y = d3.scaleLinear()
                //.domain([0, d3.max(discrepancies, d => d[1])])
                .domain(d3.extent(discrepancies, d => d[1]))
                .range([height / dpr - 50, 30])
                .nice()

            axis_g.append("g")
                .attr("transform", `translate(15, ${(height / dpr - 50) / 2 + 15}) rotate(-90)`)
                .append("text").text("left")
            
            axis_g.append("g")
                .attr("transform", `translate(${(width / dpr - 20) / 2 + 15 * dpr}, ${(height / dpr - 50) + 30})`)
                .append("text").text("right")
            
            axis_g
                .append("g")
                .attr("transform", `translate(0, ${height / dpr - 50})`)
                .call(d3.axisBottom(x))

            axis_g
                .append("g")
                .attr("transform", `translate(${30 * dpr}, 0)`)
                .call(d3.axisLeft(y))

            context.canvas.quadtree = d3.quadtree()
                .x(d => d[0])
                .y(d => d[1])
                .addAll(discrepancies)

            axis_g.append("g")
                .attr("class", "brush")
                .call(d3.brush()
                    .extent([[x.range()[0] - 1, y.range()[1] - 1], [x.range()[1] + 1, y.range()[0] + 1]])
                    .on("brush", function() {
                        discrepancies.forEach((d,i) => {
                            d.scanned = d.selected = false
                            //mnist[i].selected = false
                        })
                        let sel = d3.event.selection;
                        let x0 = x.invert(sel[0][0])
                        let y0 = y.invert(sel[1][1])
                        let x3 = x.invert(sel[1][0])
                        let y3 = y.invert(sel[0][1])
                        search(context.canvas.quadtree, [[x0, y0], [x3, y3]])
                        discrepancies.forEach((d,i) => {
                            mnist[i].selected = d.selected
                        })
                        
                        contexts.forEach(context => context.redraw())
                    })
                )

            context.redraw = () => {
                context.clearRect(0, 0, width / dpr, height / dpr)
            
                /*for (let i = 0, n = others.length; i < n; ++i) {
                    for (let j = 0; j < n; ++j) {
                        context.beginPath()
                        context.arc(x(others[i][j][0]) - 1, y(others[i][j][1]) - 1, 2, 0, 2 * Math.PI);
                        context.strokeStyle = "grey";
                        context.stroke();
                    }
                }
                for (let i = 0, n = discrepancies.length; i < n; ++i) {
                    draw_mnist_digit(context, i, mnist[i].selected, x(discrepancies[i][0]) - 14 / dpr, y(discrepancies[i][1]) - 14 / dpr, "full")
                }
            }
            context.redraw()
        }*/

        // https://bl.ocks.org/mbostock/4343214
        function search(quadtree, [[x0, y0], [x3, y3]]) {
            quadtree.visit(function(node, x1, y1, x2, y2) {
                if (!node.length) {
                    do {
                        var d = node.data;
                        d.scanned = true;
                        d.selected = (d[0] >= x0) && (d[0] < x3) && (d[1] >= y0) && (d[1] < y3);
                    } while (node = node.next)
                }
                return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
            })            
        }
        
    </script>
</body>
</html>